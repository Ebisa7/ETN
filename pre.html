<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tap Game</title>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" xintegrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background: #1b1e2e;
            color: white;
            height: 100vh;
            overflow: hidden;
        }
        
        /* Loading Screen */
        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #0f0f10;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 100;
            transition: opacity 0.5s ease;
        }
        
        .loading-circle {
            width: 60px;
            height: 60px;
            border: 4px solid rgba(255, 255, 255, 0.1);
            border-top-color: #6e45e2;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Main Game Screen */
        .game-screen {
            display: none;
            height: calc(100% - 70px); /* Adjusted for nav bar */
            flex-direction: column;
        }
        
        /* Header */
        .header {
            padding: 15px;
            display: flex;
            justify-content: flex-end;
        }
        
        .profile {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .profile-pic {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #2a2a2b;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
        }
        
        .profile-pic img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .profile-name {
            font-weight: bold;
            font-size: 14px;
        }
        
        /* Balance */
        .balance-container {
            text-align: center;
            margin-top: 20px;
        }
        
        .balance-label {
            font-size: 14px;
            color: #aaa;
            margin-bottom: 5px;
        }
        
        .balance-amount {
            font-size: 36px;
            font-weight: bold;
            background: linear-gradient(to right, #6e45e2, #88d3ce);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        /* Tap Circle */
        .tap-area {
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
        }
        
        .tap-circle {
            width: 280px;
            height: 280px;
            border-radius: 50%;
            background: linear-gradient(135deg, #2a2a2b, #1a1a1b);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
            cursor: pointer;
            transition: transform 0.1s ease;
        }
        
        .tap-circle:active {
            transform: scale(0.95);
        }
        
        .tap-circle-inner {
            width: 240px;
            height: 240px;
            border-radius: 50%;
            background: linear-gradient(135deg, #3a3a3c, #2a2a2b);
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 24px;
            font-weight: bold;
            color: white;
        }
        
        .coin-effect {
            position: absolute;
            font-size: 24px;
            font-weight: bold;
            color: #FFD700;
            opacity: 0;
            pointer-events: none;
            animation: float-up 1s ease-out forwards;
        }
        
        @keyframes float-up {
            0% {
                transform: translateY(0) scale(0.8);
                opacity: 1;
            }
            100% {
                transform: translateY(-100px) scale(1.2);
                opacity: 0;
            }
        }
        
        /* Page Styles */
        .page {
             display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: calc(100% - 70px); /* Adjusted for nav bar height */
            background: #0f0f10;
            padding: 20px;
            overflow-y: auto;
            z-index: 5;
        }

        .page-header {
            text-align: center;
            margin-bottom: 20px;
        }

        .page-header h2 {
            font-size: 24px;
            margin-bottom: 8px;
        }

        .page-header p {
            color: #aaa;
            font-size: 14px;
        }
        
        .invite-link-container {
            display: flex;
            margin: 20px 0;
            background: #1a1a1b;
            border-radius: 12px;
            overflow: hidden;
        }

        .invite-link {
            flex: 1;
            padding: 15px;
            font-size: 14px;
            word-break: break-all;
            color: #88d3ce;
        }

        .copy-btn {
            background: #6e45e2;
            color: white;
            border: none;
            padding: 0 20px;
            font-weight: bold;
            cursor: pointer;
            transition: background 0.2s ease;
        }

        .copy-btn:active {
            background: #5a35c0;
        }

        .share-buttons {
            display: flex;
            justify-content: center;
            margin-bottom: 20px;
        }

        .share-btn {
            background: #0088cc;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 12px;
            font-size: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .share-btn:active {
            background: #006699;
        }
        
        .list-container {
            background: #1a1a1b;
            border-radius: 12px;
            padding: 15px;
        }

        .list-container h3 {
            margin-bottom: 15px;
            font-size: 18px;
        }
        
        .list-scrollable {
            max-height: 40vh;
            overflow-y: auto;
        }

        .user-card, .leaderboard-card {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid #2a2a2b;
        }

        .user-card:last-child, .leaderboard-card:last-child {
            border-bottom: none;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 12px;
            flex-grow: 1;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #2a2a2b;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
            flex-shrink: 0;
        }

        .user-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .user-name {
            font-weight: bold;
            font-size: 14px;
        }

        .user-balance {
            color: #88d3ce;
            font-weight: bold;
            flex-shrink: 0;
        }

        .empty-state {
            color: #666;
            text-align: center;
            padding: 20px 0;
        }
        
        /* Leaderboard Styles */
        .leaderboard-card .rank {
            font-size: 18px;
            font-weight: bold;
            width: 40px;
            text-align: center;
            color: #aaa;
            flex-shrink: 0;
        }
        
        .rank-1, .rank-2, .rank-3 {
            font-size: 24px;
        }
        .rank-1 { color: #FFD700; } /* Gold */
        .rank-2 { color: #C0C0C0; } /* Silver */
        .rank-3 { color: #CD7F32; } /* Bronze */
        
        /* Bottom Navigation */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background: #1a1a1b;
            display: flex;
            padding-top: 10px;
            padding-bottom: 10px;
            border-top: 1px solid #2a2a2b;
            z-index: 10;
        }

        .nav-item {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: #888;
            cursor: pointer;
            transition: color 0.2s ease;
        }

        .nav-item.active {
            color: #6e45e2;
        }

        .nav-icon {
            font-size: 24px;
            margin-bottom: 4px;
        }

        .nav-label {
            font-size: 12px;
        }
        
        /* Games Tab Styles */
        .games-container {
            display: flex;
            flex-direction: column;
            gap: 20px;
            padding: 0 10px;
        }
        
        .game-card {
            background: #1a1a1b;
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 6px 16px rgba(0,0,0,0.3);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            cursor: pointer;
        }
        
        .game-card:active {
            transform: scale(0.98);
        }
        
        .game-card-header {
            padding: 20px;
            display: flex;
            align-items: center;
            gap: 15px;
            background: linear-gradient(90deg, #6e45e2, #88d3ce);
        }
        
        .game-icon {
            font-size: 28px;
            background: rgba(255,255,255,0.2);
            width: 50px;
            height: 50px;
            border-radius: 12px;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .game-title {
            font-size: 18px;
            font-weight: bold;
        }
        
        .game-subtitle {
            font-size: 14px;
            opacity: 0.9;
        }
        
        .game-card-body {
            padding: 20px;
        }
        
        .game-info {
            display: flex;
            justify-content: space-between;
            margin-bottom: 15px;
            font-size: 14px;
        }
        
        .game-info-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .game-info-item i {
            color: #6e45e2;
        }
        
        .prize-badge {
            background: linear-gradient(90deg, #ffd700, #ff9800);
            color: #000;
            padding: 5px 12px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 14px;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }
        
        /* Tic Tac Toe Game Styles */
        .tic-tac-toe-container {
            display: flex;
            flex-direction: column;
            height: 100%;
        }
        
        .game-header {
            padding: 20px;
            text-align: center;
            border-bottom: 1px solid #2a2a2b;
        }
        
        .game-header h2 {
            font-size: 24px;
            margin-bottom: 5px;
        }
        
        .game-status {
            font-size: 16px;
            color: #88d3ce;
        }
        
        .opponent-info {
            display: flex;
            justify-content: space-around;
            align-items: center;
            padding: 15px;
            margin: 10px 0;
            background: #1a1a1b;
            border-radius: 12px;
        }
        
        .player-card {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
        }
        
        .player-avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: #2a2a2b;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
            position: relative;
        }
        
        .player-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .player-mark {
            position: absolute;
            bottom: -5px;
            right: -5px;
            background: #6e45e2;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-weight: bold;
            font-size: 18px;
            border: 2px solid #1a1a1b;
        }
        
        .player-name {
            font-weight: bold;
            max-width: 100px;
            text-overflow: ellipsis;
            overflow: hidden;
            white-space: nowrap;
        }
        
        .vs {
            font-size: 20px;
            font-weight: bold;
            color: #888;
        }
        
        .board-container {
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        
        .game-board {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            grid-gap: 10px;
            width: 300px;
            height: 300px;
            background: #2a2a2b;
            border-radius: 12px;
            padding: 10px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        
        .cell {
            background: #1a1a1b;
            border-radius: 8px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 48px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .cell:hover {
            background: #252528;
        }
        
        .cell.x {
            color: #6e45e2;
        }
        
        .cell.o {
            color: #88d3ce;
        }
        
        .cell.win {
            animation: win-cell 1s ease infinite;
        }
        
        @keyframes win-cell {
            0%, 100% { background: rgba(110, 69, 226, 0.1); }
            50% { background: rgba(110, 69, 226, 0.3); }
        }
        
        .game-controls {
            padding: 20px;
            display: flex;
            justify-content: center;
            gap: 15px;
        }
        
        .game-btn {
            background: #6e45e2;
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 12px;
            font-size: 16px;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .game-btn:active {
            background: #5a35c0;
        }
        
        .game-btn.exit {
            background: #2a2a2b;
        }
        
        /* P2P Lobby */
        .lobby-container {
            padding: 20px;
            text-align: center;
        }
        
        .lobby-status {
            background: #1a1a1b;
            padding: 30px 20px;
            border-radius: 16px;
            margin: 20px 0;
            font-size: 18px;
        }
        
        .player-count {
            font-size: 48px;
            font-weight: bold;
            color: #6e45e2;
            margin: 10px 0;
        }
        
        .player-count-label {
            font-size: 14px;
            color: #aaa;
        }
        
        .searching-indicator, .waiting-indicator {
            display: flex;
            justify-content: center;
            gap: 5px;
            margin: 20px 0;
        }
        
        .dot {
            width: 10px;
            height: 10px;
            background: #6e45e2;
            border-radius: 50%;
            animation: pulse 1.5s infinite;
        }
        
        .dot:nth-child(2) {
            animation-delay: 0.3s;
        }
        
        .dot:nth-child(3) {
            animation-delay: 0.6s;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 0.3; transform: scale(0.8); }
            50% { opacity: 1; transform: scale(1); }
        }
        
        /* Game Result Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 20;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }
        
        .modal-overlay.show {
            display: flex;
            opacity: 1;
            pointer-events: all;
        }
        
        .modal-content {
            background: #1a1a1b;
            border-radius: 20px;
            width: 90%;
            max-width: 400px;
            padding: 30px;
            text-align: center;
            transform: translateY(20px);
            transition: transform 0.3s ease;
        }
        
        .modal-overlay.show .modal-content {
            transform: translateY(0);
        }
        
        .modal-icon {
            font-size: 60px;
            margin-bottom: 20px;
        }
        
        .modal-icon.win {
            color: #FFD700;
        }
        
        .modal-icon.draw {
            color: #88d3ce;
        }
        
        .modal-title {
            font-size: 28px;
            margin-bottom: 10px;
        }
        
        .modal-message {
            font-size: 18px;
            margin-bottom: 20px;
            color: #aaa;
        }
        
        .prize-amount {
            font-size: 24px;
            font-weight: bold;
            color: #FFD700;
            margin: 20px 0;
        }
        
        .modal-btn {
            background: #6e45e2;
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 12px;
            font-size: 18px;
            font-weight: bold;
            width: 100%;
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .modal-btn:active {
            background: #5a35c0;
        }
    </style>
</head>
<body>
    <!-- Loading Screen -->
    <div class="loading-screen" id="loadingScreen">
        <div class="loading-circle"></div>
        <p>Loading...</p>
    </div>
    
    <!-- Main Game Screen -->
    <div class="game-screen" id="gameScreen">
        <div class="header">
            <div class="profile" id="profile">
                <div class="profile-pic" id="profilePic"><span>?</span></div>
                <div class="profile-name" id="profileName"></div>
            </div>
        </div>
        <div class="balance-container">
            <div class="balance-label">Your Balance</div>
            <div class="balance-amount" id="balance">0</div>
        </div>
        <div class="tap-area">
            <div class="tap-circle" id="tapCircle">
                <div class="tap-circle-inner">TAP</div>
            </div>
        </div>
    </div>

    <!-- Invite Screen -->
    <div class="page" id="inviteScreen">
        <div class="page-header">
            <h2>Invite Friends</h2>
            <p>Earn bonuses when your friends join and play</p>
        </div>
        <div class="invite-link-container">
            <div class="invite-link" id="inviteLink">Loading...</div>
            <button class="copy-btn" id="copyBtn">Copy</button>
        </div>
        <div class="share-buttons">
            <button class="share-btn" id="shareTelegramBtn">
                <i class="fab fa-telegram-plane"></i> Share via Telegram
            </button>
        </div>
        <div class="list-container">
            <h3>Your Team</h3>
            <div class="list-scrollable" id="usersList">
                <div class="empty-state">No invited users yet</div>
            </div>
        </div>
    </div>
    
    <!-- Leaderboard Screen -->
    <div class="page" id="leaderboardScreen">
        <div class="page-header">
            <h2>üèÜ Leaderboard üèÜ</h2>
        </div>
        <div class="list-container">
             <div class="list-scrollable" id="leaderboardList">
                <div class="empty-state">Loading...</div>
             </div>
        </div>
    </div>
    
    <!-- Games Screen -->
    <div class="page" id="gamesScreen">
        <div class="page-header">
            <h2>üéÆ Mini Games üéÆ</h2>
            <p>Play games to earn extra coins!</p>
        </div>
        <div class="games-container">
            <div class="game-card" id="robotGameCard">
                <div class="game-card-header">
                    <div class="game-icon"><i class="fas fa-robot"></i></div>
                    <div>
                        <div class="game-title">Tic Tac Toe vs Robot</div>
                        <div class="game-subtitle">Test your skills against our AI</div>
                    </div>
                </div>
            </div>
            
            <div class="game-card" id="pvpGameCard">
                <div class="game-card-header">
                    <div class="game-icon"><i class="fas fa-users"></i></div>
                    <div>
                        <div class="game-title">Find Random Opponent</div>
                        <div class="game-subtitle">Challenge real opponents</div>
                    </div>
                </div>
            </div>
            
            <div class="game-card" id="friendGameCard">
                <div class="game-card-header">
                    <div class="game-icon"><i class="fas fa-user-friends"></i></div>
                    <div>
                        <div class="game-title">Play with a Friend</div>
                        <div class="game-subtitle">Share a link to start a match</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Friend Game Waiting Screen -->
    <div class="page" id="friendWaitScreen">
        <div class="page-header">
            <h2>Waiting for Friend</h2>
            <p>Share this link with a friend to start the game.</p>
        </div>
        <div class="lobby-container">
             <div class="lobby-status">
                 <i class="fas fa-share-alt" style="font-size: 36px; margin-bottom: 15px;"></i>
                 <p>Share this link to play:</p>
                 <div class="invite-link-container">
                     <div class="invite-link" id="friendGameLink">Generating...</div>
                     <button class="copy-btn" id="copyFriendLinkBtn">Copy</button>
                 </div>
                 <div class="waiting-indicator">
                    <div class="dot"></div>
                    <div class="dot"></div>
                    <div class="dot"></div>
                </div>
             </div>
             <button class="game-btn exit" id="cancelFriendGameBtn">
                <i class="fas fa-times"></i> Cancel
             </button>
        </div>
    </div>
    
    <!-- Robot Game Screen -->
    <div class="page" id="robotGameScreen">
        <div class="game-header">
            <h2>Tic Tac Toe vs Robot</h2>
            <div class="game-status" id="robotGameStatus">Your turn! You are playing as X</div>
        </div>
        <div class="opponent-info">
            <div class="player-card">
                <div class="player-avatar" id="playerAvatarRobot"><span>?</span><div class="player-mark">X</div></div>
                <div class="player-name" id="playerNameRobot">You</div>
            </div>
            <div class="vs">VS</div>
            <div class="player-card">
                <div class="player-avatar"><i class="fas fa-robot" style="font-size: 30px;"></i><div class="player-mark">O</div></div>
                <div class="player-name">Robot</div>
            </div>
        </div>
        <div class="board-container">
            <div class="game-board" id="robotBoard">
                <div class="cell" data-index="0"></div><div class="cell" data-index="1"></div><div class="cell" data-index="2"></div>
                <div class="cell" data-index="3"></div><div class="cell" data-index="4"></div><div class="cell" data-index="5"></div>
                <div class="cell" data-index="6"></div><div class="cell" data-index="7"></div><div class="cell" data-index="8"></div>
            </div>
        </div>
        <div class="game-controls">
            <button class="game-btn exit" id="exitRobotGame"><i class="fas fa-arrow-left"></i> Exit</button>
            <button class="game-btn" id="restartRobotGame"><i class="fas fa-redo"></i> Restart</button>
        </div>
    </div>
    
    <!-- P2P Game Screen (used for both random and friend games) -->
    <div class="page" id="pvpGameScreen">
        <div id="pvpLobby">
            <div class="game-header"><h2>Searching for Opponent</h2></div>
            <div class="lobby-container">
                <div class="lobby-status">
                    <i class="fas fa-search" style="font-size: 36px; margin-bottom: 15px;"></i>
                    <div>Looking for an opponent</div>
                    <div class="player-count" id="onlinePlayers">1</div>
                    <div class="player-count-label">players online</div>
                    <div class="searching-indicator"><div class="dot"></div><div class="dot"></div><div class="dot"></div></div>
                    <p style="margin-top: 20px; color: #888;">Finding a worthy opponent for you...</p>
                </div>
                 <button class="game-btn exit" id="cancelMatchmakingBtn"><i class="fas fa-times"></i> Cancel</button>
            </div>
        </div>
        
        <div id="pvpGame" style="display: none;">
            <div class="game-header">
                <h2>Tic Tac Toe</h2>
                <div class="game-status" id="pvpGameStatus">Waiting for opponent...</div>
            </div>
            <div class="opponent-info">
                <div class="player-card">
                    <div class="player-avatar" id="player1Avatar"><span>?</span><div class="player-mark" id="player1Mark">?</div></div>
                    <div class="player-name" id="player1Name">You</div>
                </div>
                <div class="vs">VS</div>
                <div class="player-card">
                    <div class="player-avatar" id="player2Avatar"><i class="fas fa-user-clock" style="font-size: 24px;"></i><div class="player-mark" id="player2Mark">?</div></div>
                    <div class="player-name" id="player2Name">Waiting...</div>
                </div>
            </div>
            <div class="board-container">
                <div class="game-board" id="pvpBoard">
                    <div class="cell" data-index="0"></div><div class="cell" data-index="1"></div><div class="cell" data-index="2"></div>
                    <div class="cell" data-index="3"></div><div class="cell" data-index="4"></div><div class="cell" data-index="5"></div>
                    <div class="cell" data-index="6"></div><div class="cell" data-index="7"></div><div class="cell" data-index="8"></div>
                </div>
            </div>
            <div class="game-controls">
                <button class="game-btn exit" id="exitPvpGame"><i class="fas fa-flag"></i> Forfeit</button>
            </div>
        </div>
    </div>
    
    <!-- Game Result Modal -->
    <div class="modal-overlay" id="gameResultModal">
        <div class="modal-content">
            <div class="modal-icon win" id="resultIcon"><i class="fas fa-trophy"></i></div>
            <h2 class="modal-title" id="resultTitle">Victory!</h2>
            <p class="modal-message" id="resultMessage">You won!</p>
            <div class="prize-amount" id="prizeAmount">+100 coins</div>
            <button class="modal-btn" id="modalBtn">Continue</button>
        </div>
    </div>

    <!-- Bottom Navigation -->
    <div class="bottom-nav">
        <div class="nav-item active" id="navGame"><div class="nav-icon"><i class="fas fa-gamepad"></i></div><div class="nav-label">Game</div></div>
        <div class="nav-item" id="navInvite"><div class="nav-icon"><i class="fas fa-user-plus"></i></div><div class="nav-label">Invite</div></div>
        <div class="nav-item" id="navLeaderboard"><div class="nav-icon"><i class="fas fa-trophy"></i></div><div class="nav-label">Leaders</div></div>
        <div class="nav-item" id="navGames"><div class="nav-icon"><i class="fas fa-dice"></i></div><div class="nav-label">Games</div></div>
    </div>

    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBX3g8wWxcTtwFDsJNJVcjUDIGxMd1L0Rk",
            authDomain: "mytestapp-f6913.firebaseapp.com",
            databaseURL: "https://mytestapp-f6913-default-rtdb.firebaseio.com",
            projectId: "mytestapp-f6913",
            storageBucket: "mytestapp-f6913.appspot.com",
            messagingSenderId: "300150696072",
            appId: "1:300150696072:web:1e29cb5a813d004018573d",
            measurementId: "G-PPDR4TBQF5"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // DOM elements
        const loadingScreen = document.getElementById('loadingScreen');
        const gameScreen = document.getElementById('gameScreen');
        const profilePic = document.getElementById('profilePic');
        const profileName = document.getElementById('profileName');
        const balanceDisplay = document.getElementById('balance');
        const tapCircle = document.getElementById('tapCircle');
        
        const navItems = {
            game: document.getElementById('navGame'), invite: document.getElementById('navInvite'),
            leaderboard: document.getElementById('navLeaderboard'), games: document.getElementById('navGames')
        };
        const pages = {
            game: gameScreen, invite: document.getElementById('inviteScreen'),
            leaderboard: document.getElementById('leaderboardScreen'), games: document.getElementById('gamesScreen'),
            robotGame: document.getElementById('robotGameScreen'), pvpGame: document.getElementById('pvpGameScreen'),
            friendWait: document.getElementById('friendWaitScreen')
        };

        const inviteLink = document.getElementById('inviteLink');
        const copyBtn = document.getElementById('copyBtn');
        const usersList = document.getElementById('usersList');
        const shareTelegramBtn = document.getElementById('shareTelegramBtn');
        const leaderboardList = document.getElementById('leaderboardList');
        const onlinePlayersDisplay = document.getElementById('onlinePlayers');

        let balance = 0, firebaseUser = null, userDocRef = null, userData = {}, coinsPerTap = 1, invitedBy = null;
        const botUsername = 'guvuhgy7bot/kuyti';

        function padTelegramId(id) { return String(id).padStart(6, '0'); }
        
        async function sendTelegramMessage(chatId, text) { /* ... same as before ... */ }

        function createCoinEffect(x, y) {
            const coin = document.createElement('div');
            coin.className = 'coin-effect';
            coin.textContent = `+${coinsPerTap}`;
            coin.style.left = `${x - 15}px`;
            coin.style.top = `${y - 15}px`;
            document.body.appendChild(coin);
            setTimeout(() => coin.remove(), 1000);
        }

        function handleTap(e) {
            e.preventDefault();
            const clientX = e.clientX || e.touches[0].clientX;
            const clientY = e.clientY || e.touches[0].clientY;
            createCoinEffect(clientX, clientY);
            balance += coinsPerTap;
            balanceDisplay.textContent = balance.toLocaleString();
            if (window.Telegram?.WebApp?.HapticFeedback) Telegram.WebApp.HapticFeedback.impactOccurred('light');
            if (userDocRef) userDocRef.update({ balance: firebase.firestore.FieldValue.increment(coinsPerTap) });
        }

        function setupInviteLink(userId) { /* ... same as before ... */ }
        async function loadLeaderboard() { /* ... same as before ... */ }
        async function loadInvitedUsers() { /* ... same as before ... */ }
        
        let gameListenerUnsubscribe = null;
        let activeGameId = null;
        
        function switchTab(tabName) {
            Object.values(pages).forEach(page => page.style.display = 'none');
            Object.values(navItems).forEach(item => item.classList.remove('active'));
            
            if (pages[tabName]) {
                const displayStyle = (tabName === 'game') ? 'flex' : 'block';
                pages[tabName].style.display = displayStyle;
            }
            
            if (navItems[tabName]) navItems[tabName].classList.add('active');
            else if (['robotGame', 'pvpGame', 'friendWait'].includes(tabName)) navItems.games.classList.add('active');

            if (tabName === 'invite') loadInvitedUsers();
            if (tabName === 'leaderboard') loadLeaderboard();
        }

        // --- Tic Tac Toe Game Logic ---
        function initTicTacToe() {
            // Game mode cards
            const robotGameCard = document.getElementById('robotGameCard');
            const pvpGameCard = document.getElementById('pvpGameCard');
            const friendGameCard = document.getElementById('friendGameCard');

            // Wait screen for friend game
            const friendWaitScreen = document.getElementById('friendWaitScreen');
            const friendGameLink = document.getElementById('friendGameLink');
            const copyFriendLinkBtn = document.getElementById('copyFriendLinkBtn');
            const cancelFriendGameBtn = document.getElementById('cancelFriendGameBtn');

            // Robot Game Elements
            const robotBoard = document.getElementById('robotBoard');
            const robotGameStatus = document.getElementById('robotGameStatus');
            const restartRobotGameBtn = document.getElementById('restartRobotGame');
            const exitRobotGameBtn = document.getElementById('exitRobotGame');

            // PvP Game Elements (reused for all PvP)
            const pvpGameScreen = document.getElementById('pvpGameScreen');
            const pvpLobby = document.getElementById('pvpLobby');
            const pvpGame = document.getElementById('pvpGame');
            const pvpGameStatus = document.getElementById('pvpGameStatus');
            const pvpBoard = document.getElementById('pvpBoard');
            const exitPvpGameBtn = document.getElementById('exitPvpGame');
            const cancelMatchmakingBtn = document.getElementById('cancelMatchmakingBtn');
            const player1Avatar = document.getElementById('player1Avatar'), player2Avatar = document.getElementById('player2Avatar');
            const player1Name = document.getElementById('player1Name'), player2Name = document.getElementById('player2Name');
            const player1Mark = document.getElementById('player1Mark'), player2Mark = document.getElementById('player2Mark');

            // Result Modal
            const gameResultModal = document.getElementById('gameResultModal');
            const resultIcon = document.getElementById('resultIcon'), resultTitle = document.getElementById('resultTitle');
            const resultMessage = document.getElementById('resultMessage'), prizeAmount = document.getElementById('prizeAmount');
            const modalBtn = document.getElementById('modalBtn');
            
            let currentGameState = { active: false, board: Array(9).fill(''), player: 'X' };
            const winningCombinations = [ [0,1,2], [3,4,5], [6,7,8], [0,3,6], [1,4,7], [2,5,8], [0,4,8], [2,4,6] ];
            let activeGameMode = null;

            function checkWin(board, mark) { /* ... same as before ... */ return { hasWinner: false }; }
            function showGameResultModal(result, mode = 'robot', prize=0) { /* ... same as before ... */ }
            
            // --- Generic PvP Game Cleanup ---
            async function cleanUpPvpGame() {
                if (gameListenerUnsubscribe) {
                    gameListenerUnsubscribe();
                    gameListenerUnsubscribe = null;
                }
                if (activeGameId) {
                    const gameRef = db.collection(activeGameMode === 'friend' ? 'direct_games' : 'games').doc(activeGameId);
                    const gameDoc = await gameRef.get();
                    if (gameDoc.exists) {
                        const gameData = gameDoc.data();
                        if (gameData.gameActive && !gameData.winnerId) {
                            const opponentId = gameData.player1Id === firebaseUser.uid ? gameData.player2Id : gameData.player1Id;
                            await gameRef.update({ winnerId: opponentId, gameActive: false });
                        }
                    }
                }
                activeGameId = null;
                switchTab('games');
            }
            
            // --- Friend Game Logic ---
            async function createFriendGame() {
                activeGameMode = 'friend';
                const gameRef = await db.collection('direct_games').add({
                    player1Id: firebaseUser.uid,
                    player1Data: userData,
                    status: 'waiting',
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                activeGameId = gameRef.id;
                
                const link = `https://t.me/${botUsername}?startapp=game_${activeGameId}`;
                friendGameLink.textContent = link;
                copyFriendLinkBtn.onclick = () => {
                    navigator.clipboard.writeText(link).then(() => {
                        copyFriendLinkBtn.textContent = 'Copied!';
                        setTimeout(() => { copyFriendLinkBtn.textContent = 'Copy'; }, 2000);
                    });
                };

                switchTab('friendWait');
                listenForGameUpdates(activeGameId, 'direct_games');
            }
            
            cancelFriendGameBtn.onclick = async () => {
                if(gameListenerUnsubscribe) gameListenerUnsubscribe();
                if(activeGameId) await db.collection('direct_games').doc(activeGameId).delete();
                activeGameId = null;
                switchTab('games');
            };

            // --- Real-time Game Listener (for PvP and Friend games) ---
            function listenForGameUpdates(gameId, collectionName) {
                activeGameId = gameId;
                if (gameListenerUnsubscribe) gameListenerUnsubscribe();
                
                gameListenerUnsubscribe = db.collection(collectionName).doc(gameId).onSnapshot(doc => {
                    if (!doc.exists) {
                        cleanUpPvpGame();
                        return;
                    }
                    const gameData = doc.data();

                    // Transition from waiting to active game
                    if (gameData.status === 'active') {
                        pvpLobby.style.display = 'none';
                        pvpGame.style.display = 'block';
                        friendWaitScreen.style.display = 'none';
                        if (pages.pvpGame.style.display !== 'block') {
                            switchTab('pvpGame');
                        }
                        updatePvpUI(gameData);
                    }
                });
            }
            
            function updatePvpUI(gameData) { /* ... similar logic to before, updating player info, board, and game status ... */ }
            
            // --- Init Robot Game ---
            function initRobotGame() { /* ... same logic as before ... */ }

            // Event listeners for game cards
            robotGameCard.addEventListener('click', initRobotGame);
            pvpGameCard.addEventListener('click', () => alert("Random matchmaking coming soon!")); // Placeholder
            friendGameCard.addEventListener('click', createFriendGame);

            exitRobotGameBtn.addEventListener('click', () => switchTab('games'));
            exitPvpGameBtn.addEventListener('click', cleanUpPvpGame);
            modalBtn.addEventListener('click', () => gameResultModal.classList.remove('show'));

            // Public method to join a game via link
            async function joinFriendGame(gameId) {
                const gameRef = db.collection('direct_games').doc(gameId);
                const gameDoc = await gameRef.get();

                if (!gameDoc.exists || gameDoc.data().status !== 'waiting') {
                    alert('This game is no longer available.');
                    switchTab('game');
                    return;
                }
                
                activeGameMode = 'friend';
                
                const players = {};
                const player1Id = gameDoc.data().player1Id;
                players[player1Id] = { mark: 'X' };
                players[firebaseUser.uid] = { mark: 'O' };
                
                await gameRef.update({
                    player2Id: firebaseUser.uid,
                    player2Data: userData,
                    status: 'active',
                    gameActive: true,
                    currentPlayerId: Math.random() < 0.5 ? player1Id : firebaseUser.uid,
                    players: players,
                    board: Array(9).fill('')
                });
                
                listenForGameUpdates(gameId, 'direct_games');
            }

            return { joinFriendGame };
        }
        
        // --- Main Initialization ---
        async function initGame() {
            try {
                if (!window.Telegram?.WebApp?.initDataUnsafe) throw new Error('Please open in Telegram');
                
                Telegram.WebApp.ready();
                Telegram.WebApp.expand();
                
                const tgUser = Telegram.WebApp.initDataUnsafe.user;
                if (!tgUser?.id) throw new Error('Telegram user data is not available.');

                const email = `${tgUser.id}@telegram.user`;
                const password = padTelegramId(tgUser.id);
                
                try {
                    firebaseUser = (await auth.signInWithEmailAndPassword(email, password)).user;
                } catch (error) {
                    if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password') {
                       firebaseUser = (await auth.createUserWithEmailAndPassword(email, password)).user;
                    } else throw error;
                }

                userDocRef = db.collection('users').doc(firebaseUser.uid);
                const userDoc = await userDocRef.get();

                if (!userDoc.exists) {
                    // ... New user creation logic ...
                } else {
                    userData = userDoc.data();
                    balance = userData.balance || 0;
                }
                
                // UI Setup
                profileName.textContent = tgUser.first_name || 'Player';
                balanceDisplay.textContent = balance.toLocaleString();
                if (tgUser.photo_url) profilePic.innerHTML = `<img src="${tgUser.photo_url}" alt="P">`;

                const ticTacToe = initTicTacToe();

                // Handle startup parameters (for joining games)
                const startParam = Telegram.WebApp.initDataUnsafe.start_param;
                if (startParam && startParam.startsWith('game_')) {
                    const gameId = startParam.replace('game_', '');
                    await ticTacToe.joinFriendGame(gameId);
                } else {
                    switchTab('game'); // Default start page
                }
                
                // Finalize loading
                loadingScreen.style.opacity = '0';
                setTimeout(() => loadingScreen.style.display = 'none', 500);

                // Event Listeners
                navItems.game.addEventListener('click', () => switchTab('game'));
                navItems.invite.addEventListener('click', () => switchTab('invite'));
                navItems.leaderboard.addEventListener('click', () => switchTab('leaderboard'));
                navItems.games.addEventListener('click', () => switchTab('games'));
                tapCircle.addEventListener('click', handleTap);
                tapCircle.addEventListener('touchstart', handleTap, { passive: true });
                
            } catch (error) {
                console.error('Initialization error:', error);
                loadingScreen.innerHTML = `<p style="color:red; padding: 20px;">Error: ${error.message}.</p>`;
            }
        }

        document.addEventListener('DOMContentLoaded', initGame);
    </script>
</body>
</html>
