<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Tap Game</title>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" xintegrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <style>
        :root {
            --primary-color: #6e45e2;
            --background-dark: #0f0f10;
            --background-med: #1a1a1b;
            --background-light: #1b1e2e;
            --text-primary: #ffffff;
            --text-secondary: #aaa;
            --accent-color: #88d3ce;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background: var(--background-light);
            color: var(--text-primary);
            height: 100vh;
            overflow: hidden;
        }
        
        /* General Page & Navigation Styles */
        .page {
            display: none;
            position: fixed; top: 0; left: 0;
            width: 100%; height: calc(100% - 70px);
            background: var(--background-dark);
            padding: 20px;
            overflow-y: auto;
            z-index: 5;
            flex-direction: column;
        }
        .page.active { display: flex; }
        .game-screen { display: flex; } /* Initial state for the main game */

        .bottom-nav {
            position: fixed; bottom: 0; left: 0;
            width: 100%;
            background: var(--background-med);
            display: flex;
            padding: 10px 0;
            border-top: 1px solid #2a2a2b;
            z-index: 10;
        }
        .nav-item { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; color: #888; cursor: pointer; transition: color 0.2s ease; }
        .nav-item.active { color: var(--primary-color); }
        .nav-icon { font-size: 24px; margin-bottom: 4px; }
        .nav-label { font-size: 12px; }

        /* Loading & Utility */
        .loading-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--background-dark); display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 100; transition: opacity 0.5s ease; }
        .loading-circle { width: 60px; height: 60px; border: 4px solid rgba(255, 255, 255, 0.1); border-top-color: var(--primary-color); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* Game Selection Screen */
        .games-page .page-header { margin-bottom: 40px; }
        .game-card {
            background: var(--background-med);
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .game-card:active { transform: scale(0.97); box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
        .game-card-icon { font-size: 40px; }
        .game-card-icon.robot { color: var(--accent-color); }
        .game-card-icon.p2p { color: var(--primary-color); }
        .game-card-info h3 { font-size: 20px; margin-bottom: 5px; }
        .game-card-info p { color: var(--text-secondary); font-size: 14px; }
        .game-card .arrow-icon { font-size: 24px; color: #444; }

        /* Tic-Tac-Toe Game Page */
        .tictactoe-page { display: none; } /* Hide by default */
        .ttt-board {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            grid-gap: 10px;
            width: 90vw;
            max-width: 300px;
            margin: auto;
            aspect-ratio: 1 / 1;
        }
        .ttt-cell {
            background: var(--background-med);
            border-radius: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 40px;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }
        .ttt-cell.x { color: var(--accent-color); }
        .ttt-cell.o { color: var(--primary-color); }
        .ttt-cell.win { background-color: #ffd700; color: black; }
        
        .ttt-status { text-align: center; margin-top: 20px; font-size: 18px; height: 30px; }
        .ttt-controls { text-align: center; margin-top: 20px; }
        .ttt-btn { background: var(--primary-color); color: white; border: none; padding: 12px 25px; border-radius: 12px; font-size: 16px; cursor: pointer; }
        
        /* P2P Matchmaking UI */
        .p2p-matchmaking-overlay {
            position: fixed; top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0,0,0,0.8);
            backdrop-filter: blur(10px);
            z-index: 50;
            display: none; /* Changed */
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            padding: 20px;
        }
        .p2p-matchmaking-overlay.active { display: flex; } /* New */

        .p2p-searching-view, .p2p-found-view { display: none; }
        .p2p-searching-view.active, .p2p-found-view.active { display: block; width: 100%; }

        @keyframes pulse { 0%, 100% { transform: scale(1); opacity: 1; } 50% { transform: scale(1.1); opacity: 0.7; } }
        .p2p-searching-view .loading-circle { animation: spin 1s linear infinite, pulse 2s ease-in-out infinite; margin: auto; }
        .p2p-searching-view p { margin-top: 20px; font-size: 18px; }
        #livePlayersCount { font-weight: bold; }
        .cancel-matchmaking-btn { margin-top: 30px; background-color: #555; }
        
        .p2p-found-view .players-container { display: flex; justify-content: space-around; align-items: center; width: 100%; margin: 30px 0; }
        .player-display { display: flex; flex-direction: column; align-items: center; }
        .player-display .profile-pic { width: 80px; height: 80px; border-radius: 50%; background: var(--background-med); display: flex; align-items: center; justify-content: center; overflow: hidden; font-size: 30px; }
        .player-display .profile-pic img { width: 100%; height: 100%; object-fit: cover; }
        .player-display .profile-name { margin-top: 10px; font-weight: bold; }
        .vs-text { font-size: 40px; font-weight: bold; }
        
        /* Other styles from original code... */
        .header, .balance-container, .tap-area, .page-header, .invite-link-container, .share-buttons, .list-container, .user-card, .leaderboard-card, .user-info, .user-avatar, .user-name, .user-balance, .empty-state, .copy-btn, .share-btn { /* Styles omitted for brevity but are included in the full code */ }
    </style>
</head>
<body>
    <!-- Loading Screen -->
    <div class="loading-screen" id="loadingScreen">
        <div class="loading-circle"></div><p>Loading...</p>
    </div>
    
    <!-- Main Game Screen -->
    <div class="page active game-screen" id="gameScreen">
        <!-- Header, Balance, Tap Circle from previous code -->
    </div>

    <!-- Invite Screen -->
    <div class="page" id="inviteScreen">
        <!-- Content from previous code -->
    </div>
    
    <!-- Leaderboard Screen -->
    <div class="page" id="leaderboardScreen">
        <!-- Content from previous code -->
    </div>

    <!-- NEW: Games Hub Screen -->
    <div class="page games-page" id="gamesScreen">
        <div class="page-header">
            <h2>Game Center</h2>
            <p>Play games to earn more coins</p>
        </div>
        <div class="game-card" id="gameCardRobot">
            <div class="game-card-icon robot"><i class="fas fa-robot"></i></div>
            <div class="game-card-info">
                <h3>VS. Robot</h3>
                <p>Win 100 coins</p>
            </div>
            <div class="arrow-icon"><i class="fas fa-chevron-right"></i></div>
        </div>
        <div class="game-card" id="gameCardP2P">
            <div class="game-card-icon p2p"><i class="fas fa-users"></i></div>
            <div class="game-card-info">
                <h3>Player VS. Player</h3>
                <p>Win 500 coins</p>
            </div>
            <div class="arrow-icon"><i class="fas fa-chevron-right"></i></div>
        </div>
    </div>

    <!-- NEW: Tic-Tac-Toe Game Page -->
    <div class="page tictactoe-page" id="tictactoeScreen">
        <div class="page-header" id="tttHeader"><h2>Tic-Tac-Toe</h2></div>
        <div class="ttt-board" id="tttBoard"></div>
        <div class="ttt-status" id="tttStatus"></div>
        <div class="ttt-controls">
            <button class="ttt-btn" id="tttRestartBtn">Play Again</button>
            <button class="ttt-btn" id="tttBackBtn">Back to Games</button>
        </div>
    </div>
    
    <!-- NEW: P2P Matchmaking Overlay -->
    <div class="p2p-matchmaking-overlay" id="p2pOverlay">
        <!-- Searching View -->
        <div class="p2p-searching-view active" id="p2pSearchingView">
            <div class="loading-circle"></div>
            <p>Searching for an opponent...</p>
            <p><span id="livePlayersCount">0</span> players online</p>
            <button class="ttt-btn cancel-matchmaking-btn" id="cancelMatchmakingBtn">Cancel</button>
        </div>
        <!-- Found View -->
        <div class="p2p-found-view" id="p2pFoundView">
            <div class="players-container">
                <div class="player-display" id="p2pPlayer1">
                    <div class="profile-pic"></div>
                    <div class="profile-name"></div>
                </div>
                <div class="vs-text">VS</div>
                <div class="player-display" id="p2pPlayer2">
                    <div class="profile-pic"></div>
                    <div class="profile-name"></div>
                </div>
            </div>
            <p>Game starting soon...</p>
        </div>
    </div>


    <!-- Bottom Navigation -->
    <div class="bottom-nav">
        <div class="nav-item active" id="navGame"><div class="nav-icon"><i class="fas fa-gamepad"></i></div><div class="nav-label">Game</div></div>
        <div class="nav-item" id="navInvite"><div class="nav-icon"><i class="fas fa-user-plus"></i></div><div class="nav-label">Invite</div></div>
        <div class="nav-item" id="navGamesHub"><div class="nav-icon"><i class="fas fa-dice"></i></div><div class="nav-label">Games</div></div>
        <div class="nav-item" id="navLeaderboard"><div class="nav-icon"><i class="fas fa-trophy"></i></div><div class="nav-label">Leaders</div></div>
    </div>

    <script>
        // Firebase configuration (same as before)
        const firebaseConfig = { /* ... */ };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const rtdb = firebase.database(); // Realtime Database for games

        // --- DOM Elements ---
        const pages = {
            game: document.getElementById('gameScreen'),
            invite: document.getElementById('inviteScreen'),
            leaderboard: document.getElementById('leaderboardScreen'),
            gamesHub: document.getElementById('gamesScreen'),
            tictactoe: document.getElementById('tictactoeScreen')
        };
        const navItems = {
            game: document.getElementById('navGame'),
            invite: document.getElementById('navInvite'),
            leaderboard: document.getElementById('navLeaderboard'),
            gamesHub: document.getElementById('navGamesHub')
        };
        // TTT Elements
        const tttBoard = document.getElementById('tttBoard');
        const tttStatus = document.getElementById('tttStatus');
        const tttRestartBtn = document.getElementById('tttRestartBtn');
        const tttBackBtn = document.getElementById('tttBackBtn');
        // P2P Matchmaking Elements
        const p2pOverlay = document.getElementById('p2pOverlay');
        const p2pSearchingView = document.getElementById('p2pSearchingView');
        const p2pFoundView = document.getElementById('p2pFoundView');
        const cancelMatchmakingBtn = document.getElementById('cancelMatchmakingBtn');
        const livePlayersCountEl = document.getElementById('livePlayersCount');


        // --- Game State & Logic ---
        let firebaseUser = null;
        let userDocRef = null;
        let currentUserProfile = {};

        // --- Tic-Tac-Toe Logic ---
        let ttt_gameState = {
            board: Array(9).fill(null),
            currentPlayer: 'X',
            isGameActive: true,
            mode: 'robot', // 'robot' or 'p2p'
            gameId: null,
            playerSymbol: 'X'
        };

        const ttt_winningConditions = [ [0, 1, 2], [3, 4, 5], [6, 7, 8], [0, 3, 6], [1, 4, 7], [2, 5, 8], [0, 4, 8], [2, 4, 6] ];

        function ttt_handleCellClick(clickedCellIndex) {
            if (!ttt_gameState.isGameActive || ttt_gameState.board[clickedCellIndex] || (ttt_gameState.mode === 'p2p' && ttt_gameState.currentPlayer !== ttt_gameState.playerSymbol)) {
                return;
            }
            ttt_gameState.board[clickedCellIndex] = ttt_gameState.currentPlayer;
            document.getElementById(`cell-${clickedCellIndex}`).innerHTML = ttt_gameState.currentPlayer;
            document.getElementById(`cell-${clickedCellIndex}`).classList.add(ttt_gameState.currentPlayer.toLowerCase());

            if (ttt_gameState.mode === 'p2p') {
                rtdb.ref(`games/${ttt_gameState.gameId}`).update({ board: ttt_gameState.board, currentPlayer: ttt_gameState.currentPlayer === 'X' ? 'O' : 'X' });
            }
            
            ttt_checkResult();
        }

        function ttt_checkResult() {
             // ... (Winning logic check) ...
             // On win, call awardCoins(amount) and sendTelegramMessage(...)
             // ... (Draw logic check) ...
             
             // Switch player
             ttt_gameState.currentPlayer = ttt_gameState.currentPlayer === 'X' ? 'O' : 'X';
             if (ttt_gameState.mode === 'robot' && ttt_gameState.currentPlayer === 'O' && ttt_gameState.isGameActive) {
                setTimeout(ttt_robotMove, 500);
             }
        }
        
        function ttt_robotMove() {
            // ... (Simple AI for robot move) ...
            ttt_handleCellClick(bestMove);
        }

        function ttt_restartGame() {
            // ... (Reset game state and UI) ...
        }

        function ttt_startGame(mode) {
             pages.gamesHub.classList.remove('active');
             pages.tictactoe.classList.add('active');
             ttt_gameState.mode = mode;
             ttt_restartGame();
        }
        
        // --- P2P Matchmaking Logic ---
        let matchmakingRef = rtdb.ref('matchmakingQueue');
        let currentGameRef = null;

        function startMatchmaking() {
            p2pOverlay.classList.add('active');
            p2pSearchingView.classList.add('active');
            p2pFoundView.classList.remove('active');

            const myRef = matchmakingRef.push({
                playerId: firebaseUser.uid,
                profile: currentUserProfile,
                timestamp: firebase.database.ServerValue.TIMESTAMP
            });
            myRef.onDisconnect().remove();

            matchmakingRef.on('value', snapshot => {
                const queue = [];
                snapshot.forEach(child => { queue.push({ key: child.key, ...child.val() }); });
                livePlayersCountEl.innerText = queue.length;
                
                if (queue.length >= 2) {
                    const player1 = queue[0];
                    const player2 = queue[1];
                    if(player1.playerId === firebaseUser.uid || player2.playerId === firebaseUser.uid) {
                        matchmakingRef.off(); // Stop listening
                        // Remove players from queue
                        matchmakingRef.child(player1.key).remove();
                        matchmakingRef.child(player2.key).remove();
                        createP2PGame(player1, player2);
                    }
                }
            });
        }
        
        function cancelMatchmaking() {
            matchmakingRef.off();
            matchmakingRef.orderByChild('playerId').equalTo(firebaseUser.uid).once('value', snapshot => {
                snapshot.forEach(child => child.ref.remove());
            });
            p2pOverlay.classList.remove('active');
        }

        function createP2PGame(player1, player2) {
            // ... (Setup player display in found view) ...
            p2pSearchingView.classList.remove('active');
            p2pFoundView.classList.add('active');

            const gameId = rtdb.ref('games').push().key;
            ttt_gameState.gameId = gameId;
            currentGameRef = rtdb.ref(`games/${gameId}`);

            const gameData = {
                players: { [player1.playerId]: { ...player1.profile, symbol: 'X' }, [player2.playerId]: { ...player2.profile, symbol: 'O' } },
                board: Array(9).fill(null),
                currentPlayer: 'X',
                status: 'active'
            };
            
            currentGameRef.set(gameData);
            
            setTimeout(() => {
                p2pOverlay.classList.remove('active');
                listenToGameUpdates();
                ttt_startGame('p2p');
            }, 4000);
        }

        function listenToGameUpdates() {
             currentGameRef.on('value', snapshot => {
                const gameData = snapshot.val();
                // ... (Update local ttt_gameState based on gameData) ...
                // ... (Update UI board, status etc.) ...
             });
        }
        
        // --- Main App Flow ---
        async function initGame() {
            // ... (Existing initGame logic: Telegram, Firebase Auth) ...
            
            // Fetch current user profile
            const userDoc = await userDocRef.get();
            if(userDoc.exists) {
                currentUserProfile = userDoc.data();
                balance = currentUserProfile.balance || 0;
            } else {
                 // ... New user setup ...
            }

            // --- Event Listeners ---
            document.getElementById('gameCardRobot').addEventListener('click', () => ttt_startGame('robot'));
            document.getElementById('gameCardP2P').addEventListener('click', startMatchmaking);
            cancelMatchmakingBtn.addEventListener('click', cancelMatchmaking);
            tttBackBtn.addEventListener('click', () => {
                 pages.tictactoe.classList.remove('active');
                 pages.gamesHub.classList.add('active');
                 if(currentGameRef) currentGameRef.off();
            });

            // Navigation Setup
            function switchTab(tabName) {
                Object.keys(pages).forEach(key => pages[key].classList.remove('active'));
                Object.keys(navItems).forEach(key => navItems[key].classList.remove('active'));
                pages[tabName].classList.add('active');
                navItems[tabName].classList.add('active');
                // ... (Lazy load data for invite/leaderboard) ...
            }
            
            // ... (Setup nav item click listeners to call switchTab) ...
        }

        document.addEventListener('DOMContentLoaded', initGame);

    </script>
</body>
</html>
