<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tap Game</title>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script> <!-- Changed to Realtime Database -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background: #1b1e2e;
            color: white;
            height: 100vh;
            overflow: hidden;
        }
        
        /* Loading Screen */
        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #0f0f10;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 100;
            transition: opacity 0.5s ease;
        }
        
        .loading-circle {
            width: 60px;
            height: 60px;
            border: 4px solid rgba(255, 255, 255, 0.1);
            border-top-color: #6e45e2;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Main Game Screen */
        .game-screen {
            display: none;
            height: calc(100% - 70px); /* Adjusted for nav bar */
            flex-direction: column;
        }
        
        /* Header */
        .header {
            padding: 15px;
            display: flex;
            justify-content: flex-end;
        }
        
        .profile {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .profile-pic {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #2a2a2b;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
        }
        
        .profile-pic img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .profile-name {
            font-weight: bold;
            font-size: 14px;
        }
        
        /* Balance */
        .balance-container {
            text-align: center;
            margin-top: 20px;
        }
        
        .balance-label {
            font-size: 14px;
            color: #aaa;
            margin-bottom: 5px;
        }
        
        .balance-amount {
            font-size: 36px;
            font-weight: bold;
            background: linear-gradient(to right, #6e45e2, #88d3ce);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        /* Tap Circle */
        .tap-area {
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
        }
        
        .tap-circle {
            width: 280px;
            height: 280px;
            border-radius: 50%;
            background: linear-gradient(135deg, #2a2a2b, #1a1a1b);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
            cursor: pointer;
            transition: transform 0.1s ease;
        }
        
        .tap-circle:active {
            transform: scale(0.95);
        }
        
        .tap-circle-inner {
            width: 240px;
            height: 240px;
            border-radius: 50%;
            background: linear-gradient(135deg, #3a3a3c, #2a2a2b);
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 24px;
            font-weight: bold;
            color: white;
        }
        
        .coin-effect {
            position: absolute;
            font-size: 24px;
            font-weight: bold;
            color: #FFD700;
            opacity: 0;
            pointer-events: none;
            animation: float-up 1s ease-out forwards;
        }
        
        @keyframes float-up {
            0% {
                transform: translateY(0) scale(0.8);
                opacity: 1;
            }
            100% {
                transform: translateY(-100px) scale(1.2);
                opacity: 0;
            }
        }
        
        /* Page Styles */
        .page {
             display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: calc(100% - 70px); /* Adjusted for nav bar height */
            background: #0f0f10;
            padding: 20px;
            overflow-y: auto;
            z-index: 5;
        }

        .page-header {
            text-align: center;
            margin-bottom: 20px;
        }

        .page-header h2 {
            font-size: 24px;
            margin-bottom: 8px;
        }

        .page-header p {
            color: #aaa;
            font-size: 14px;
        }

        /* Invite Screen Specifics */
        .invite-link-container {
            display: flex;
            margin-bottom: 20px;
            background: #1a1a1b;
            border-radius: 12px;
            overflow: hidden;
        }

        .invite-link {
            flex: 1;
            padding: 15px;
            font-size: 14px;
            word-break: break-all;
            color: #88d3ce;
        }

        .copy-btn {
            background: #6e45e2;
            color: white;
            border: none;
            padding: 0 20px;
            font-weight: bold;
            cursor: pointer;
            transition: background 0.2s ease;
        }

        .copy-btn:active {
            background: #5a35c0;
        }

        .share-buttons {
            display: flex;
            justify-content: center;
            margin-bottom: 20px;
        }

        .share-btn {
            background: #0088cc;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 12px;
            font-size: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .share-btn:active {
            background: #006699;
        }
        
        .list-container {
            background: #1a1a1b;
            border-radius: 12px;
            padding: 15px;
        }

        .list-container h3 {
            margin-bottom: 15px;
            font-size: 18px;
        }
        
        .list-scrollable {
            max-height: 40vh;
            overflow-y: auto;
        }

        .user-card, .leaderboard-card {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid #2a2a2b;
        }

        .user-card:last-child, .leaderboard-card:last-child {
            border-bottom: none;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 12px;
            flex-grow: 1;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #2a2a2b;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
            flex-shrink: 0;
        }

        .user-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .user-name {
            font-weight: bold;
            font-size: 14px;
        }

        .user-balance {
            color: #88d3ce;
            font-weight: bold;
            flex-shrink: 0;
        }

        .empty-state {
            color: #666;
            text-align: center;
            padding: 20px 0;
        }
        
        /* Leaderboard Styles */
        .leaderboard-card .rank {
            font-size: 18px;
            font-weight: bold;
            width: 40px;
            text-align: center;
            color: #aaa;
            flex-shrink: 0;
        }
        
        .rank-1, .rank-2, .rank-3 {
            font-size: 24px;
        }
        .rank-1 { color: #FFD700; } /* Gold */
        .rank-2 { color: #C0C0C0; } /* Silver */
        .rank-3 { color: #CD7F32; } /* Bronze */
        
        /* Bottom Navigation */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background: #1a1a1b;
            display: flex;
            padding-top: 10px;
            padding-bottom: 10px;
            border-top: 1px solid #2a2a2b;
            z-index: 10;
        }

        .nav-item {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: #888;
            cursor: pointer;
            transition: color 0.2s ease;
        }

        .nav-item.active {
            color: #6e45e2;
        }

        .nav-icon {
            font-size: 24px;
            margin-bottom: 4px;
        }

        .nav-label {
            font-size: 12px;
        }
        
        /* Games Tab Styles */
        .games-container {
            display: flex;
            flex-direction: column;
            gap: 20px;
            padding: 0 10px;
        }
        
        .game-card {
            background: #1a1a1b;
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 6px 16px rgba(0,0,0,0.3);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            cursor: pointer;
        }
        
        .game-card:active {
            transform: scale(0.98);
        }
        
        .game-card-header {
            padding: 20px;
            display: flex;
            align-items: center;
            gap: 15px;
            background: linear-gradient(90deg, #6e45e2, #88d3ce);
        }
        
        .game-icon {
            font-size: 28px;
            background: rgba(255,255,255,0.2);
            width: 50px;
            height: 50px;
            border-radius: 12px;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .game-title {
            font-size: 18px;
            font-weight: bold;
        }
        
        .game-subtitle {
            font-size: 14px;
            opacity: 0.9;
        }
        
        .game-card-body {
            padding: 20px;
        }
        
        .game-info {
            display: flex;
            justify-content: space-between;
            margin-bottom: 15px;
            font-size: 14px;
        }
        
        .game-info-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .game-info-item i {
            color: #6e45e2;
        }
        
        .prize-badge {
            background: linear-gradient(90deg, #ffd700, #ff9800);
            color: #000;
            padding: 5px 12px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 14px;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }
        
        /* Tic Tac Toe Game Styles */
        .tic-tac-toe-container {
            display: flex;
            flex-direction: column;
            height: 100%;
        }
        
        .game-header {
            padding: 20px;
            text-align: center;
            border-bottom: 1px solid #2a2a2b;
        }
        
        .game-header h2 {
            font-size: 24px;
            margin-bottom: 5px;
        }
        
        .game-status {
            font-size: 16px;
            color: #88d3ce;
        }
        
        .opponent-info {
            display: flex;
            justify-content: space-around;
            align-items: center;
            padding: 15px;
            margin: 10px 0;
            background: #1a1a1b;
            border-radius: 12px;
        }
        
        .player-card {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
        }
        
        .player-avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: #2a2a2b;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
            position: relative;
        }
        
        .player-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .player-mark {
            position: absolute;
            bottom: -5px;
            right: -5px;
            background: #6e45e2;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-weight: bold;
            font-size: 18px;
            border: 2px solid #1a1a1b;
        }
        
        .player-name {
            font-weight: bold;
            max-width: 100px;
            text-overflow: ellipsis;
            overflow: hidden;
            white-space: nowrap;
        }
        
        .vs {
            font-size: 20px;
            font-weight: bold;
            color: #888;
        }
        
        .board-container {
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        
        .game-board {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            grid-gap: 10px;
            width: 300px;
            height: 300px;
            background: #2a2a2b;
            border-radius: 12px;
            padding: 10px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        
        .cell {
            background: #1a1a1b;
            border-radius: 8px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 48px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .cell:hover {
            background: #252528;
        }
        
        .cell.x {
            color: #6e45e2;
        }
        
        .cell.o {
            color: #88d3ce;
        }
        
        .cell.win {
            animation: win-cell 1s ease infinite;
        }
        
        @keyframes win-cell {
            0%, 100% { background: rgba(110, 69, 226, 0.1); }
            50% { background: rgba(110, 69, 226, 0.3); }
        }
        
        .game-controls {
            padding: 20px;
            display: flex;
            justify-content: center;
            gap: 15px;
        }
        
        .game-btn {
            background: #6e45e2;
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 12px;
            font-size: 16px;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .game-btn:active {
            background: #5a35c0;
        }
        
        .game-btn.exit {
            background: #2a2a2b;
        }
        
        /* P2P Lobby */
        .lobby-container {
            padding: 20px;
            text-align: center;
        }
        
        /* Game Result Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            display: none; /* Changed from flex */
            justify-content: center;
            align-items: center;
            z-index: 20;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }
        
        .modal-overlay.show {
            display: flex; /* Show with flex */
            opacity: 1;
            pointer-events: all;
        }
        
        .modal-content {
            background: #1a1a1b;
            border-radius: 20px;
            width: 90%;
            max-width: 400px;
            padding: 30px;
            text-align: center;
            transform: translateY(20px);
            transition: transform 0.3s ease;
        }
        
        .modal-overlay.show .modal-content {
            transform: translateY(0);
        }
        
        .modal-icon {
            font-size: 60px;
            margin-bottom: 20px;
        }
        
        .modal-icon.win {
            color: #FFD700;
        }
        
        .modal-icon.draw {
            color: #88d3ce;
        }
        .modal-icon.loss {
            color: #e74c3c;
        }
        
        .modal-title {
            font-size: 28px;
            margin-bottom: 10px;
        }
        
        .modal-message {
            font-size: 18px;
            margin-bottom: 20px;
            color: #aaa;
        }
        
        .prize-amount {
            font-size: 24px;
            font-weight: bold;
            color: #FFD700;
            margin: 20px 0;
        }
        
        .modal-btn {
            background: #6e45e2;
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 12px;
            font-size: 18px;
            font-weight: bold;
            width: 100%;
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .modal-btn:active {
            background: #5a35c0;
        }
    </style>
</head>
<body>
    <!-- Loading Screen -->
    <div class="loading-screen" id="loadingScreen">
        <div class="loading-circle"></div>
        <p>Loading...</p>
    </div>
    
    <!-- Main Game Screen -->
    <div class="game-screen" id="gameScreen">
        <div class="header">
            <div class="profile" id="profile">
                <div class="profile-pic" id="profilePic"><span>?</span></div>
                <div class="profile-name" id="profileName"></div>
            </div>
        </div>
        <div class="balance-container">
            <div class="balance-label">Your Balance</div>
            <div class="balance-amount" id="balance">0</div>
        </div>
        <div class="tap-area">
            <div class="tap-circle" id="tapCircle">
                <div class="tap-circle-inner">TAP</div>
            </div>
        </div>
    </div>

    <!-- Invite Screen -->
    <div class="page" id="inviteScreen">
        <div class="page-header">
            <h2>Invite Friends</h2>
            <p>Earn bonuses when your friends join and play</p>
        </div>
        <div class="invite-link-container">
            <div class="invite-link" id="inviteLink">Loading...</div>
            <button class="copy-btn" id="copyBtn">Copy</button>
        </div>
        <div class="share-buttons">
            <button class="share-btn" id="shareTelegramBtn">
                <i class="fab fa-telegram-plane"></i> Share via Telegram
            </button>
        </div>
        <div class="list-container">
            <h3>Your Team</h3>
            <div class="list-scrollable" id="usersList">
                <div class="empty-state">No invited users yet</div>
            </div>
        </div>
    </div>
    
    <!-- Leaderboard Screen -->
    <div class="page" id="leaderboardScreen">
        <div class="page-header">
            <h2>🏆 Leaderboard 🏆</h2>
        </div>
        <div class="list-container">
             <div class="list-scrollable" id="leaderboardList">
                <div class="empty-state">Loading...</div>
             </div>
        </div>
    </div>
    
    <!-- Games Screen -->
    <div class="page" id="gamesScreen">
        <div class="page-header">
            <h2>🎮 Mini Games 🎮</h2>
            <p>Play games to earn extra coins!</p>
        </div>
        <div class="games-container">
            <div class="game-card" id="robotGameCard">
                <div class="game-card-header">
                    <div class="game-icon">
                        <i class="fas fa-robot"></i>
                    </div>
                    <div>
                        <div class="game-title">Tic Tac Toe vs Robot</div>
                        <div class="game-subtitle">Test your skills against our AI</div>
                    </div>
                </div>
                <div class="game-card-body">
                    <div class="game-info">
                        <div class="game-info-item">
                            <i class="fas fa-trophy"></i> Win Prize: 100 Coins
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="game-card" id="pvpGameCard">
                <div class="game-card-header">
                    <div class="game-icon">
                        <i class="fas fa-users"></i>
                    </div>
                    <div>
                        <div class="game-title">Tic Tac Toe vs Player</div>
                        <div class="game-subtitle">Challenge a friend to a match</div>
                    </div>
                </div>
                <div class="game-card-body">
                    <div class="game-info">
                        <div class="game-info-item">
                            <i class="fas fa-trophy"></i> Win Prize: 500 Coins
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Robot Game Screen -->
    <div class="page" id="robotGameScreen">
        <!-- ... (robot game HTML is unchanged) ... -->
    </div>
    
    <!-- P2P Game Screen -->
    <div class="page" id="pvpGameScreen">
        <div class="game-header">
            <h2>Tic Tac Toe vs Player</h2>
            <div class="game-status" id="pvpGameStatus">Setting up...</div>
        </div>
        
        <div class="opponent-info" id="pvpOpponentInfo" style="display: none;">
            <div class="player-card">
                <div class="player-avatar" id="player1Avatar"><span>?</span></div>
                <div class="player-name" id="player1Name">Player 1</div>
            </div>
            <div class="vs">VS</div>
            <div class="player-card">
                <div class="player-avatar" id="player2Avatar"><i class="fas fa-user-clock" style="font-size: 24px;"></i></div>
                <div class="player-name" id="player2Name">Waiting...</div>
            </div>
        </div>
        
        <div class="lobby-container" id="pvpLobby">
            <!-- Content generated by JS: either "Creating game..." or the invite link -->
        </div>
        
        <div class="board-container" id="pvpBoardContainer" style="display: none;">
            <div class="game-board" id="pvpBoard">
                <div class="cell" data-index="0"></div><div class="cell" data-index="1"></div><div class="cell" data-index="2"></div>
                <div class="cell" data-index="3"></div><div class="cell" data-index="4"></div><div class="cell" data-index="5"></div>
                <div class="cell" data-index="6"></div><div class="cell" data-index="7"></div><div class="cell" data-index="8"></div>
            </div>
        </div>
        
        <div class="game-controls">
            <button class="game-btn exit" id="exitPvpGame">
                <i class="fas fa-arrow-left"></i> Back
            </button>
        </div>
    </div>
    
    <!-- Game Result Modal -->
    <div class="modal-overlay" id="gameResultModal">
        <div class="modal-content">
            <div class="modal-icon win" id="resultIcon"><i class="fas fa-trophy"></i></div>
            <h2 class="modal-title" id="resultTitle">Victory!</h2>
            <p class="modal-message" id="resultMessage">You won!</p>
            <div class="prize-amount" id="prizeAmount">+100 coins</div>
            <button class="modal-btn" id="modalBtn">Continue</button>
        </div>
    </div>

    <!-- Bottom Navigation -->
    <div class="bottom-nav" id="bottomNav">
        <div class="nav-item active" id="navGame"><div class="nav-icon"><i class="fas fa-gamepad"></i></div><div class="nav-label">Game</div></div>
        <div class="nav-item" id="navInvite"><div class="nav-icon"><i class="fas fa-user-plus"></i></div><div class="nav-label">Invite</div></div>
        <div class="nav-item" id="navLeaderboard"><div class="nav-icon"><i class="fas fa-trophy"></i></div><div class="nav-label">Leaders</div></div>
        <div class="nav-item" id="navGames"><div class="nav-icon"><i class="fas fa-dice"></i></div><div class="nav-label">Games</div></div>
    </div>

    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBX3g8wWxcTtwFDsJNJVcjUDIGxMd1L0Rk",
            authDomain: "mytestapp-f6913.firebaseapp.com",
            databaseURL: "https://mytestapp-f6913-default-rtdb.firebaseio.com",
            projectId: "mytestapp-f6913",
            storageBucket: "mytestapp-f6913.appspot.com",
            messagingSenderId: "300150696072",
            appId: "1:300150696072:web:1e29cb5a813d004018573d",
            measurementId: "G-PPDR4TBQF5"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.database(); // Using Realtime Database

        // DOM elements
        const loadingScreen = document.getElementById('loadingScreen');
        const gameScreen = document.getElementById('gameScreen');
        const profilePic = document.getElementById('profilePic');
        const profileName = document.getElementById('profileName');
        const balanceDisplay = document.getElementById('balance');
        const tapCircle = document.getElementById('tapCircle');
        const bottomNav = document.getElementById('bottomNav');
        
        // Navigation
        const navItems = { game: document.getElementById('navGame'), invite: document.getElementById('navInvite'), leaderboard: document.getElementById('navLeaderboard'), games: document.getElementById('navGames') };
        const pages = { game: gameScreen, invite: document.getElementById('inviteScreen'), leaderboard: document.getElementById('leaderboardScreen'), games: document.getElementById('gamesScreen'), robotGame: document.getElementById('robotGameScreen'), pvpGame: document.getElementById('pvpGameScreen') };

        // Invite Screen Elements
        const inviteLink = document.getElementById('inviteLink');
        const copyBtn = document.getElementById('copyBtn');
        const usersList = document.getElementById('usersList');
        const shareTelegramBtn = document.getElementById('shareTelegramBtn');

        // Leaderboard element
        const leaderboardList = document.getElementById('leaderboardList');
        
        // Game state
        let balance = 0;
        let firebaseUser = null;
        let userDocRef = null;
        let userData = {};
        let coinsPerTap = 1;
        let invitedBy = null;
        const botUsername = 'your_telegram_bot_username_here'; // IMPORTANT: REPLACE WITH YOUR BOT USERNAME

        function padTelegramId(id) { return String(id).padStart(6, '0'); }
        
        // ... (Other helper functions like createCoinEffect, sendTelegramMessage)

        // Handle tap event
        function handleTap(e) {
            e.preventDefault();
            balance += coinsPerTap;
            balanceDisplay.textContent = balance.toLocaleString();
            if (userDocRef) {
                // Use RTDB ServerValue.increment for atomic updates
                userDocRef.child('balance').set(firebase.database.ServerValue.increment(coinsPerTap));
            }
        }
        
        // Load Leaderboard data from RTDB
        async function loadLeaderboard() {
            leaderboardList.innerHTML = '<div class="empty-state">Loading...</div>';
            try {
                const usersRef = db.ref('users');
                const snapshot = await usersRef.orderByChild('balance').limitToLast(100).once('value');
                if (!snapshot.exists()) {
                    leaderboardList.innerHTML = '<div class="empty-state">Be the first!</div>';
                    return;
                }

                const usersData = snapshot.val();
                const usersArray = Object.values(usersData);
                usersArray.sort((a, b) => (b.balance || 0) - (a.balance || 0));

                leaderboardList.innerHTML = '';
                usersArray.forEach((userData, index) => {
                    const rank = index + 1;
                    // ... (rendering logic is the same)
                });
            } catch (error) {
                console.error("Error loading leaderboard:", error);
                leaderboardList.innerHTML = '<div class="empty-state">Could not load.</div>';
            }
        }

        let pvpGameUnsubscribe = null;
        let currentGameId = null;

        // NEW: Tic Tac Toe Logic with RTDB and Link Matchmaking
        function initTicTacToe() {
            // ... (Get all DOM elements for games) ...
            const pvpGameCard = document.getElementById('pvpGameCard');
            const pvpGameStatus = document.getElementById('pvpGameStatus');
            const pvpLobby = document.getElementById('pvpLobby');
            const pvpBoardContainer = document.getElementById('pvpBoardContainer');
            const pvpOpponentInfo = document.getElementById('pvpOpponentInfo');
            const pvpBoard = document.getElementById('pvpBoard');
            const exitPvpGameBtn = document.getElementById('exitPvpGame');
            const modalBtn = document.getElementById('modalBtn');
            const gameResultModal = document.getElementById('gameResultModal');
            
            // Player info elements
            const player1Avatar = document.getElementById('player1Avatar'), player2Avatar = document.getElementById('player2Avatar');
            const player1Name = document.getElementById('player1Name'), player2Name = document.getElementById('player2Name');

            // Ends and cleans up a PvP game from the database
            async function endAndCleanPvpGame() {
                if (pvpGameUnsubscribe) {
                    db.ref('games/' + currentGameId).off('value', pvpGameUnsubscribe);
                    pvpGameUnsubscribe = null;
                }
                if (currentGameId) {
                    await db.ref('games/' + currentGameId).remove();
                    currentGameId = null;
                }
                switchTab('games');
            }

            // Handles a player quitting or canceling a game
            async function quitPvpGame() {
                if (!currentGameId) {
                    switchTab('games');
                    return;
                }
                
                const gameRef = db.ref('games/' + currentGameId);
                if (pvpGameUnsubscribe) {
                    gameRef.off('value', pvpGameUnsubscribe);
                    pvpGameUnsubscribe = null;
                }
                
                const snapshot = await gameRef.get();
                if (snapshot.exists()) {
                    const gameData = snapshot.val();
                    if (gameData.status === 'waiting' && gameData.player1Id === firebaseUser.uid) {
                        await gameRef.remove(); // Creator cancels a waiting game
                    } else if (gameData.gameActive) {
                        const opponentId = gameData.player1Id === firebaseUser.uid ? gameData.player2Id : gameData.player1Id;
                        await gameRef.update({ winnerId: opponentId, gameActive: false, status: 'forfeited' });
                    }
                }
                currentGameId = null;
                switchTab('games');
            }
            
            // Updates the UI based on the real-time game state from RTDB
            function updatePvpUI(gameData) {
                if (gameData.status === 'waiting') {
                    pvpOpponentInfo.style.display = 'none';
                    pvpBoardContainer.style.display = 'none';
                    pvpLobby.style.display = 'block';
                    const link = `https://t.me/${botUsername}?startapp=game_${gameData.gameId}`;
                    pvpGameStatus.textContent = 'Waiting for an opponent...';
                    pvpLobby.innerHTML = `
                        <i class="fas fa-link" style="font-size: 36px; margin-bottom: 15px;"></i>
                        <div>Share this link with a friend to play!</div>
                        <div class="invite-link-container" style="margin: 20px 0;">
                             <div class="invite-link" id="pvpInviteLink" style="font-size: 12px; color: #88d3ce;">${link}</div>
                             <button class="copy-btn" id="pvpCopyBtn">Copy</button>
                        </div>`;
                    document.getElementById('pvpCopyBtn').onclick = () => {
                        navigator.clipboard.writeText(link).then(() => {
                            document.getElementById('pvpCopyBtn').textContent = 'Copied!';
                        });
                    };
                    exitPvpGameBtn.innerHTML = '<i class="fas fa-times"></i> Cancel Game';
                } else { // Game is active, finished, or forfeited
                    pvpLobby.style.display = 'none';
                    pvpOpponentInfo.style.display = 'flex';
                    pvpBoardContainer.style.display = 'block';
                    exitPvpGameBtn.innerHTML = '<i class="fas fa-flag"></i> Forfeit';

                    // Update player info...
                    
                    // Render board...
                    const cells = pvpBoard.querySelectorAll('.cell');
                    gameData.board.forEach((mark, index) => {
                        cells[index].textContent = mark;
                        cells[index].className = `cell ${mark ? mark.toLowerCase() : ''}`;
                    });

                    if (!gameData.gameActive) {
                        // Handle showing result modal
                    } else {
                        pvpGameStatus.textContent = gameData.currentPlayerId === firebaseUser.uid ? "Your turn!" : "Opponent's turn...";
                    }
                }
            }

            // Listens for game updates in RTDB
            function listenForPvpUpdates(gameId) {
                currentGameId = gameId;
                const gameRef = db.ref('games/' + gameId);

                if (pvpGameUnsubscribe) gameRef.off('value', pvpGameUnsubscribe);

                pvpGameUnsubscribe = (snapshot) => {
                    if (!snapshot.exists()) {
                        if (gameResultModal.classList.contains('show')) return; // Avoid alert if we just closed the modal
                        alert("The game session has ended.");
                        endAndCleanPvpGame(); // Clean up local state
                        return;
                    }
                    const gameData = snapshot.val();
                    updatePvpUI(gameData);
                };
                gameRef.on('value', pvpGameUnsubscribe);
            }

            // Main entry point for starting the game from the main screen
            window.joinPvpGame = async (gameId) => {
                const gameRef = db.ref('games/' + gameId);
                const snapshot = await gameRef.get();

                if (!snapshot.exists() || snapshot.val().status !== 'waiting') {
                    alert("This game is no longer available or has already started.");
                    switchTab('game');
                    return;
                }

                const gameData = snapshot.val();
                if (gameData.player1Id === firebaseUser.uid) { // Player opened their own link
                    listenForPvpUpdates(gameId);
                    switchTab('pvpGame');
                    return;
                }

                // Player 2 is joining
                const updates = {
                    player2Id: firebaseUser.uid,
                    player2Data: userData,
                    status: 'active',
                    gameActive: true,
                    board: Array(9).fill(''),
                    currentPlayerId: Math.random() < 0.5 ? gameData.player1Id : firebaseUser.uid,
                    players: {
                        [gameData.player1Id]: { mark: 'X' },
                        [firebaseUser.uid]: { mark: 'O' }
                    }
                };
                await gameRef.update(updates);
                listenForPvpUpdates(gameId);
                switchTab('pvpGame');
            };

            // Creates a new game and waits for an opponent
            async function createPvpGame() {
                switchTab('pvpGame');
                pvpLobby.innerHTML = '<div class="empty-state">Creating your private match...</div>';

                const newGameRef = db.ref('games').push();
                const gameData = {
                    gameId: newGameRef.key,
                    player1Id: firebaseUser.uid,
                    player1Data: userData,
                    status: 'waiting',
                    createdAt: firebase.database.ServerValue.TIMESTAMP
                };
                await newGameRef.set(gameData);
                listenForPvpUpdates(newGameRef.key);
            }
            
            pvpGameCard.addEventListener('click', createPvpGame);
            exitPvpGameBtn.addEventListener('click', quitPvpGame);
            modalBtn.addEventListener('click', () => {
                gameResultModal.classList.remove('show');
                if (gameMode === 'pvp') {
                    endAndCleanPvpGame();
                } else {
                    // robot game logic
                }
            });
        }
        
        function switchTab(tabName) {
            Object.values(pages).forEach(page => page.style.display = 'none');
            Object.values(navItems).forEach(item => item.classList.remove('active'));
            bottomNav.style.display = 'flex'; // Show nav by default

            if (pages[tabName]) {
                 pages[tabName].style.display = pages[tabName].classList.contains('game-screen') ? 'flex' : 'block';
            }
            
            // Hide bottom nav for full-screen game pages
            if (tabName === 'robotGame' || tabName === 'pvpGame') {
                bottomNav.style.display = 'none';
            }

            if (navItems[tabName]) navItems[tabName].classList.add('active');
            
            if (tabName === 'invite') loadInvitedUsers();
            if (tabName === 'leaderboard') loadLeaderboard();
        }

        async function initGame() {
            try {
                // ... (existing Telegram.WebApp checks) ...
                
                const tgUser = Telegram.WebApp.initDataUnsafe.user;
                // ... (existing auth logic) ...
                
                const userSnapshot = await userDocRef.get();
                if (!userSnapshot.exists()) {
                    // ... (logic for new user creation, using RTDB set and transactions for inviter) ...
                } else {
                    userData = userSnapshot.val();
                    balance = userData.balance || 0;
                }

                // ... (UI setup for profile pic, balance, etc.) ...
                
                initTicTacToe(); // Initialize game logic

                // *** NEW: Check for start parameter to join a game ***
                const startParam = Telegram.WebApp.initDataUnsafe.start_param;
                if (startParam && startParam.startsWith('game_')) {
                    const gameIdToJoin = startParam.replace('game_', '');
                    loadingScreen.style.opacity = '0';
                    setTimeout(() => {
                        loadingScreen.style.display = 'none';
                        window.joinPvpGame(gameIdToJoin);
                    }, 500);
                } else {
                     // Normal startup
                    loadingScreen.style.opacity = '0';
                    setTimeout(() => {
                        loadingScreen.style.display = 'none';
                        switchTab('game');
                    }, 500);
                }

            } catch (error) {
                console.error('Initialization error:', error);
                loadingScreen.innerHTML = `<p style="color:red; padding: 20px;">Error: ${error.message}.</p>`;
            }
        }

        document.addEventListener('DOMContentLoaded', initGame);
    </script>
</body>
</html>
