<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tap Game</title>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background: #0f0f10;
            color: white;
            height: 100vh;
            overflow: hidden;
        }
        
        /* Loading Screen */
        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #0f0f10;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 100;
            transition: opacity 0.5s ease;
        }
        
        .loading-logo {
            width: 80px;
            height: 80px;
            margin-bottom: 30px;
            background: linear-gradient(135deg, #6e45e2, #88d3ce);
            border-radius: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 36px;
        }
        
        .loading-circle {
            width: 60px;
            height: 60px;
            border: 4px solid rgba(255, 255, 255, 0.1);
            border-top-color: #6e45e2;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Main Game Screen */
        .game-screen {
            display: none;
            height: 100%;
            flex-direction: column;
        }
        
        /* Header */
        .header {
            padding: 15px;
            display: flex;
            justify-content: flex-end;
        }
        
        .profile {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .profile-pic {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #2a2a2b;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
        }
        
        .profile-pic img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .profile-name {
            font-weight: bold;
            font-size: 14px;
        }
        
        /* Balance */
        .balance-container {
            text-align: center;
            margin-top: 20px;
        }
        
        .balance-label {
            font-size: 14px;
            color: #aaa;
            margin-bottom: 5px;
        }
        
        .balance-amount {
            font-size: 36px;
            font-weight: bold;
            background: linear-gradient(to right, #6e45e2, #88d3ce);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        /* Tap Circle */
        .tap-area {
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
        }
        
        .tap-circle {
            width: 280px;
            height: 280px;
            border-radius: 50%;
            background: linear-gradient(135deg, #2a2a2b, #1a1a1b);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
            cursor: pointer;
            transition: transform 0.1s ease;
        }
        
        .tap-circle:active {
            transform: scale(0.95);
        }
        
        .tap-circle-inner {
            width: 240px;
            height: 240px;
            border-radius: 50%;
            background: linear-gradient(135deg, #3a3a3c, #2a2a2b);
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 24px;
            font-weight: bold;
            color: white;
        }
        
        .coin-effect {
            position: absolute;
            width: 30px;
            height: 30px;
            background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="%23FFD700"><path d="M12 2L4 5v6.09c0 5.05 3.41 9.76 8 10.91 4.59-1.15 8-5.86 8-10.91V5l-8-3zm-1.06 13.54L7.4 12l1.41-1.41 2.12 2.12 4.24-4.24 1.41 1.41-5.64 5.66z"/></svg>') no-repeat center;
            background-size: contain;
            opacity: 0;
            pointer-events: none;
            animation: float-up 1s ease-out forwards;
        }
        
        @keyframes float-up {
            0% {
                transform: translateY(0) scale(0.5);
                opacity: 1;
            }
            100% {
                transform: translateY(-100px) scale(1.2);
                opacity: 0;
            }
        }
        
        /* Particles */
        .particles {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }
        
        .particle {
            position: absolute;
            background: linear-gradient(to right, #6e45e2, #88d3ce);
            border-radius: 50%;
            pointer-events: none;
        }
    </style>
</head>
<body>
    <!-- Loading Screen -->
    <div class="loading-screen" id="loadingScreen">
        <div class="loading-logo">ðŸª™</div>
        <div class="loading-circle"></div>
    </div>
    
    <!-- Main Game Screen -->
    <div class="game-screen" id="gameScreen">
        <!-- Header with Profile -->
        <div class="header">
            <div class="profile" id="profile">
                <div class="profile-pic" id="profilePic">
                    <span id="profileInitials">?</span>
                </div>
                <div class="profile-name" id="profileName"></div>
            </div>
        </div>
        
        <!-- Balance Display -->
        <div class="balance-container">
            <div class="balance-label">Your Balance</div>
            <div class="balance-amount" id="balance">0</div>
        </div>
        
        <!-- Tap Circle -->
        <div class="tap-area">
            <div class="particles" id="particles"></div>
            <div class="tap-circle" id="tapCircle">
                <div class="tap-circle-inner">TAP</div>
            </div>
        </div>
    </div>

    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBX3g8wWxcTtwFDsJNJVcjUDIGxMd1L0Rk",
            authDomain: "mytestapp-f6913.firebaseapp.com",
            databaseURL: "https://mytestapp-f6913-default-rtdb.firebaseio.com",
            projectId: "mytestapp-f6913",
            storageBucket: "mytestapp-f6913.firebasestorage.app",
            messagingSenderId: "300150696072",
            appId: "1:300150696072:web:1e29cb5a813d004018573d",
            measurementId: "G-PPDR4TBQF5"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // DOM elements
        const loadingScreen = document.getElementById('loadingScreen');
        const gameScreen = document.getElementById('gameScreen');
        const profilePic = document.getElementById('profilePic');
        const profileInitials = document.getElementById('profileInitials');
        const profileName = document.getElementById('profileName');
        const balanceDisplay = document.getElementById('balance');
        const tapCircle = document.getElementById('tapCircle');
        const particlesContainer = document.getElementById('particles');

        // Game state
        let balance = 0;
        let firebaseUser = null;
        let userDocRef = null;
        let coinsPerTap = 1;

        // Pad Telegram ID for password
        function padTelegramId(id) {
            return String(id).padStart(6, '0');
        }

        // Create coin effect
        function createCoinEffect(x, y) {
            const coin = document.createElement('div');
            coin.className = 'coin-effect';
            coin.style.left = `${x - 15}px`;
            coin.style.top = `${y - 15}px`;
            document.body.appendChild(coin);
            
            // Remove after animation
            setTimeout(() => {
                coin.remove();
            }, 1000);
        }

        // Create particles
        function createParticles(x, y) {
            for (let i = 0; i < 10; i++) {
                const particle = document.createElement('div');
                particle.className = 'particle';
                
                const size = Math.random() * 10 + 5;
                particle.style.width = `${size}px`;
                particle.style.height = `${size}px`;
                
                particle.style.left = `${x}px`;
                particle.style.top = `${y}px`;
                
                particlesContainer.appendChild(particle);
                
                // Animate particle
                const angle = Math.random() * Math.PI * 2;
                const velocity = Math.random() * 5 + 2;
                const lifetime = Math.random() * 1000 + 500;
                
                let startTime = Date.now();
                
                function animate() {
                    const elapsed = Date.now() - startTime;
                    const progress = elapsed / lifetime;
                    
                    if (progress >= 1) {
                        particle.remove();
                        return;
                    }
                    
                    const distance = velocity * elapsed / 20;
                    const currentX = x + Math.cos(angle) * distance;
                    const currentY = y + Math.sin(angle) * distance;
                    const opacity = 1 - progress;
                    const scale = 1 - progress * 0.5;
                    
                    particle.style.transform = `translate(${currentX - x}px, ${currentY - y}px) scale(${scale})`;
                    particle.style.opacity = opacity;
                    
                    requestAnimationFrame(animate);
                }
                
                requestAnimationFrame(animate);
            }
        }

        // Handle tap
        function handleTap(e) {
            // Get tap position
            const rect = tapCircle.getBoundingClientRect();
            const centerX = rect.left + rect.width / 2;
            const centerY = rect.top + rect.height / 2;
            const clientX = e.clientX || e.touches[0].clientX;
            const clientY = e.clientY || e.touches[0].clientY;
            
            // Create effects
            createCoinEffect(clientX, clientY);
            createParticles(clientX, clientY);
            
            // Update balance
            balance += coinsPerTap;
            balanceDisplay.textContent = balance.toLocaleString();
            
            // Haptic feedback
            if (window.Telegram?.WebApp?.HapticFeedback) {
                Telegram.WebApp.HapticFeedback.impactOccurred('light');
            }
            
            // Save balance to Firestore
            if (userDocRef) {
                userDocRef.update({
                    balance: firebase.firestore.FieldValue.increment(coinsPerTap),
                    lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                }).catch(error => {
                    console.error('Error updating balance:', error);
                });
            }
        }

        // Initialize game
        async function initGame() {
            try {
                // 1. Initialize Telegram WebApp
                if (!window.Telegram?.WebApp) {
                    throw new Error('Please open in Telegram');
                }
                
                Telegram.WebApp.ready();
                Telegram.WebApp.expand();
                
                // 2. Get Telegram user
                const tgUser = Telegram.WebApp.initDataUnsafe?.user;
                if (!tgUser?.id || !tgUser?.username) {
                    throw new Error('Telegram user data missing');
                }
                
                // 3. Authenticate with Firebase
                const email = `${tgUser.username}@telegram.user`;
                const password = padTelegramId(tgUser.id);
                
                try {
                    // First try to create account (since we're new)
                    const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                    firebaseUser = userCredential.user;
                } catch (createError) {
                    if (createError.code === 'auth/email-already-in-use') {
                        // If user exists, sign in
                        const userCredential = await auth.signInWithEmailAndPassword(email, password);
                        firebaseUser = userCredential.user;
                    } else {
                        throw createError;
                    }
                }
                
                // 4. Setup Firestore document
                userDocRef = db.collection('users').doc(firebaseUser.uid);
                
                // Get or create user data
                const userDoc = await userDocRef.get();
                
                if (!userDoc.exists) {
                    // New user - create document
                    await userDocRef.set({
                        id: tgUser.id,
                        first_name: tgUser.first_name || '',
                        last_name: tgUser.last_name || '',
                        username: tgUser.username || '',
                        photo_url: tgUser.photo_url || '',
                        balance: 0,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                        lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                    });
                } else {
                    // Existing user - load balance
                    balance = userDoc.data().balance || 0;
                }
                
                // 5. Setup UI
                // Profile picture
                if (tgUser.photo_url) {
                    profilePic.innerHTML = `<img src="${tgUser.photo_url}" alt="Profile">`;
                } else {
                    const initials = (tgUser.first_name?.[0] || '') + (tgUser.last_name?.[0] || '');
                    profileInitials.textContent = initials || '?';
                }
                
                // Profile name
                profileName.textContent = tgUser.first_name || 'Player';
                
                // Balance
                balanceDisplay.textContent = balance.toLocaleString();
                
                // 6. Switch to game screen
                loadingScreen.style.opacity = '0';
                setTimeout(() => {
                    loadingScreen.style.display = 'none';
                    gameScreen.style.display = 'flex';
                }, 500);
                
                // 7. Setup tap listener
                tapCircle.addEventListener('click', handleTap);
                tapCircle.addEventListener('touchstart', handleTap);
                
            } catch (error) {
                console.error('Initialization error:', error);
                alert(`Error: ${error.message}`);
            }
        }

        // Start the game
        document.addEventListener('DOMContentLoaded', initGame);
    </script>
</body>
</html>
