<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tap Game</title>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" xintegrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background: #1b1e2e;
            color: white;
            height: 100vh;
            overflow: hidden;
        }
        
        /* Loading Screen */
        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #0f0f10;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 100;
            transition: opacity 0.5s ease;
        }
        
        .loading-circle {
            width: 60px;
            height: 60px;
            border: 4px solid rgba(255, 255, 255, 0.1);
            border-top-color: #6e45e2;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Main Game Screen */
        .game-screen {
            display: none;
            height: calc(100% - 70px); /* Adjusted for nav bar */
            flex-direction: column;
        }
        
        /* Header */
        .header {
            padding: 15px;
            display: flex;
            justify-content: flex-end;
        }
        
        .profile {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .profile-pic {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #2a2a2b;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
        }
        
        .profile-pic img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .profile-name {
            font-weight: bold;
            font-size: 14px;
        }
        
        /* Balance */
        .balance-container {
            text-align: center;
            margin-top: 20px;
        }
        
        .balance-label {
            font-size: 14px;
            color: #aaa;
            margin-bottom: 5px;
        }
        
        .balance-amount {
            font-size: 36px;
            font-weight: bold;
            background: linear-gradient(to right, #6e45e2, #88d3ce);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        /* Tap Circle */
        .tap-area {
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
        }
        
        .tap-circle {
            width: 280px;
            height: 280px;
            border-radius: 50%;
            background: linear-gradient(135deg, #2a2a2b, #1a1a1b);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
            cursor: pointer;
            transition: transform 0.1s ease;
        }
        
        .tap-circle:active {
            transform: scale(0.95);
        }
        
        .tap-circle-inner {
            width: 240px;
            height: 240px;
            border-radius: 50%;
            background: linear-gradient(135deg, #3a3a3c, #2a2a2b);
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 24px;
            font-weight: bold;
            color: white;
        }
        
        .coin-effect {
            position: absolute;
            font-size: 24px;
            font-weight: bold;
            color: #FFD700;
            opacity: 0;
            pointer-events: none;
            animation: float-up 1s ease-out forwards;
        }
        
        @keyframes float-up {
            0% {
                transform: translateY(0) scale(0.8);
                opacity: 1;
            }
            100% {
                transform: translateY(-100px) scale(1.2);
                opacity: 0;
            }
        }
        
        /* Page Styles */
        .page {
             display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: calc(100% - 70px); /* Adjusted for nav bar height */
            background: #0f0f10;
            padding: 20px;
            overflow-y: auto;
            z-index: 5;
        }

        .page-header {
            text-align: center;
            margin-bottom: 20px;
        }

        .page-header h2 {
            font-size: 24px;
            margin-bottom: 8px;
        }

        .page-header p {
            color: #aaa;
            font-size: 14px;
        }

        /* Invite Screen Specifics */
        .invite-link-container {
            display: flex;
            margin-bottom: 20px;
            background: #1a1a1b;
            border-radius: 12px;
            overflow: hidden;
        }

        .invite-link {
            flex: 1;
            padding: 15px;
            font-size: 14px;
            word-break: break-all;
            color: #88d3ce;
        }

        .copy-btn {
            background: #6e45e2;
            color: white;
            border: none;
            padding: 0 20px;
            font-weight: bold;
            cursor: pointer;
            transition: background 0.2s ease;
        }

        .copy-btn:active {
            background: #5a35c0;
        }

        .share-buttons {
            display: flex;
            justify-content: center;
            margin-bottom: 20px;
        }

        .share-btn {
            background: #0088cc;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 12px;
            font-size: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .share-btn:active {
            background: #006699;
        }
        
        .list-container {
            background: #1a1a1b;
            border-radius: 12px;
            padding: 15px;
        }

        .list-container h3 {
            margin-bottom: 15px;
            font-size: 18px;
        }
        
        .list-scrollable {
            max-height: 40vh;
            overflow-y: auto;
        }

        .user-card, .leaderboard-card {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid #2a2a2b;
        }

        .user-card:last-child, .leaderboard-card:last-child {
            border-bottom: none;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 12px;
            flex-grow: 1;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #2a2a2b;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
            flex-shrink: 0;
        }

        .user-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .user-name {
            font-weight: bold;
            font-size: 14px;
        }

        .user-balance {
            color: #88d3ce;
            font-weight: bold;
            flex-shrink: 0;
        }

        .empty-state {
            color: #666;
            text-align: center;
            padding: 20px 0;
        }
        
        /* Leaderboard Styles */
        .leaderboard-card .rank {
            font-size: 18px;
            font-weight: bold;
            width: 40px;
            text-align: center;
            color: #aaa;
            flex-shrink: 0;
        }
        
        .rank-1, .rank-2, .rank-3 {
            font-size: 24px;
        }
        .rank-1 { color: #FFD700; } /* Gold */
        .rank-2 { color: #C0C0C0; } /* Silver */
        .rank-3 { color: #CD7F32; } /* Bronze */
        
        /* Bottom Navigation */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background: #1a1a1b;
            display: flex;
            padding-top: 10px;
            padding-bottom: 10px;
            border-top: 1px solid #2a2a2b;
            z-index: 10;
        }

        .nav-item {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: #888;
            cursor: pointer;
            transition: color 0.2s ease;
        }

        .nav-item.active {
            color: #6e45e2;
        }

        .nav-icon {
            font-size: 24px;
            margin-bottom: 4px;
        }

        .nav-label {
            font-size: 12px;
        }
        
        /* Games Tab Styles */
        .games-container {
            display: flex;
            flex-direction: column;
            gap: 20px;
            padding: 0 10px;
        }
        
        .game-card {
            background: #1a1a1b;
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 6px 16px rgba(0,0,0,0.3);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            cursor: pointer;
        }
        
        .game-card:active {
            transform: scale(0.98);
        }
        
        .game-card-header {
            padding: 20px;
            display: flex;
            align-items: center;
            gap: 15px;
            background: linear-gradient(90deg, #6e45e2, #88d3ce);
        }
        
        .game-icon {
            font-size: 28px;
            background: rgba(255,255,255,0.2);
            width: 50px;
            height: 50px;
            border-radius: 12px;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .game-title {
            font-size: 18px;
            font-weight: bold;
        }
        
        .game-subtitle {
            font-size: 14px;
            opacity: 0.9;
        }
        
        .game-card-body {
            padding: 20px;
        }
        
        .game-info {
            display: flex;
            justify-content: space-between;
            margin-bottom: 15px;
            font-size: 14px;
        }
        
        .game-info-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .game-info-item i {
            color: #6e45e2;
        }
        
        .prize-badge {
            background: linear-gradient(90deg, #ffd700, #ff9800);
            color: #000;
            padding: 5px 12px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 14px;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }
        
        /* Tic Tac Toe Game Styles */
        .tic-tac-toe-container {
            display: flex;
            flex-direction: column;
            height: 100%;
        }
        
        .game-header {
            padding: 20px;
            text-align: center;
            border-bottom: 1px solid #2a2a2b;
        }
        
        .game-header h2 {
            font-size: 24px;
            margin-bottom: 5px;
        }
        
        .game-status {
            font-size: 16px;
            color: #88d3ce;
            min-height: 24px;
        }
        
        .opponent-info {
            display: flex;
            justify-content: space-around;
            align-items: center;
            padding: 15px;
            margin: 10px 0;
            background: #1a1a1b;
            border-radius: 12px;
            position: relative;
        }
        
        .player-card {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            transition: transform 0.5s ease-in-out, opacity 0.5s ease-in-out;
        }
        
        .player-card.slide-in-left {
            animation: slideInLeft 0.5s forwards;
        }
        .player-card.slide-in-right {
            animation: slideInRight 0.5s forwards;
        }
        
        @keyframes slideInLeft {
            from { transform: translateX(-100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        .player-card.active-turn .player-avatar {
             box-shadow: 0 0 15px #6e45e2, 0 0 5px #fff;
        }
        
        .player-avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: #2a2a2b;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
            position: relative;
            transition: box-shadow 0.3s ease;
        }
        
        .player-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .player-mark {
            position: absolute;
            bottom: -5px;
            right: -5px;
            background: #6e45e2;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-weight: bold;
            font-size: 18px;
            border: 2px solid #1a1a1b;
        }
        
        .player-name {
            font-weight: bold;
            max-width: 100px;
            text-overflow: ellipsis;
            overflow: hidden;
            white-space: nowrap;
        }
        
        .vs {
            font-size: 20px;
            font-weight: bold;
            color: #888;
            transition: transform 0.5s ease, opacity 0.5s ease;
        }
        .vs.matched {
            transform: scale(1.5);
            animation: vs-pulse 1s infinite;
        }
        @keyframes vs-pulse {
            50% { color: #fff; }
        }
        
        
        .board-container {
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
            perspective: 1000px;
        }
        
        .game-board {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            grid-gap: 10px;
            width: 300px;
            height: 300px;
            background: #2a2a2b;
            border-radius: 12px;
            padding: 10px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            transition: transform 0.5s ease-in-out;
            transform: scale(0);
        }
        .game-board.show {
            transform: scale(1);
        }
        
        .cell {
            background: #1a1a1b;
            border-radius: 8px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 48px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .cell:hover {
            background: #252528;
        }
        
        .cell.x {
            color: #6e45e2;
        }
        
        .cell.o {
            color: #88d3ce;
        }
        
        .cell.win {
            animation: win-cell 1s ease infinite;
        }
        
        @keyframes win-cell {
            0%, 100% { background: rgba(110, 69, 226, 0.1); }
            50% { background: rgba(110, 69, 226, 0.3); }
        }
        
        .game-controls {
            padding: 20px;
            display: flex;
            justify-content: center;
            gap: 15px;
        }
        
        .game-btn {
            background: #6e45e2;
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 12px;
            font-size: 16px;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            transition: all 0.2s;
            transform: scale(1);
        }
        
        .game-btn:active {
            transform: scale(0.95);
        }
        
        .game-btn.exit {
            background: #2a2a2b;
        }
        
        .game-btn:disabled {
            background: #444;
            cursor: not-allowed;
            opacity: 0.7;
        }
        
        
        /* P2P Lobby */
        .lobby-container {
            padding: 20px;
            text-align: center;
        }
        
        .lobby-status {
            background: #1a1a1b;
            padding: 30px 20px;
            border-radius: 16px;
            margin: 20px 0;
            font-size: 18px;
        }
        
        .searching-indicator {
            display: flex;
            justify-content: center;
            gap: 5px;
            margin: 20px 0;
        }
        
        .dot {
            width: 10px;
            height: 10px;
            background: #6e45e2;
            border-radius: 50%;
            animation: pulse 1.5s infinite;
        }
        
        .dot:nth-child(2) {
            animation-delay: 0.3s;
        }
        
        .dot:nth-child(3) {
            animation-delay: 0.6s;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 0.3; transform: scale(0.8); }
            50% { opacity: 1; transform: scale(1); }
        }
        
        /* Game Result Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 20;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }
        
        .modal-overlay.show {
            opacity: 1;
            pointer-events: all;
        }
        
        .modal-content {
            background: #1a1a1b;
            border-radius: 20px;
            width: 90%;
            max-width: 400px;
            padding: 30px;
            text-align: center;
            transform: translateY(20px);
            transition: transform 0.3s ease;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            border: 1px solid #2a2a2b;
        }
        
        .modal-overlay.show .modal-content {
            transform: translateY(0);
        }
        
        .modal-icon {
            font-size: 60px;
            margin-bottom: 20px;
            animation: icon-pop-in 0.5s ease-out;
        }

        @keyframes icon-pop-in {
            from { transform: scale(0.5); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }
        
        .modal-icon.win {
            color: #FFD700;
        }
        
        .modal-icon.draw {
            color: #88d3ce;
        }
        
        .modal-icon.loss {
            color: #c94040;
        }
        
        .modal-title {
            font-size: 28px;
            margin-bottom: 10px;
        }
        
        .modal-message {
            font-size: 18px;
            margin-bottom: 20px;
            color: #aaa;
        }
        
        .prize-amount {
            font-size: 24px;
            font-weight: bold;
            color: #FFD700;
            margin: 20px 0;
        }
        
        .modal-btn {
            background: #6e45e2;
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 12px;
            font-size: 18px;
            font-weight: bold;
            width: 100%;
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .modal-btn:active {
            background: #5a35c0;
        }
    </style>
</head>
<body>
    <!-- Loading Screen -->
    <div class="loading-screen" id="loadingScreen">
        <div class="loading-circle"></div>
        <p>Loading...</p>
    </div>
    
    <!-- Main Game Screen -->
    <div class="game-screen" id="gameScreen">
        <div class="header">
            <div class="profile" id="profile">
                <div class="profile-pic" id="profilePic"><span>?</span></div>
                <div class="profile-name" id="profileName"></div>
            </div>
        </div>
        <div class="balance-container">
            <div class="balance-label">Your Balance</div>
            <div class="balance-amount" id="balance">0</div>
        </div>
        <div class="tap-area">
            <div class="tap-circle" id="tapCircle">
                <div class="tap-circle-inner">TAP</div>
            </div>
        </div>
    </div>

    <!-- Invite Screen -->
    <div class="page" id="inviteScreen">
        <div class="page-header">
            <h2>Invite Friends</h2>
            <p>Earn bonuses when your friends join and play</p>
        </div>
        <div class="invite-link-container">
            <div class="invite-link" id="inviteLink">Loading...</div>
            <button class="copy-btn" id="copyBtn">Copy</button>
        </div>
        <div class="share-buttons">
            <button class="share-btn" id="shareTelegramBtn">
                <i class="fab fa-telegram-plane"></i> Share via Telegram
            </button>
        </div>
        <div class="list-container">
            <h3>Your Team</h3>
            <div class="list-scrollable" id="usersList">
                <div class="empty-state">No invited users yet</div>
            </div>
        </div>
    </div>
    
    <!-- Leaderboard Screen -->
    <div class="page" id="leaderboardScreen">
        <div class="page-header">
            <h2>üèÜ Leaderboard üèÜ</h2>
        </div>
        <div class="list-container">
             <div class="list-scrollable" id="leaderboardList">
                <div class="empty-state">Loading...</div>
             </div>
        </div>
    </div>
    
    <!-- Games Screen -->
    <div class="page" id="gamesScreen">
        <div class="page-header">
            <h2>üéÆ Mini Games üéÆ</h2>
            <p>Play games to earn extra coins!</p>
        </div>
        <div class="games-container">
            <div class="game-card" id="robotGameCard">
                <div class="game-card-header">
                    <div class="game-icon">
                        <i class="fas fa-robot"></i>
                    </div>
                    <div>
                        <div class="game-title">Tic Tac Toe vs Robot</div>
                        <div class="game-subtitle">Test your skills against our AI</div>
                    </div>
                </div>
                <div class="game-card-body">
                    <div class="game-info">
                        <div class="game-info-item">
                            <i class="fas fa-trophy"></i> Win Prize: 100 Coins
                        </div>
                        <div class="game-info-item">
                            <i class="fas fa-user"></i> Difficulty: Medium
                        </div>
                    </div>
                    <div class="prize-badge">
                        <i class="fas fa-coins"></i> Win up to 100 coins!
                    </div>
                </div>
            </div>
            
            <div class="game-card" id="pvpGameCard">
                <div class="game-card-header">
                    <div class="game-icon">
                        <i class="fas fa-users"></i>
                    </div>
                    <div>
                        <div class="game-title">Tic Tac Toe vs Player</div>
                        <div class="game-subtitle">Challenge real opponents</div>
                    </div>
                </div>
                <div class="game-card-body">
                    <div class="game-info">
                        <div class="game-info-item">
                            <i class="fas fa-trophy"></i> Win Prize: 500 Coins
                        </div>
                        <div class="game-info-item">
                            <i class="fas fa-clock"></i> Avg. Wait: 20s
                        </div>
                    </div>
                    <div class="prize-badge">
                        <i class="fas fa-coins"></i> Win 500 coins per match!
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Robot Game Screen -->
    <div class="page" id="robotGameScreen">
        <div class="game-header">
            <h2>Tic Tac Toe vs Robot</h2>
            <div class="game-status" id="robotGameStatus">Your turn! You are playing as X</div>
        </div>
        
        <div class="opponent-info">
            <div class="player-card">
                <div class="player-avatar" id="playerAvatar">
                    <span>?</span>
                    <div class="player-mark">X</div>
                </div>
                <div class="player-name" id="playerName">You</div>
            </div>
            
            <div class="vs">VS</div>
            
            <div class="player-card">
                <div class="player-avatar">
                    <i class="fas fa-robot" style="font-size: 30px;"></i>
                    <div class="player-mark">O</div>
                </div>
                <div class="player-name">Robot</div>
            </div>
        </div>
        
        <div class="board-container">
            <div class="game-board" id="robotBoard">
                <div class="cell" data-index="0"></div>
                <div class="cell" data-index="1"></div>
                <div class="cell" data-index="2"></div>
                <div class="cell" data-index="3"></div>
                <div class="cell" data-index="4"></div>
                <div class="cell" data-index="5"></div>
                <div class="cell" data-index="6"></div>
                <div class="cell" data-index="7"></div>
                <div class="cell" data-index="8"></div>
            </div>
        </div>
        
        <div class="game-controls">
            <button class="game-btn exit" id="exitRobotGame">
                <i class="fas fa-arrow-left"></i> Exit
            </button>
            <button class="game-btn" id="restartRobotGame">
                <i class="fas fa-redo"></i> Restart
            </button>
        </div>
    </div>
    
    <!-- P2P Game Screen -->
    <div class="page" id="pvpGameScreen">
        <div class="game-header">
            <h2>Tic Tac Toe vs Player</h2>
            <div class="game-status" id="pvpGameStatus">Searching for opponent...</div>
        </div>
        
        <div class="opponent-info">
            <div class="player-card" id="player1Card">
                <div class="player-avatar" id="player1Avatar">
                    <span>?</span>
                </div>
                 <div class="player-mark" id="player1Mark">?</div>
                <div class="player-name" id="player1Name">You</div>
            </div>
            
            <div class="vs" id="vsText">VS</div>
            
            <div class="player-card" id="player2Card">
                <div class="player-avatar" id="player2Avatar">
                    <i class="fas fa-user-clock" style="font-size: 24px;"></i>
                </div>
                 <div class="player-mark" id="player2Mark">?</div>
                <div class="player-name" id="player2Name">Searching...</div>
            </div>
        </div>
        
        <div class="lobby-container" id="pvpLobby">
            <div class="lobby-status">
                <i class="fas fa-search" style="font-size: 36px; margin-bottom: 15px;"></i>
                <div id="lobbyMessage">Looking for an opponent</div>
                <div class="searching-indicator">
                    <div class="dot"></div>
                    <div class="dot"></div>
                    <div class="dot"></div>
                </div>
                <p style="margin-top: 20px; color: #888;">Please wait...</p>
            </div>
        </div>
        
        <div class="board-container" id="pvpBoardContainer" style="display: none;">
            <div class="game-board" id="pvpBoard">
                <div class="cell" data-index="0"></div><div class="cell" data-index="1"></div><div class="cell" data-index="2"></div>
                <div class="cell" data-index="3"></div><div class="cell" data-index="4"></div><div class="cell" data-index="5"></div>
                <div class="cell" data-index="6"></div><div class="cell" data-index="7"></div><div class="cell" data-index="8"></div>
            </div>
        </div>
        
        <div class="game-controls">
            <button class="game-btn exit" id="exitPvpGame"><i class="fas fa-times"></i> Cancel</button>
            <button class="game-btn" id="startPvpGameBtn" style="display: none;"><i class="fas fa-play"></i> Start Game</button>
        </div>
    </div>
    
    <!-- Game Result Modal -->
    <div class="modal-overlay" id="gameResultModal">
        <div class="modal-content">
            <div class="modal-icon" id="resultIcon"></div>
            <h2 class="modal-title" id="resultTitle"></h2>
            <p class="modal-message" id="resultMessage"></p>
            <div class="prize-amount" id="prizeAmount"></div>
            <button class="modal-btn" id="modalBtn">Continue</button>
        </div>
    </div>

    <!-- Bottom Navigation -->
    <div class="bottom-nav">
        <div class="nav-item active" id="navGame">
           <div class="nav-icon"><i class="fas fa-gamepad"></i></div>
            <div class="nav-label">Game</div>
        </div>
        <div class="nav-item" id="navInvite">
           <div class="nav-icon"><i class="fas fa-user-plus"></i></div>
            <div class="nav-label">Invite</div>
        </div>
        <div class="nav-item" id="navLeaderboard">
            <div class="nav-icon"><i class="fas fa-trophy"></i></div>
            <div class="nav-label">Leaders</div>
        </div>
        <div class="nav-item" id="navGames">
            <div class="nav-icon"><i class="fas fa-dice"></i></div>
            <div class="nav-label">Games</div>
        </div>
    </div>

    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBX3g8wWxcTtwFDsJNJVcjUDIGxMd1L0Rk",
            authDomain: "mytestapp-f6913.firebaseapp.com",
            databaseURL: "https://mytestapp-f6913-default-rtdb.firebaseio.com",
            projectId: "mytestapp-f6913",
            storageBucket: "mytestapp-f6913.appspot.com",
            messagingSenderId: "300150696072",
            appId: "1:300150696072:web:1e29cb5a813d004018573d",
            measurementId: "G-PPDR4TBQF5"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // DOM elements
        const loadingScreen = document.getElementById('loadingScreen');
        const gameScreen = document.getElementById('gameScreen');
        const profilePic = document.getElementById('profilePic');
        const profileName = document.getElementById('profileName');
        const balanceDisplay = document.getElementById('balance');
        const tapCircle = document.getElementById('tapCircle');
        
        // Navigation
        const navItems = {
            game: document.getElementById('navGame'),
            invite: document.getElementById('navInvite'),
            leaderboard: document.getElementById('navLeaderboard'),
            games: document.getElementById('navGames')
        };
        const pages = {
            game: gameScreen,
            invite: document.getElementById('inviteScreen'),
            leaderboard: document.getElementById('leaderboardScreen'),
            games: document.getElementById('gamesScreen'),
            robotGame: document.getElementById('robotGameScreen'),
            pvpGame: document.getElementById('pvpGameScreen')
        };

        // Invite Screen Elements
        const inviteLink = document.getElementById('inviteLink');
        const copyBtn = document.getElementById('copyBtn');
        const usersList = document.getElementById('usersList');
        const shareTelegramBtn = document.getElementById('shareTelegramBtn');

        // Leaderboard element
        const leaderboardList = document.getElementById('leaderboardList');

        // Game state
        let balance = 0;
        let firebaseUser = null;
        let userDocRef = null;
        let userData = {};
        let coinsPerTap = 1;
        let invitedBy = null;
        const botUsername = 'guvuhgy7bot/kuyti';

        // Pad Telegram ID for a simple password
        function padTelegramId(id) {
            return String(id).padStart(6, '0');
        }
        
        // Function to send a message via Telegram bot
        async function sendTelegramMessage(chatId, text) {
            const botToken = '8162193180:AAF-ZGiIWFL-3tLyrkpaaLO2Y48RmrHRcwE';
            const url = `https://api.telegram.org/bot${botToken}/sendMessage`;
            try {
                await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        chat_id: chatId,
                        text: text,
                        parse_mode: 'HTML'
                    })
                });
            } catch (error) {
                console.error('Error sending Telegram message:', error);
            }
        }

        // Create coin effect on tap
        function createCoinEffect(x, y) {
            const coin = document.createElement('div');
            coin.className = 'coin-effect';
            coin.textContent = `+${coinsPerTap}`;
            coin.style.left = `${x - 15}px`;
            coin.style.top = `${y - 15}px`;
            document.body.appendChild(coin);
            
            setTimeout(() => coin.remove(), 1000);
        }

        // Handle tap event
        function handleTap(e) {
            e.preventDefault(); // Prevents double tap zoom
            const clientX = e.clientX || e.touches[0].clientX;
            const clientY = e.clientY || e.touches[0].clientY;
            
            createCoinEffect(clientX, clientY);
            
            balance += coinsPerTap;
            balanceDisplay.textContent = balance.toLocaleString();
            
            if (window.Telegram?.WebApp?.HapticFeedback) {
                Telegram.WebApp.HapticFeedback.impactOccurred('light');
            }
            
            if (userDocRef) {
                userDocRef.update({
                    balance: firebase.firestore.FieldValue.increment(coinsPerTap)
                }).catch(error => console.error('Error updating balance:', error));
            }
        }

        // Setup invite link and buttons
        function setupInviteLink(userId) {
            const link = `https://t.me/${botUsername}?startapp=invite_${userId}`;
            inviteLink.textContent = link;
            
            copyBtn.addEventListener('click', () => {
                navigator.clipboard.writeText(link).then(() => {
                    copyBtn.textContent = 'Copied!';
                    setTimeout(() => { copyBtn.textContent = 'Copy'; }, 2000);
                });
            });

            shareTelegramBtn.addEventListener('click', () => {
                const message = `Join this awesome Tap Game and get bonus coins! üéÆüí∞\n\nUse my invite link: ${link}`;
                const telegramShareUrl = `https://t.me/share/url?url=${encodeURIComponent(link)}&text=${encodeURIComponent(message)}`;
                window.open(telegramShareUrl, '_blank');
            });
        }
        
        // Load Leaderboard data
        async function loadLeaderboard() {
            leaderboardList.innerHTML = '<div class="empty-state">Loading...</div>';
            try {
                const querySnapshot = await db.collection('users').orderBy('balance', 'desc').limit(100).get();
                if (querySnapshot.empty) {
                    leaderboardList.innerHTML = '<div class="empty-state">Be the first on the leaderboard!</div>';
                    return;
                }

                leaderboardList.innerHTML = '';
                let rank = 1;
                querySnapshot.forEach(doc => {
                    const userData = doc.data();
                    const card = document.createElement('div');
                    card.className = 'leaderboard-card';
                    
                    let rankDisplay = rank;
                    let rankClass = `rank-${rank}`;
                    if(rank === 1) rankDisplay = 'ü•á';
                    if(rank === 2) rankDisplay = 'ü•à';
                    if(rank === 3) rankDisplay = 'ü•â';

                    card.innerHTML = `
                        <div class="rank ${rank > 3 ? '' : rankClass}">${rankDisplay}</div>
                        <div class="user-info">
                            <div class="user-avatar">${userData.photo_url ? `<img src="${userData.photo_url}" alt="">` : (userData.first_name?.[0] || '?')}</div>
                            <div class="user-name">${userData.first_name || 'User'}</div>
                        </div>
                        <div class="user-balance">${(userData.balance || 0).toLocaleString()}</div>
                    `;
                    leaderboardList.appendChild(card);
                    rank++;
                });
            } catch (error) {
                console.error("Error loading leaderboard:", error);
                leaderboardList.innerHTML = '<div class="empty-state">Could not load leaderboard.</div>';
            }
        }

        // Load invited users
        async function loadInvitedUsers() {
            usersList.innerHTML = '<div class="empty-state">Loading team...</div>';
            const userDoc = await userDocRef.get();
            const invitedUserIds = userDoc.data().invitedUsers || [];
            
            if (invitedUserIds.length === 0) {
                usersList.innerHTML = '<div class="empty-state">You haven\'t invited anyone yet.</div>';
                return;
            }
            
            usersList.innerHTML = '';
            for (const userId of invitedUserIds) {
                try {
                    const invitedUserDoc = await db.collection('users').doc(userId).get();
                    if (invitedUserDoc.exists) {
                        const userData = invitedUserDoc.data();
                        const card = document.createElement('div');
                        card.className = 'user-card';
                        card.innerHTML = `
                            <div class="user-info">
                                <div class="user-avatar">${userData.photo_url ? `<img src="${userData.photo_url}" alt="">` : (userData.first_name?.[0] || '?')}</div>
                                <div class="user-name">${userData.first_name || 'User'}</div>
                            </div>
                            <div class="user-balance">${(userData.balance || 0).toLocaleString()}</div>
                        `;
                        usersList.appendChild(card);
                    }
                } catch (error) {
                    console.error('Error loading invited user data:', error);
                }
            }
        }
        
        let pvpGameUnsubscribe = null;
        let currentGameId = null;
        let matchmakingTimeout = null;

        // This function handles switching between different pages/tabs of the app.
        function switchTab(tabName) {
            // Hide all pages first
            Object.keys(pages).forEach(key => {
                pages[key].style.display = 'none';
            });
            
            // Deactivate all navigation items
            Object.keys(navItems).forEach(key => {
                navItems[key].classList.remove('active');
            });
            
            // Show the correct page and activate the corresponding nav item
            if (tabName === 'game') {
                pages.game.style.display = 'flex';
                navItems.game.classList.add('active');
            } else if (tabName === 'robotGame' || tabName === 'pvpGame') {
                pages[tabName].style.display = 'block';
                navItems.games.classList.add('active'); // Keep 'Games' tab active for sub-pages
            } else {
                pages[tabName].style.display = 'block';
                navItems[tabName].classList.add('active');
            }

            // Load data for specific tabs when they are opened
            if (tabName === 'invite') loadInvitedUsers();
            if (tabName === 'leaderboard') loadLeaderboard();
        }

        // Tic Tac Toe Game Logic
        function initTicTacToe() {
            const robotGameCard = document.getElementById('robotGameCard');
            const pvpGameCard = document.getElementById('pvpGameCard');
            
            // Robot game elements
            const robotBoard = document.getElementById('robotBoard');
            const robotGameStatus = document.getElementById('robotGameStatus');
            const restartRobotGameBtn = document.getElementById('restartRobotGame');
            const exitRobotGameBtn = document.getElementById('exitRobotGame');
            
            // PvP game elements
            const pvpGameStatus = document.getElementById('pvpGameStatus');
            const pvpLobby = document.getElementById('pvpLobby');
            const lobbyMessage = document.getElementById('lobbyMessage');
            const pvpBoardContainer = document.getElementById('pvpBoardContainer');
            const pvpBoard = document.getElementById('pvpBoard');
            const exitPvpGameBtn = document.getElementById('exitPvpGame');
            const startPvpGameBtn = document.getElementById('startPvpGameBtn');
            const player1Card = document.getElementById('player1Card');
            const player2Card = document.getElementById('player2Card');
            const player1Avatar = document.getElementById('player1Avatar');
            const player2Avatar = document.getElementById('player2Avatar');
            const player1Name = document.getElementById('player1Name');
            const player2Name = document.getElementById('player2Name');
            const player1Mark = document.getElementById('player1Mark');
            const player2Mark = document.getElementById('player2Mark');
            const vsText = document.getElementById('vsText');

            // Result modal elements
            const gameResultModal = document.getElementById('gameResultModal');
            const resultIcon = document.getElementById('resultIcon');
            const resultTitle = document.getElementById('resultTitle');
            const resultMessage = document.getElementById('resultMessage');
            const prizeAmount = document.getElementById('prizeAmount');
            const modalBtn = document.getElementById('modalBtn');
            
            let gameActive = true;
            let gameState = ['', '', '', '', '', '', '', '', ''];
            const winningCombinations = [
                [0, 1, 2], [3, 4, 5], [6, 7, 8], // rows
                [0, 3, 6], [1, 4, 7], [2, 5, 8], // columns
                [0, 4, 8], [2, 4, 6]             // diagonals
            ];
            
            let gameMode = null;
            
            // **** REAL-TIME PVP LOGIC ****
            async function handlePvpCellClick(e, gameData) {
                const cell = e.target;
                const index = parseInt(cell.getAttribute('data-index'));

                if (gameData.board[index] !== '' || !gameData.gameActive || gameData.currentPlayerId !== firebaseUser.uid) {
                    return; // Not your turn or cell is taken
                }

                const newBoard = [...gameData.board];
                newBoard[index] = gameData.players[firebaseUser.uid].mark;
                
                const nextPlayerId = gameData.player1Id === firebaseUser.uid ? gameData.player2Id : gameData.player1Id;

                const updates = {
                    board: newBoard,
                    currentPlayerId: nextPlayerId
                };
                
                // Check for win/draw
                const winInfo = checkWin(newBoard, gameData.players[firebaseUser.uid].mark);
                if (winInfo.hasWinner) {
                    updates.winnerId = firebaseUser.uid;
                    updates.gameActive = false;
                } else if (!newBoard.includes('')) { // Draw
                    updates.winnerId = 'draw';
                    updates.gameActive = false;
                }

                await db.collection('games').doc(currentGameId).update(updates);
            }
            
            async function handleMatchFound(gameData) {
                 clearTimeout(matchmakingTimeout);
                 matchmakingTimeout = null;
                 
                 pvpGameStatus.textContent = 'Opponent found!';
                 lobbyMessage.textContent = 'Opponent found!';
                 
                 player2Card.classList.add('slide-in-right');
                 vsText.classList.add('matched');

                 const myId = firebaseUser.uid;
                 const opponentId = gameData.player1Id === myId ? gameData.player2Id : gameData.player1Id;
                 
                 startPvpGameBtn.style.display = 'inline-flex';
                 startPvpGameBtn.disabled = false;
                 
                 if (gameData.players[myId]?.ready) {
                     startPvpGameBtn.textContent = 'Waiting for Opponent...';
                     startPvpGameBtn.disabled = true;
                 } else {
                     startPvpGameBtn.textContent = 'Start Game';
                     startPvpGameBtn.disabled = false;
                 }
                 
                 // If both are ready, start the game
                 if (gameData.players[myId]?.ready && gameData.players[opponentId]?.ready) {
                    await db.collection('games').doc(currentGameId).update({ status: 'playing' });
                 }
            }
            
            function handleGameStart(gameData) {
                pvpLobby.style.display = 'none';
                startPvpGameBtn.style.display = 'none';
                pvpBoardContainer.style.display = 'block';
                setTimeout(() => pvpBoard.classList.add('show'), 100);
            }


            function updatePvpUI(gameData) {
                const myId = firebaseUser.uid;
                const opponentId = gameData.player1Id === myId ? gameData.player2Id : gameData.player1Id;

                // Update player info display
                const player1 = gameData.player1Data;
                const player2 = gameData.player2Data || { first_name: 'Waiting...', photo_url: null };

                // Always show current user on the left
                const myData = gameData.player1Id === myId ? player1 : player2;
                const opponentData = gameData.player1Id === myId ? player2 : player1;
                
                player1Name.textContent = myData.first_name || 'You';
                if(myData.photo_url) player1Avatar.innerHTML = `<img src="${myData.photo_url}" alt="">`;
                else player1Avatar.innerHTML = `<span>${myData.first_name?.[0] || '?'}</span>`;
                
                player2Name.textContent = opponentData.first_name;
                if(opponentData.photo_url) player2Avatar.innerHTML = `<img src="${opponentData.photo_url}" alt="">`;
                else player2Avatar.innerHTML = `<i class="fas fa-user-clock" style="font-size: 24px;"></i>`;

                // Handle different game statuses
                if (gameData.status === 'waiting') {
                     pvpGameStatus.textContent = 'Searching for opponent...';
                }
                else if (gameData.status === 'matched') {
                    handleMatchFound(gameData);
                }
                else if (gameData.status === 'playing') {
                     handleGameStart(gameData);
                     
                     const myMark = gameData.players[myId].mark;
                     const opponentMark = gameData.players[opponentId].mark;

                     player1Mark.textContent = myMark;
                     player2Mark.textContent = opponentMark;
                    
                     // Render board
                     const cells = pvpBoard.querySelectorAll('.cell');
                     gameData.board.forEach((mark, index) => {
                         cells[index].textContent = mark;
                         cells[index].className = 'cell';
                         if(mark) cells[index].classList.add(mark.toLowerCase());
                     });
                     
                     // Update turn indicator
                     player1Card.classList.toggle('active-turn', gameData.currentPlayerId === myId);
                     player2Card.classList.toggle('active-turn', gameData.currentPlayerId === opponentId);
                     
                     if (!gameData.gameActive) { // Game has ended
                         if (gameData.winnerId === 'draw') {
                              pvpGameStatus.textContent = "It's a draw!";
                              showGameResultModal('draw');
                         } else {
                             const winnerName = gameData.winnerId === myId ? "You win!" : "You lose!";
                             pvpGameStatus.textContent = winnerName;
                             showGameResultModal(gameData.winnerId === myId ? 'win' : 'loss', 'pvp');
                         }
                     } else {
                         pvpGameStatus.textContent = gameData.currentPlayerId === myId ? "Your turn!" : `${opponentData.first_name}'s turn...`;
                     }
                }
            }


            // Listen for game updates
            function listenForPvpUpdates(gameId) {
                currentGameId = gameId;
                const cells = pvpBoard.querySelectorAll('.cell');
                
                pvpGameUnsubscribe = db.collection('games').doc(gameId).onSnapshot(async doc => {
                    if (!doc.exists) { 
                        console.log("Game no longer exists.");
                        if(matchmakingTimeout) {
                           clearTimeout(matchmakingTimeout);
                           matchmakingTimeout = null;
                           await cleanUpPvp(false); // don't delete doc if it's already gone
                           switchTab('games');
                           alert("The other player left the lobby.");
                        }
                        return;
                    }
                    
                    const gameData = doc.data();
                    updatePvpUI(gameData);
                    
                    cells.forEach(cell => {
                       cell.onclick = (e) => handlePvpCellClick(e, gameData);
                    });
                });
            }

            async function handleMatchmakingTimeout() {
                 lobbyMessage.textContent = 'No opponents found. Please try again later.';
                 document.querySelector('#pvpLobby .searching-indicator').style.display = 'none';
                 await cleanUpPvp();
                 setTimeout(() => switchTab('games'), 2500);
            }


            // Matchmaking and starting PvP game
            async function initPvpGame() {
                gameMode = 'pvp';
                // Reset UI elements for new game search
                pvpLobby.style.display = 'block';
                lobbyMessage.textContent = 'Looking for an opponent';
                document.querySelector('#pvpLobby .searching-indicator').style.display = 'flex';
                pvpBoardContainer.style.display = 'none';
                startPvpGameBtn.style.display = 'none';
                pvpBoard.classList.remove('show');
                player2Name.textContent = 'Searching...';
                player2Avatar.innerHTML = '<i class="fas fa-user-clock" style="font-size: 24px;"></i>';
                player1Mark.textContent = '?';
                player2Mark.textContent = '?';
                vsText.classList.remove('matched');
                player1Card.classList.remove('active-turn');
                player2Card.classList.remove('active-turn', 'slide-in-right');

                switchTab('pvpGame');

                const gamesRef = db.collection('games');
                // Find games waiting for a player, excluding own games
                const q = gamesRef.where('status', '==', 'waiting').where('player1Id', '!=', firebaseUser.uid).limit(5);

                const querySnapshot = await q.get();

                if (querySnapshot.empty) {
                    // No waiting games, create a new one
                    const newGameRef = await gamesRef.add({
                        player1Id: firebaseUser.uid,
                        player1Data: userData,
                        status: 'waiting',
                        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                        board: Array(9).fill(''),
                        players: {}
                    });
                    listenForPvpUpdates(newGameRef.id);
                    // Start timeout
                    matchmakingTimeout = setTimeout(handleMatchmakingTimeout, 120000); // 2 minutes
                } else {
                    // Randomly choose from available games
                    const gameDoc = querySnapshot.docs[Math.floor(Math.random() * querySnapshot.docs.length)];
                    const gameData = gameDoc.data();
                    
                    const players = {};
                    const marks = ['X', 'O'];
                    const firstMark = marks.splice(Math.floor(Math.random() * marks.length), 1)[0];
                    const secondMark = marks[0];
                    
                    players[gameData.player1Id] = { mark: firstMark, ready: false, data: gameData.player1Data };
                    players[firebaseUser.uid] = { mark: secondMark, ready: false, data: userData };
                    
                    await gameDoc.ref.update({
                        player2Id: firebaseUser.uid,
                        player2Data: userData,
                        status: 'matched',
                        players: players
                    });
                    listenForPvpUpdates(gameDoc.id);
                }
            }
            
            async function cleanUpPvp(deleteGameDoc = true) {
                 if (pvpGameUnsubscribe) {
                    pvpGameUnsubscribe();
                    pvpGameUnsubscribe = null;
                }
                
                if (matchmakingTimeout) {
                    clearTimeout(matchmakingTimeout);
                    matchmakingTimeout = null;
                }
                
                if (currentGameId && deleteGameDoc) {
                    const gameRef = db.collection('games').doc(currentGameId);
                    const gameDoc = await gameRef.get();
                    if(gameDoc.exists) {
                       const gameData = gameDoc.data();
                       if(gameData.status === 'waiting' && gameData.player1Id === firebaseUser.uid) {
                           await gameRef.delete();
                       }
                    }
                }
                currentGameId = null;
            }


            // **** ROBOT GAME LOGIC (Mostly Unchanged) ****
            let robotCurrentPlayer = 'X';
            
            function handleRobotCellClick(e) {
                if (!gameActive) return;
                const cell = e.target;
                const index = parseInt(cell.getAttribute('data-index'));

                if (gameState[index] !== '' || robotCurrentPlayer !== 'X') return;
                
                makeMove(index, robotBoard);
                
                if (gameActive) {
                    setTimeout(() => robotMove(), 800);
                }
            }

            function checkWin(board, mark) {
                let hasWinner = false;
                 for (let i = 0; i < winningCombinations.length; i++) {
                    const [a, b, c] = winningCombinations[i];
                    if (board[a] === mark && board[a] === board[b] && board[a] === board[c]) {
                        hasWinner = true;
                        break;
                    }
                }
                return { hasWinner };
            }

            async function showGameResultModal(result, mode = 'robot') {
                 let prize = 0;
                 if (result === 'win') {
                    resultIcon.innerHTML = '<i class="fas fa-trophy"></i>';
                    resultIcon.className = 'modal-icon win';
                    resultTitle.textContent = 'Victory!';
                    prize = mode === 'robot' ? 100 : 500;
                    prizeAmount.textContent = `+${prize} coins`;
                    resultMessage.textContent = mode === 'robot' ? 'You beat the robot!' : 'You defeated your opponent!';

                    if (userDocRef) {
                        userDocRef.update({
                            balance: firebase.firestore.FieldValue.increment(prize)
                        });
                        balance += prize;
                        balanceDisplay.textContent = balance.toLocaleString();
                    }
                    
                    if (mode === 'pvp') {
                        await sendTelegramMessage(userData.id, `üèÜ Congratulations! You won your Tic-Tac-Toe match and earned ${prize} coins!`);
                    }

                } else if (result === 'draw') {
                    resultIcon.innerHTML = '<i class="fas fa-handshake"></i>';
                    resultIcon.className = 'modal-icon draw';
                    resultTitle.textContent = 'Game Draw!';
                    resultMessage.textContent = 'No winner this time. Try again!';
                    prizeAmount.textContent = '+0 coins';
                } else { // loss
                    resultIcon.innerHTML = '<i class="fas fa-times-circle"></i>';
                    resultIcon.className = 'modal-icon loss';
                    resultTitle.textContent = 'Defeat!';
                    prizeAmount.textContent = '+0 coins';
                     resultMessage.textContent = mode === 'robot' ? 'The robot outsmarted you!' : 'Your opponent was too strong!';
                }
                gameResultModal.classList.add('show');
            }
            
            function endGame(isDraw) {
                gameActive = false;
                if (isDraw) {
                    showGameResultModal('draw');
                } else {
                    const winner = robotCurrentPlayer;
                    showGameResultModal(winner === 'X' ? 'win' : 'loss', 'robot');
                }
            }
            
            function resetRobotGame() {
                robotCurrentPlayer = 'X';
                gameActive = true;
                gameState = ['', '', '', '', '', '', '', '', ''];
                
                const cells = robotBoard.querySelectorAll('.cell');
                cells.forEach(cell => {
                    cell.textContent = '';
                    cell.className = 'cell';
                });
                robotGameStatus.textContent = 'Your turn! You are playing as X';
                gameResultModal.classList.remove('show');
            }
            
            function robotMove() {
                if (!gameActive) return;
                
                let moveIndex = -1;
                let availableMoves = [];
                gameState.forEach((cell, index) => {
                    if (cell === '') availableMoves.push(index);
                });
                
                if(availableMoves.length > 0) {
                    moveIndex = availableMoves[Math.floor(Math.random() * availableMoves.length)];
                }

                if (moveIndex !== -1) {
                    makeMove(moveIndex, robotBoard);
                }
            }
            
            function makeMove(index, board) {
                gameState[index] = robotCurrentPlayer;
                const cell = board.querySelector(`.cell[data-index="${index}"]`);
                cell.textContent = robotCurrentPlayer;
                cell.classList.add(robotCurrentPlayer.toLowerCase());
                
                if (checkWin(gameState, robotCurrentPlayer).hasWinner) {
                    endGame(false);
                    return;
                }
                if (!gameState.includes('')) {
                    endGame(true);
                    return;
                }
                
                robotCurrentPlayer = robotCurrentPlayer === 'X' ? 'O' : 'X';
                robotGameStatus.textContent = robotCurrentPlayer === 'X' ? 'Your turn!' : 'Robot is thinking...';
            }

            function initRobotGame() {
                gameMode = 'robot';
                resetRobotGame();
                const cells = robotBoard.querySelectorAll('.cell');
                cells.forEach(cell => {
                    cell.addEventListener('click', handleRobotCellClick);
                });
                switchTab('robotGame');
            }
            
            // Event listeners
            robotGameCard.addEventListener('click', initRobotGame);
            pvpGameCard.addEventListener('click', initPvpGame);
            restartRobotGameBtn.addEventListener('click', resetRobotGame);
            exitRobotGameBtn.addEventListener('click', () => switchTab('games'));
            exitPvpGameBtn.addEventListener('click', () => cleanUpPvp(true));
            
            startPvpGameBtn.addEventListener('click', async () => {
                startPvpGameBtn.disabled = true;
                startPvpGameBtn.textContent = 'Waiting for Opponent...';
                const updatePath = `players.${firebaseUser.uid}.ready`;
                await db.collection('games').doc(currentGameId).update({ [updatePath]: true });
            });

            modalBtn.addEventListener('click', () => {
                gameResultModal.classList.remove('show');
                if (gameMode === 'robot') {
                    resetRobotGame(); 
                } else if(gameMode === 'pvp') {
                    cleanUpPvp(true).then(() => switchTab('games'));
                }
            });
            
            function setPlayerInfo(tgUser) {
                const playerAvatarRobot = document.getElementById('playerAvatar');
                const playerNameRobot = document.getElementById('playerName');
                
                if (tgUser.photo_url) {
                    playerAvatarRobot.innerHTML = `<img src="${tgUser.photo_url}" alt="Profile">`;
                } else {
                    playerAvatarRobot.innerHTML = `<span>${(tgUser.first_name?.[0] || '')}</span>`;
                }
                playerNameRobot.textContent = tgUser.first_name || 'You';
            }
            
            return { setPlayerInfo };
        }

        // Initialize the game
        async function initGame() {
            try {
                if (!window.Telegram?.WebApp?.initDataUnsafe) {
                     throw new Error('Please open in Telegram');
                }
                
                Telegram.WebApp.ready();
                Telegram.WebApp.expand();
                
                const tgUser = Telegram.WebApp.initDataUnsafe.user;
                if (!tgUser?.id || !tgUser?.username) {
                    throw new Error('Telegram user data is not available.');
                }
                
                const startParam = Telegram.WebApp.initDataUnsafe.start_param;
                if (startParam && startParam.startsWith('invite_')) {
                    invitedBy = startParam.replace('invite_', '');
                }
                
                const email = `${tgUser.username}@telegram.user`;
                const password = padTelegramId(tgUser.id);
                
                try {
                    const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                    firebaseUser = userCredential.user;
                } catch (createError) {
                    if (createError.code === 'auth/email-already-in-use') {
                        const userCredential = await auth.signInWithEmailAndPassword(email, password);
                        firebaseUser = userCredential.user;
                    } else {
                        throw createError;
                    }
                }

                userDocRef = db.collection('users').doc(firebaseUser.uid);
                const userDoc = await userDocRef.get();
                
                if (!userDoc.exists) {
                    let welcomeMessage = "üéâ <b>Welcome to the Tap Game!</b>\n\nStart tapping to earn coins and climb the leaderboard. Good luck!";
                    
                    if (invitedBy) {
                        const inviterRef = db.collection('users').doc(invitedBy);
                        const inviterDoc = await inviterRef.get();
                        if (inviterDoc.exists) {
                            await inviterRef.update({
                                invitedUsers: firebase.firestore.FieldValue.arrayUnion(firebaseUser.uid),
                                balance: firebase.firestore.FieldValue.increment(10000)
                            });
                            balance = 5000;

                            const inviterUsername = inviterDoc.data().username;
                            if (inviterUsername) {
                                welcomeMessage += `\n\nYou were invited by <b>@${inviterUsername}</b>. You both received a bonus!`;
                            }
                        }
                    }

                    userData = {
                        id: tgUser.id,
                        first_name: tgUser.first_name || '',
                        last_name: tgUser.last_name || '',
                        username: tgUser.username || '',
                        photo_url: tgUser.photo_url || '',
                        balance: balance,
                        invitedBy: invitedBy || null,
                        invitedUsers: [],
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    };
                    await userDocRef.set(userData);
                    await sendTelegramMessage(tgUser.id, welcomeMessage);

                } else {
                    userData = userDoc.data();
                    balance = userData.balance || 0;
                }
                
                // Setup UI
                if (tgUser.photo_url) {
                    profilePic.innerHTML = `<img src="${tgUser.photo_url}" alt="Profile">`;
                } else {
                    profilePic.innerHTML = `<span>${(tgUser.first_name?.[0] || '') + (tgUser.last_name?.[0] || '?')}</span>`;
                }
                profileName.textContent = tgUser.first_name || 'Player';
                balanceDisplay.textContent = balance.toLocaleString();
                setupInviteLink(firebaseUser.uid);
                
                const ticTacToe = initTicTacToe();
                ticTacToe.setPlayerInfo(tgUser);
                
                // Setup Navigation Event Listeners
                navItems.game.addEventListener('click', () => switchTab('game'));
                navItems.invite.addEventListener('click', () => switchTab('invite'));
                navItems.leaderboard.addEventListener('click', () => switchTab('leaderboard'));
                navItems.games.addEventListener('click', () => switchTab('games'));

                // Setup tap listeners
                tapCircle.addEventListener('click', handleTap);
                tapCircle.addEventListener('touchstart', handleTap, { passive: true });
                
                // Show the game screen
                loadingScreen.style.opacity = '0';
                setTimeout(() => {
                    loadingScreen.style.display = 'none';
                    switchTab('game'); // Start on game tab
                }, 500);
                
            } catch (error) {
                console.error('Initialization error:', error);
                loadingScreen.innerHTML = `<p style="color:red; padding: 20px;">Error: ${error.message}.</p>`;
            }
        }

        document.addEventListener('DOMContentLoaded', initGame);
    </script>
</body>
</html>
