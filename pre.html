<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tap Game</title>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" xintegrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background: #1b1e2e;
            color: white;
            height: 100vh;
            overflow: hidden;
        }
        
        /* Loading Screen */
        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #0f0f10;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 100;
            transition: opacity 0.5s ease;
        }
        
        .loading-circle {
            width: 60px;
            height: 60px;
            border: 4px solid rgba(255, 255, 255, 0.1);
            border-top-color: #6e45e2;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Main Game Screen */
        .game-screen {
            display: none;
            height: calc(100% - 70px); /* Adjusted for nav bar */
            flex-direction: column;
        }
        
        /* Header */
        .header {
            padding: 15px;
            display: flex;
            justify-content: flex-end;
        }
        
        .profile {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .profile-pic {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #2a2a2b;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
        }
        
        .profile-pic img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .profile-name {
            font-weight: bold;
            font-size: 14px;
        }
        
        /* Balance */
        .balance-container {
            text-align: center;
            margin-top: 20px;
        }
        
        .balance-label {
            font-size: 14px;
            color: #aaa;
            margin-bottom: 5px;
        }
        
        .balance-amount {
            font-size: 36px;
            font-weight: bold;
            background: linear-gradient(to right, #6e45e2, #88d3ce);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        /* Tap Circle */
        .tap-area {
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
        }
        
        .tap-circle {
            width: 280px;
            height: 280px;
            border-radius: 50%;
            background: linear-gradient(135deg, #2a2a2b, #1a1a1b);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
            cursor: pointer;
            transition: transform 0.1s ease;
        }
        
        .tap-circle:active {
            transform: scale(0.95);
        }
        
        .tap-circle-inner {
            width: 240px;
            height: 240px;
            border-radius: 50%;
            background: linear-gradient(135deg, #3a3a3c, #2a2a2b);
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 24px;
            font-weight: bold;
            color: white;
        }
        
        .coin-effect {
            position: absolute;
            font-size: 24px;
            font-weight: bold;
            color: #FFD700;
            opacity: 0;
            pointer-events: none;
            animation: float-up 1s ease-out forwards;
        }
        
        @keyframes float-up {
            0% {
                transform: translateY(0) scale(0.8);
                opacity: 1;
            }
            100% {
                transform: translateY(-100px) scale(1.2);
                opacity: 0;
            }
        }
        
        /* Page Styles */
        .page {
             display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: calc(100% - 70px); /* Adjusted for nav bar height */
            background: #0f0f10;
            padding: 20px;
            overflow-y: auto;
            z-index: 5;
        }

        .page-header {
            text-align: center;
            margin-bottom: 20px;
        }

        .page-header h2 {
            font-size: 24px;
            margin-bottom: 8px;
        }

        .page-header p {
            color: #aaa;
            font-size: 14px;
        }

        /* Invite Screen Specifics */
        .invite-link-container {
            display: flex;
            margin-bottom: 20px;
            background: #1a1a1b;
            border-radius: 12px;
            overflow: hidden;
        }

        .invite-link {
            flex: 1;
            padding: 15px;
            font-size: 14px;
            word-break: break-all;
            color: #88d3ce;
        }

        .copy-btn {
            background: #6e45e2;
            color: white;
            border: none;
            padding: 0 20px;
            font-weight: bold;
            cursor: pointer;
            transition: background 0.2s ease;
        }

        .copy-btn:active {
            background: #5a35c0;
        }

        .share-buttons {
            display: flex;
            justify-content: center;
            margin-bottom: 20px;
        }

        .share-btn {
            background: #0088cc;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 12px;
            font-size: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .share-btn:active {
            background: #006699;
        }
        
        .list-container {
            background: #1a1a1b;
            border-radius: 12px;
            padding: 15px;
        }

        .list-container h3 {
            margin-bottom: 15px;
            font-size: 18px;
        }
        
        .list-scrollable {
            max-height: 40vh;
            overflow-y: auto;
        }

        .user-card, .leaderboard-card {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid #2a2a2b;
        }

        .user-card:last-child, .leaderboard-card:last-child {
            border-bottom: none;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 12px;
            flex-grow: 1;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #2a2a2b;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
            flex-shrink: 0;
        }

        .user-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .user-name {
            font-weight: bold;
            font-size: 14px;
        }

        .user-balance {
            color: #88d3ce;
            font-weight: bold;
            flex-shrink: 0;
        }

        .empty-state {
            color: #666;
            text-align: center;
            padding: 20px 0;
        }
        
        /* Leaderboard Styles */
        .leaderboard-card .rank {
            font-size: 18px;
            font-weight: bold;
            width: 40px;
            text-align: center;
            color: #aaa;
            flex-shrink: 0;
        }
        
        .rank-1, .rank-2, .rank-3 {
            font-size: 24px;
        }
        .rank-1 { color: #FFD700; } /* Gold */
        .rank-2 { color: #C0C0C0; } /* Silver */
        .rank-3 { color: #CD7F32; } /* Bronze */
        
        /* Bottom Navigation */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background: #1a1a1b;
            display: flex;
            padding-top: 10px;
            padding-bottom: 10px;
            border-top: 1px solid #2a2a2b;
            z-index: 10;
        }

        .nav-item {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: #888;
            cursor: pointer;
            transition: color 0.2s ease;
        }

        .nav-item.active {
            color: #6e45e2;
        }

        .nav-icon {
            font-size: 24px;
            margin-bottom: 4px;
        }

        .nav-label {
            font-size: 12px;
        }
    </style>
</head>
<body>
    <!-- Loading Screen -->
    <div class="loading-screen" id="loadingScreen">
        <div class="loading-circle"></div>
        <p>Loading...</p>
    </div>
    
    <!-- Main Game Screen -->
    <div class="game-screen" id="gameScreen">
        <div class="header">
            <div class="profile" id="profile">
                <div class="profile-pic" id="profilePic"><span>?</span></div>
                <div class="profile-name" id="profileName"></div>
            </div>
        </div>
        <div class="balance-container">
            <div class="balance-label">Your Balance</div>
            <div class="balance-amount" id="balance">0</div>
        </div>
        <div class="tap-area">
            <div class="tap-circle" id="tapCircle">
                <div class="tap-circle-inner">TAP</div>
            </div>
        </div>
    </div>

    <!-- Invite Screen -->
    <div class="page" id="inviteScreen">
        <div class="page-header">
            <h2>Invite Friends</h2>
            <p>Earn bonuses when your friends join and play</p>
        </div>
        <div class="invite-link-container">
            <div class="invite-link" id="inviteLink">Loading...</div>
            <button class="copy-btn" id="copyBtn">Copy</button>
        </div>
        <div class="share-buttons">
            <button class="share-btn" id="shareTelegramBtn">
                <i class="fab fa-telegram-plane"></i> Share via Telegram
            </button>
        </div>
        <div class="list-container">
            <h3>Your Team</h3>
            <div class="list-scrollable" id="usersList">
                <div class="empty-state">No invited users yet</div>
            </div>
        </div>
    </div>
    
    <!-- Leaderboard Screen -->
    <div class="page" id="leaderboardScreen">
        <div class="page-header">
            <h2>🏆 Leaderboard 🏆</h2>
        </div>
        <div class="list-container">
             <div class="list-scrollable" id="leaderboardList">
                <div class="empty-state">Loading...</div>
             </div>
        </div>
    </div>

    <!-- Bottom Navigation -->
    <div class="bottom-nav">
        <div class="nav-item active" id="navGame">
           <div class="nav-icon"><i class="fas fa-gamepad"></i></div>
            <div class="nav-label">Game</div>
        </div>
        <div class="nav-item" id="navInvite">
           <div class="nav-icon"><i class="fas fa-user-plus"></i></div>
            <div class="nav-label">Invite</div>
        </div>
        <div class="nav-item" id="navLeaderboard">
            <div class="nav-icon"><i class="fas fa-trophy"></i></div>
            <div class="nav-label">Leaders</div>
        </div>
    </div>

    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBX3g8wWxcTtwFDsJNJVcjUDIGxMd1L0Rk",
            authDomain: "mytestapp-f6913.firebaseapp.com",
            databaseURL: "https://mytestapp-f6913-default-rtdb.firebaseio.com",
            projectId: "mytestapp-f6913",
            storageBucket: "mytestapp-f6913.appspot.com",
            messagingSenderId: "300150696072",
            appId: "1:300150696072:web:1e29cb5a813d004018573d",
            measurementId: "G-PPDR4TBQF5"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // DOM elements
        const loadingScreen = document.getElementById('loadingScreen');
        const gameScreen = document.getElementById('gameScreen');
        const profilePic = document.getElementById('profilePic');
        const profileName = document.getElementById('profileName');
        const balanceDisplay = document.getElementById('balance');
        const tapCircle = document.getElementById('tapCircle');
        
        // Navigation
        const navItems = {
            game: document.getElementById('navGame'),
            invite: document.getElementById('navInvite'),
            leaderboard: document.getElementById('navLeaderboard')
        };
        const pages = {
            game: gameScreen,
            invite: document.getElementById('inviteScreen'),
            leaderboard: document.getElementById('leaderboardScreen')
        };

        // Invite Screen Elements
        const inviteLink = document.getElementById('inviteLink');
        const copyBtn = document.getElementById('copyBtn');
        const usersList = document.getElementById('usersList');
        const shareTelegramBtn = document.getElementById('shareTelegramBtn');

        // Leaderboard element
        const leaderboardList = document.getElementById('leaderboardList');

        // Game state
        let balance = 0;
        let firebaseUser = null;
        let userDocRef = null;
        let coinsPerTap = 1;
        let invitedBy = null;
        const botUsername = 'guvuhgy7bot/kuyti';

        // Pad Telegram ID for a simple password
        function padTelegramId(id) {
            return String(id).padStart(6, '0');
        }
        
        // NEW: Function to send a message via Telegram bot
        async function sendTelegramMessage(chatId, text) {
            const botToken = '8162193180:AAF-ZGiIWFL-3tLyrkpaaLO2Y48RmrHRcwE';
            const url = `https://api.telegram.org/bot${botToken}/sendMessage`;
            try {
                await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        chat_id: chatId,
                        text: text,
                        parse_mode: 'HTML'
                    })
                });
            } catch (error) {
                console.error('Error sending Telegram message:', error);
            }
        }

        // Create coin effect on tap
        function createCoinEffect(x, y) {
            const coin = document.createElement('div');
            coin.className = 'coin-effect';
            coin.textContent = `+${coinsPerTap}`;
            coin.style.left = `${x - 15}px`;
            coin.style.top = `${y - 15}px`;
            document.body.appendChild(coin);
            
            setTimeout(() => coin.remove(), 1000);
        }

        // Handle tap event
        function handleTap(e) {
            e.preventDefault(); // Prevents double tap zoom
            const clientX = e.clientX || e.touches[0].clientX;
            const clientY = e.clientY || e.touches[0].clientY;
            
            createCoinEffect(clientX, clientY);
            
            balance += coinsPerTap;
            balanceDisplay.textContent = balance.toLocaleString();
            
            if (window.Telegram?.WebApp?.HapticFeedback) {
                Telegram.WebApp.HapticFeedback.impactOccurred('light');
            }
            
            if (userDocRef) {
                userDocRef.update({
                    balance: firebase.firestore.FieldValue.increment(coinsPerTap)
                }).catch(error => console.error('Error updating balance:', error));
            }
        }

        // Setup invite link and buttons
        function setupInviteLink(userId) {
            const link = `https://t.me/${botUsername}?startapp=invite_${userId}`;
            inviteLink.textContent = link;
            
            copyBtn.addEventListener('click', () => {
                navigator.clipboard.writeText(link).then(() => {
                    copyBtn.textContent = 'Copied!';
                    setTimeout(() => { copyBtn.textContent = 'Copy'; }, 2000);
                });
            });

            shareTelegramBtn.addEventListener('click', () => {
                const message = `Join this awesome Tap Game and get bonus coins! 🎮💰\n\nUse my invite link: ${link}`;
                const telegramShareUrl = `https://t.me/share/url?url=${encodeURIComponent(link)}&text=${encodeURIComponent(message)}`;
                window.open(telegramShareUrl, '_blank');
            });
        }
        
        // Load Leaderboard data
        async function loadLeaderboard() {
            leaderboardList.innerHTML = '<div class="empty-state">Loading...</div>';
            try {
                const querySnapshot = await db.collection('users').orderBy('balance', 'desc').limit(100).get();
                if (querySnapshot.empty) {
                    leaderboardList.innerHTML = '<div class="empty-state">Be the first on the leaderboard!</div>';
                    return;
                }

                leaderboardList.innerHTML = '';
                let rank = 1;
                querySnapshot.forEach(doc => {
                    const userData = doc.data();
                    const card = document.createElement('div');
                    card.className = 'leaderboard-card';
                    
                    let rankDisplay = rank;
                    let rankClass = `rank-${rank}`;
                    if(rank === 1) rankDisplay = '🥇';
                    if(rank === 2) rankDisplay = '🥈';
                    if(rank === 3) rankDisplay = '🥉';

                    card.innerHTML = `
                        <div class="rank ${rank > 3 ? '' : rankClass}">${rankDisplay}</div>
                        <div class="user-info">
                            <div class="user-avatar">${userData.photo_url ? `<img src="${userData.photo_url}" alt="">` : (userData.first_name?.[0] || '?')}</div>
                            <div class="user-name">${userData.first_name || 'User'}</div>
                        </div>
                        <div class="user-balance">${(userData.balance || 0).toLocaleString()}</div>
                    `;
                    leaderboardList.appendChild(card);
                    rank++;
                });
            } catch (error) {
                console.error("Error loading leaderboard:", error);
                leaderboardList.innerHTML = '<div class="empty-state">Could not load leaderboard.</div>';
            }
        }

        // Load invited users
        async function loadInvitedUsers() {
            usersList.innerHTML = '<div class="empty-state">Loading team...</div>';
            const userDoc = await userDocRef.get();
            const invitedUserIds = userDoc.data().invitedUsers || [];
            
            if (invitedUserIds.length === 0) {
                usersList.innerHTML = '<div class="empty-state">You haven\'t invited anyone yet.</div>';
                return;
            }
            
            usersList.innerHTML = '';
            for (const userId of invitedUserIds) {
                try {
                    const invitedUserDoc = await db.collection('users').doc(userId).get();
                    if (invitedUserDoc.exists) {
                        const userData = invitedUserDoc.data();
                        const card = document.createElement('div');
                        card.className = 'user-card';
                        card.innerHTML = `
                            <div class="user-info">
                                <div class="user-avatar">${userData.photo_url ? `<img src="${userData.photo_url}" alt="">` : (userData.first_name?.[0] || '?')}</div>
                                <div class="user-name">${userData.first_name || 'User'}</div>
                            </div>
                            <div class="user-balance">${(userData.balance || 0).toLocaleString()}</div>
                        `;
                        usersList.appendChild(card);
                    }
                } catch (error) {
                    console.error('Error loading invited user data:', error);
                }
            }
        }

        // Initialize the game
        async function initGame() {
            try {
                if (!window.Telegram?.WebApp?.initDataUnsafe) {
                     throw new Error('Please open in Telegram');
                }
                
                Telegram.WebApp.ready();
                Telegram.WebApp.expand();
                
                const tgUser = Telegram.WebApp.initDataUnsafe.user;
                if (!tgUser?.id || !tgUser?.username) {
                    throw new Error('Telegram user data is not available.');
                }
                
                const startParam = Telegram.WebApp.initDataUnsafe.start_param;
                if (startParam && startParam.startsWith('invite_')) {
                    invitedBy = startParam.replace('invite_', '');
                }
                
                const email = `${tgUser.username}@telegram.user`;
                const password = padTelegramId(tgUser.id);
                
                try {
                    const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                    firebaseUser = userCredential.user;
                } catch (createError) {
                    if (createError.code === 'auth/email-already-in-use') {
                        const userCredential = await auth.signInWithEmailAndPassword(email, password);
                        firebaseUser = userCredential.user;
                    } else {
                        throw createError;
                    }
                }

                userDocRef = db.collection('users').doc(firebaseUser.uid);
                const userDoc = await userDocRef.get();
                
                // UPDATED: Logic for new user creation
                if (!userDoc.exists) {
                    let welcomeMessage = "🎉 <b>Welcome to the Tap Game!</b>\n\nStart tapping to earn coins and climb the leaderboard. Good luck!";
                    
                    // Handle referral bonus logic
                    if (invitedBy) {
                        const inviterRef = db.collection('users').doc(invitedBy);
                        const inviterDoc = await inviterRef.get();
                        if (inviterDoc.exists) {
                            await inviterRef.update({
                                invitedUsers: firebase.firestore.FieldValue.arrayUnion(firebaseUser.uid),
                                balance: firebase.firestore.FieldValue.increment(1000)
                            });
                            balance = 500; // Starting bonus for the invited user

                            // Customize welcome message if inviter is found
                            const inviterUsername = inviterDoc.data().username;
                            if (inviterUsername) {
                                welcomeMessage += `\n\nYou were invited by <b>@${inviterUsername}</b>. You both received a bonus!`;
                            }
                        }
                    }

                    // Create the new user's document
                    await userDocRef.set({
                        id: tgUser.id,
                        first_name: tgUser.first_name || '',
                        last_name: tgUser.last_name || '',
                        username: tgUser.username || '',
                        photo_url: tgUser.photo_url || '',
                        balance: balance,
                        invitedBy: invitedBy || null,
                        invitedUsers: [],
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    
                    // Send the welcome message to the new user
                    await sendTelegramMessage(tgUser.id, welcomeMessage);

                } else {
                    balance = userDoc.data().balance || 0;
                }
                
                // Setup UI
                if (tgUser.photo_url) {
                    profilePic.innerHTML = `<img src="${tgUser.photo_url}" alt="Profile">`;
                } else {
                    profilePic.innerHTML = `<span>${(tgUser.first_name?.[0] || '') + (tgUser.last_name?.[0] || '?')}</span>`;
                }
                profileName.textContent = tgUser.first_name || 'Player';
                balanceDisplay.textContent = balance.toLocaleString();
                setupInviteLink(firebaseUser.uid);
                
                // Setup Navigation
                function switchTab(tabName) {
                    Object.keys(pages).forEach(key => {
                        pages[key].style.display = 'none';
                        navItems[key].classList.remove('active');
                    });
                    pages[tabName].style.display = tabName === 'game' ? 'flex' : 'block';
                    navItems[tabName].classList.add('active');

                    if (tabName === 'invite') loadInvitedUsers();
                    if (tabName === 'leaderboard') loadLeaderboard();
                }

                navItems.game.addEventListener('click', () => switchTab('game'));
                navItems.invite.addEventListener('click', () => switchTab('invite'));
                navItems.leaderboard.addEventListener('click', () => switchTab('leaderboard'));

                // Setup tap listeners
                tapCircle.addEventListener('click', handleTap);
                tapCircle.addEventListener('touchstart', handleTap, { passive: true });
                
                // Show the game screen
                loadingScreen.style.opacity = '0';
                setTimeout(() => {
                    loadingScreen.style.display = 'none';
                    switchTab('game'); // Start on game tab
                }, 500);
                
            } catch (error) {
                console.error('Initialization error:', error);
                loadingScreen.innerHTML = `<p style="color:red; padding: 20px;">Error: ${error.message}.</p>`;
            }
        }

        document.addEventListener('DOMContentLoaded', initGame);
    </script>
</body>
</html>
