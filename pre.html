<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tap Game</title>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
     <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background: #1b1e2e;
            color: white;
            height: 100vh;
            overflow: hidden;
        }
        
        /* Loading Screen */
        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #0f0f10;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 100;
            transition: opacity 0.5s ease;
        }
        
        .loading-logo {
            width: 80px;
            height: 80px;
            margin-bottom: 30px;
            background: linear-gradient(135deg, #6e45e2, #88d3ce);
            border-radius: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 36px;
        }
        
        .loading-circle {
            width: 60px;
            height: 60px;
            border: 4px solid rgba(255, 255, 255, 0.1);
            border-top-color: #6e45e2;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Main Game Screen */
        .game-screen {
            display: none;
            height: calc(100% - 60px);
            flex-direction: column;
        }
        
        /* Header */
        .header {
            padding: 15px;
            display: flex;
            justify-content: flex-end;
        }
        
        .profile {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .profile-pic {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #2a2a2b;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
        }
        
        .profile-pic img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .profile-name {
            font-weight: bold;
            font-size: 14px;
        }
        
        /* Balance */
        .balance-container {
            text-align: center;
            margin-top: 20px;
        }
        
        .balance-label {
            font-size: 14px;
            color: #aaa;
            margin-bottom: 5px;
        }
        
        .balance-amount {
            font-size: 36px;
            font-weight: bold;
            background: linear-gradient(to right, #6e45e2, #88d3ce);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        /* Tap Circle */
        .tap-area {
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
        }
        
        .tap-circle {
            width: 280px;
            height: 280px;
            border-radius: 50%;
            background: linear-gradient(135deg, #2a2a2b, #1a1a1b);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
            cursor: pointer;
            transition: transform 0.1s ease;
        }
        
        .tap-circle:active {
            transform: scale(0.95);
        }
        
        .tap-circle-inner {
            width: 240px;
            height: 240px;
            border-radius: 50%;
            background: linear-gradient(135deg, #3a3a3c, #2a2a2b);
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 24px;
            font-weight: bold;
            color: white;
        }
        
        .coin-effect {
            position: absolute;
            width: 30px;
            height: 30px;
            background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="%23FFD700"><path d="M12 2L4 5v6.09c0 5.05 3.41 9.76 8 10.91 4.59-1.15 8-5.86 8-10.91V5l-8-3zm-1.06 13.54L7.4 12l1.41-1.41 2.12 2.12 4.24-4.24 1.41 1.41-5.64 5.66z"/></svg>') no-repeat center;
            background-size: contain;
            opacity: 0;
            pointer-events: none;
            animation: float-up 1s ease-out forwards;
        }
        
        @keyframes float-up {
            0% {
                transform: translateY(0) scale(0.5);
                opacity: 1;
            }
            100% {
                transform: translateY(-100px) scale(1.2);
                opacity: 0;
            }
        }
        
        /* Particles */
        .particles {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }
        
        .particle {
            position: absolute;
            background: linear-gradient(to right, #6e45e2, #88d3ce);
            border-radius: 50%;
            pointer-events: none;
        }

        /* Bottom Navigation */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background: #1a1a1b;
            display: flex;
            padding: 10px 0;
            border-top: 1px solid #2a2a2b;
            z-index: 10;
        }

        .nav-item {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: #666;
            cursor: pointer;
            transition: color 0.2s ease;
        }

        .nav-item.active {
            color: #6e45e2;
        }

        .nav-icon {
            font-size: 24px;
            margin-bottom: 4px;
        }

        .nav-label {
            font-size: 12px;
        }

        /* Invite Screen */
        .invite-screen {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: calc(100% - 60px);
            background: #0f0f10;
            padding: 20px;
            overflow-y: auto;
            z-index: 5;
        }

        .invite-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .invite-header h2 {
            font-size: 24px;
            margin-bottom: 8px;
        }

        .invite-header p {
            color: #aaa;
            font-size: 14px;
        }

        .invite-link-container {
            display: flex;
            margin-bottom: 30px;
            background: #1a1a1b;
            border-radius: 12px;
            overflow: hidden;
        }

        .invite-link {
            flex: 1;
            padding: 15px;
            font-size: 14px;
            word-break: break-all;
            color: #88d3ce;
        }

        .copy-btn {
            background: #6e45e2;
            color: white;
            border: none;
            padding: 0 20px;
            font-weight: bold;
            cursor: pointer;
            transition: background 0.2s ease;
        }

        .copy-btn:active {
            background: #5a35c0;
        }

        .invited-users {
            background: #1a1a1b;
            border-radius: 12px;
            padding: 15px;
        }

        .invited-users h3 {
            margin-bottom: 15px;
            font-size: 18px;
        }

        .users-list {
            max-height: 300px;
            overflow-y: auto;
        }

        .user-card {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid #2a2a2b;
        }

        .user-card:last-child {
            border-bottom: none;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #2a2a2b;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
        }

        .user-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .user-name {
            font-weight: bold;
            font-size: 14px;
        }

        .user-balance {
            color: #88d3ce;
            font-weight: bold;
        }

        .empty-state {
            color: #666;
            text-align: center;
            padding: 20px 0;
        }

        /* Add to your style section */
.share-buttons {
    margin-top: 20px;
    display: flex;
    justify-content: center;
}

.share-btn {
    background: #0088cc;
    color: white;
    border: none;
    padding: 12px 20px;
    border-radius: 12px;
    font-size: 16px;
    display: flex;
    align-items: center;
    gap: 8px;
    cursor: pointer;
    transition: background 0.2s;
}

.share-btn:active {
    background: #006699;
}

.share-icon {
    font-size: 20px;
}
    </style>
</head>
<body>
    <!-- Loading Screen -->
    <div class="loading-screen" id="loadingScreen">
        <p>Loading...</p>
    </div>
    
    <!-- Main Game Screen -->
    <div class="game-screen" id="gameScreen">
        <!-- Header with Profile -->
        <div class="header">
            <div class="profile" id="profile">
                <div class="profile-pic" id="profilePic">
                    <span id="profileInitials">?</span>
                </div>
                <div class="profile-name" id="profileName"></div>
            </div>
        </div>
        
        <!-- Balance Display -->
        <div class="balance-container">
            <div class="balance-label">Your Balance</div>
            <div class="balance-amount" id="balance">0</div>
        </div>
        
        <!-- Tap Circle -->
        <div class="tap-area">
            <div class="particles" id="particles"></div>
            <div class="tap-circle" id="tapCircle">
                <div class="tap-circle-inner">TAP</div>
            </div>
        </div>
    </div>

    <!-- Invite Screen -->
    <div class="invite-screen" id="inviteScreen">
        <div class="invite-header">
            <h2>Invite Friends</h2>
            <p>Earn bonuses when your friends join and play</p>
        </div>
        
        <div class="invite-link-container">
            <div class="invite-link" id="inviteLink">Loading invite link...</div>
            <button class="copy-btn" id="copyBtn">Copy</button>
        </div>
        <!-- Add this inside your invite-screen div, after the invite-link-container -->
<div class="share-buttons">
    <button class="share-btn" id="shareTelegramBtn">
        <span class="share-icon">ðŸ“¤</span> Share via Telegram
    </button>
</div>
        
        <div class="invited-users">
            <h3>Your Team</h3>
            <div class="users-list" id="usersList">
                <div class="empty-state">No invited users yet</div>
            </div>
        </div>
    </div>

    <!-- Bottom Navigation -->
    <div class="bottom-nav">
        <div class="nav-item active" id="navGame">
           <div class="nav-icon"><i class="fas fa-gamepad"></i></div>
            <div class="nav-label">Game</div>
        </div>
        <div class="nav-item" id="navInvite">
            <div class="nav-icon"><i class="fas fa-user"></i></div>
            <div class="nav-label">Invite</div>
        </div>
    </div>

    <script>

// Firebase configuration and initialization
const firebaseConfig = {
    apiKey: "AIzaSyBX3g8wWxcTtwFDsJNJVcjUDIGxMd1L0Rk",
    authDomain: "mytestapp-f6913.firebaseapp.com",
    databaseURL: "https://mytestapp-f6913-default-rtdb.firebaseio.com",
    projectId: "mytestapp-f6913",
    storageBucket: "mytestapp-f6913.firebasestorage.app",
    messagingSenderId: "300150696072",
    appId: "1:300150696072:web:1e29cb5a813d004018573d",
    measurementId: "G-PPDR4TBQF5"
};

// Initialize Firebase
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

// DOM elements
const loadingScreen = document.getElementById('loadingScreen');
const gameScreen = document.getElementById('gameScreen');
const profilePic = document.getElementById('profilePic');
const profileInitials = document.getElementById('profileInitials');
const profileName = document.getElementById('profileName');
const balanceDisplay = document.getElementById('balance');
const tapCircle = document.getElementById('tapCircle');
const particlesContainer = document.getElementById('particles');
const navGame = document.getElementById('navGame');
const navInvite = document.getElementById('navInvite');
const inviteScreen = document.getElementById('inviteScreen');
const inviteLink = document.getElementById('inviteLink');
const copyBtn = document.getElementById('copyBtn');
const usersList = document.getElementById('usersList');
const shareTelegramBtn = document.getElementById('shareTelegramBtn');

// Game state
let balance = 0;
let firebaseUser = null;
let userDocRef = null;
let coinsPerTap = 1;
let invitedBy = null;

// Utility functions
function padTelegramId(id) {
    return String(id).padStart(6, '0');
}

function createCoinEffect(x, y) {
    const coin = document.createElement('div');
    coin.className = 'coin-effect';
    coin.style.left = `${x - 15}px`;
    coin.style.top = `${y - 15}px`;
    document.body.appendChild(coin);
    
    setTimeout(() => {
        coin.remove();
    }, 1000);
}

function createParticles(x, y) {
    for (let i = 0; i < 10; i++) {
        const particle = document.createElement('div');
        particle.className = 'particle';
        particle.style.width = `${Math.random() * 10 + 5}px`;
        particle.style.height = particle.style.width;
        particle.style.left = `${x}px`;
        particle.style.top = `${y}px`;
        particlesContainer.appendChild(particle);
        
        const angle = Math.random() * Math.PI * 2;
        const velocity = Math.random() * 5 + 2;
        let startTime = Date.now();
        
        function animate() {
            const elapsed = Date.now() - startTime;
            const progress = elapsed / 1500;
            
            if (progress >= 1) {
                particle.remove();
                return;
            }
            
            const distance = velocity * elapsed / 20;
            const currentX = x + Math.cos(angle) * distance;
            const currentY = y + Math.sin(angle) * distance;
            
            particle.style.transform = `translate(${currentX - x}px, ${currentY - y}px) scale(${1 - progress * 0.5})`;
            particle.style.opacity = 1 - progress;
            requestAnimationFrame(animate);
        }
        requestAnimationFrame(animate);
    }
}

async function sendTelegramMessage(chatId, text) {
    const botToken = '8162193180:AAF-ZGiIWFL-3tLyrkpaaLO2Y48RmrHRcwE';
    const url = `https://api.telegram.org/bot${botToken}/sendMessage`;
    
    try {
        const response = await fetch(url, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                chat_id: chatId,
                text: text,
                parse_mode: 'HTML'
            })
        });
        return await response.json();
    } catch (error) {
        console.error('Error sending message:', error);
    }
}

async function handleInviterRewards(invitedBy, firebaseUser, tgUser) {
    if (!invitedBy) return 0;
    
    const inviterRef = db.collection('users').doc(invitedBy);
    
    // Update inviter's data
    await inviterRef.update({
        invitedUsers: firebase.firestore.FieldValue.arrayUnion(firebaseUser.uid),
        balance: firebase.firestore.FieldValue.increment(100),
        lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
    });
    
    // Get inviter's data
    const inviterDoc = await inviterRef.get();
    let inviterName = "a friend";
    
    if (inviterDoc.exists) {
        const inviterData = inviterDoc.data();
        
        // Send notification to inviter
        if (inviterData.id) {
            inviterName = inviterData.first_name || inviterName;
            await sendTelegramMessage(
                inviterData.id,
                `ðŸŽ‰ <b>${tgUser.first_name || 'New player'}</b> joined using your invite link!\n\n` +
                `You received <b>100 coins</b> as a bonus!`
            );
        }
        
        // Send welcome message to new user
        await sendTelegramMessage(
            tgUser.id,
            `ðŸ‘‹ Welcome to Tap Game!\n\n` +
            `You were invited by <b>${inviterName}</b>!\n` +
            `You received <b>50 bonus coins</b> to start!\n\n` +
            `Keep tapping to earn more!`
        );
    }
    
    return 50; // Bonus for new user
}

function setupInviteLink(userId) {
    const link = `https://t.me/guvuhgy7bot/kuyti?startapp=invite_${userId}`;
    inviteLink.textContent = link;
    
    copyBtn.addEventListener('click', () => {
        navigator.clipboard.writeText(link).then(() => {
            copyBtn.textContent = 'Copied!';
            setTimeout(() => copyBtn.textContent = 'Copy', 2000);
            if (window.Telegram?.WebApp?.HapticFeedback) {
                Telegram.WebApp.HapticFeedback.impactOccurred('light');
            }
        });
    });
}

function setupShareButton() {
    shareTelegramBtn.addEventListener('click', () => {
        const inviteLink = document.getElementById('inviteLink').textContent;
        
        if (window.Telegram?.WebApp?.showShareAlert) {
            Telegram.WebApp.showShareAlert(
                `Join my Tap Game and earn coins! ðŸŽ®ðŸ’°`, 
                `Use my invite link: ${inviteLink}`,
                (wasShared) => {
                    if (wasShared && window.Telegram?.WebApp?.HapticFeedback) {
                        Telegram.WebApp.HapticFeedback.impactOccurred('light');
                    }
                }
            );
        } else {
            const shareUrl = `https://t.me/share/url?url=${encodeURIComponent(inviteLink)}&text=${encodeURIComponent('Join this awesome game!')}`;
            if (window.Telegram?.WebApp?.openTelegramLink) {
                Telegram.WebApp.openTelegramLink(shareUrl);
            } else {
                window.open(shareUrl, '_blank');
            }
        }
    });
}

async function loadInvitedUsers() {
    const userDoc = await userDocRef.get();
    const invitedUserIds = userDoc.data()?.invitedUsers || [];
    
    usersList.innerHTML = invitedUserIds.length ? '' : '<div class="empty-state">No invited users yet</div>';
    
    for (const userId of invitedUserIds) {
        try {
            const userDoc = await db.collection('users').doc(userId).get();
            if (userDoc.exists) {
                const userData = userDoc.data();
                const userCard = document.createElement('div');
                userCard.className = 'user-card';
                userCard.innerHTML = `
                    <div class="user-info">
                        ${userData.photo_url ? 
                            `<div class="user-avatar"><img src="${userData.photo_url}" alt="${userData.first_name}"></div>` : 
                            `<div class="user-avatar">${(userData.first_name?.[0] || '') + (userData.last_name?.[0] || '') || '?'}</div>`
                        }
                        <div class="user-name">${userData.first_name || 'User'}</div>
                    </div>
                    <div class="user-balance">${(userData.balance || 0).toLocaleString()}</div>
                `;
                usersList.appendChild(userCard);
            }
        } catch (error) {
            console.error('Error loading user data:', error);
        }
    }
}

// Main game initialization
async function initGame() {
    try {
        if (!window.Telegram?.WebApp) {
            throw new Error('Please open in Telegram');
        }
        
        Telegram.WebApp.ready();
        Telegram.WebApp.expand();
        
        const tgUser = Telegram.WebApp.initDataUnsafe?.user;
        if (!tgUser?.id) throw new Error('Telegram user data missing');
        
        // Check for invite parameter
        const startParam = Telegram.WebApp.initDataUnsafe.start_param;
        if (startParam?.startsWith('invite_')) {
            invitedBy = startParam.replace('invite_', '');
        }
        
        // Authenticate with Firebase
        const email = `${tgUser.username || tgUser.id}@telegram.user`;
        const password = padTelegramId(tgUser.id);
        
        try {
            const userCredential = await auth.createUserWithEmailAndPassword(email, password);
            firebaseUser = userCredential.user;
            
            // Handle inviter rewards and send welcome message
            if (invitedBy) {
                balance = await handleInviterRewards(invitedBy, firebaseUser, tgUser);
            }
        } catch (createError) {
            if (createError.code === 'auth/email-already-in-use') {
                const userCredential = await auth.signInWithEmailAndPassword(email, password);
                firebaseUser = userCredential.user;
                const userDoc = await db.collection('users').doc(firebaseUser.uid).get();
                balance = userDoc.data()?.balance || 0;
            } else {
                throw createError;
            }
        }
        
        // Setup Firestore document
        userDocRef = db.collection('users').doc(firebaseUser.uid);
        const userDoc = await userDocRef.get();
        
        if (!userDoc.exists) {
            await userDocRef.set({
                id: tgUser.id,
                first_name: tgUser.first_name || '',
                last_name: tgUser.last_name || '',
                username: tgUser.username || '',
                photo_url: tgUser.photo_url || '',
                balance: balance,
                invitedBy: invitedBy || null,
                invitedUsers: [],
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
            });
        }
        
        // Setup UI
        if (tgUser.photo_url) {
            profilePic.innerHTML = `<img src="${tgUser.photo_url}" alt="Profile">`;
        } else {
            profileInitials.textContent = (tgUser.first_name?.[0] || '') + (tgUser.last_name?.[0] || '') || '?';
        }
        
        profileName.textContent = tgUser.first_name || 'Player';
        balanceDisplay.textContent = balance.toLocaleString();
        
        setupInviteLink(firebaseUser.uid);
        setupShareButton();
        loadInvitedUsers();
        
        // Navigation setup
        navGame.addEventListener('click', () => {
            gameScreen.style.display = 'flex';
            inviteScreen.style.display = 'none';
            navGame.classList.add('active');
            navInvite.classList.remove('active');
        });
        
        navInvite.addEventListener('click', () => {
            gameScreen.style.display = 'none';
            inviteScreen.style.display = 'block';
            navGame.classList.remove('active');
            navInvite.classList.add('active');
        });
        
        navGame.classList.add('active');
        tapCircle.addEventListener('click', handleTap);
        tapCircle.addEventListener('touchstart', handleTap);
        
        // Hide loading screen
        loadingScreen.style.opacity = '0';
        setTimeout(() => {
            loadingScreen.style.display = 'none';
            gameScreen.style.display = 'flex';
        }, 500);
        
    } catch (error) {
        console.error('Initialization error:', error);
        loadingScreen.innerHTML = `<p>Error: ${error.message}</p><button onclick="location.reload()">Retry</button>`;
    }
}

// Start the game
document.addEventListener('DOMContentLoaded', initGame);
        
    </script>
</body>
</html>
