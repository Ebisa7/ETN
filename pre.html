<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tap Game</title>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <style>
        /* CSS styles are unchanged, so they are omitted for brevity. Paste your existing CSS here. */
        * { margin: 0; padding: 0; box-sizing: border-box; user-select: none; -webkit-tap-highlight-color: transparent; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; background: #1b1e2e; color: white; height: 100vh; overflow: hidden; }
        .loading-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #0f0f10; display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 100; transition: opacity 0.5s ease; }
        .loading-circle { width: 60px; height: 60px; border: 4px solid rgba(255, 255, 255, 0.1); border-top-color: #6e45e2; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .game-screen { display: none; height: calc(100% - 70px); flex-direction: column; }
        .header { padding: 15px; display: flex; justify-content: flex-end; }
        .profile { display: flex; align-items: center; gap: 10px; }
        .profile-pic { width: 40px; height: 40px; border-radius: 50%; background: #2a2a2b; display: flex; justify-content: center; align-items: center; overflow: hidden; }
        .profile-pic img { width: 100%; height: 100%; object-fit: cover; }
        .profile-name { font-weight: bold; font-size: 14px; }
        .balance-container { text-align: center; margin-top: 20px; }
        .balance-label { font-size: 14px; color: #aaa; margin-bottom: 5px; }
        .balance-amount { font-size: 36px; font-weight: bold; background: linear-gradient(to right, #6e45e2, #88d3ce); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .tap-area { flex: 1; display: flex; justify-content: center; align-items: center; position: relative; }
        .tap-circle { width: 280px; height: 280px; border-radius: 50%; background: linear-gradient(135deg, #2a2a2b, #1a1a1b); box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5); display: flex; justify-content: center; align-items: center; position: relative; cursor: pointer; transition: transform 0.1s ease; }
        .tap-circle:active { transform: scale(0.95); }
        .tap-circle-inner { width: 240px; height: 240px; border-radius: 50%; background: linear-gradient(135deg, #3a3a3c, #2a2a2b); display: flex; justify-content: center; align-items: center; font-size: 24px; font-weight: bold; color: white; }
        .coin-effect { position: absolute; font-size: 24px; font-weight: bold; color: #FFD700; opacity: 0; pointer-events: none; animation: float-up 1s ease-out forwards; }
        @keyframes float-up { 0% { transform: translateY(0) scale(0.8); opacity: 1; } 100% { transform: translateY(-100px) scale(1.2); opacity: 0; } }
        .page { display: none; position: fixed; top: 0; left: 0; width: 100%; height: calc(100% - 70px); background: #0f0f10; padding: 20px; overflow-y: auto; z-index: 5; }
        .page-header { text-align: center; margin-bottom: 20px; }
        .page-header h2 { font-size: 24px; margin-bottom: 8px; }
        .page-header p { color: #aaa; font-size: 14px; }
        .invite-link-container { display: flex; margin-bottom: 20px; background: #1a1a1b; border-radius: 12px; overflow: hidden; }
        .invite-link { flex: 1; padding: 15px; font-size: 14px; word-break: break-all; color: #88d3ce; }
        .copy-btn { background: #6e45e2; color: white; border: none; padding: 0 20px; font-weight: bold; cursor: pointer; transition: background 0.2s ease; }
        .copy-btn:active { background: #5a35c0; }
        .share-buttons { display: flex; justify-content: center; margin-bottom: 20px; }
        .share-btn { background: #0088cc; color: white; border: none; padding: 12px 20px; border-radius: 12px; font-size: 16px; display: flex; align-items: center; gap: 8px; cursor: pointer; transition: background 0.2s; }
        .share-btn:active { background: #006699; }
        .list-container { background: #1a1a1b; border-radius: 12px; padding: 15px; }
        .list-container h3 { margin-bottom: 15px; font-size: 18px; }
        .list-scrollable { max-height: 40vh; overflow-y: auto; }
        .user-card, .leaderboard-card { display: flex; align-items: center; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid #2a2a2b; }
        .user-card:last-child, .leaderboard-card:last-child { border-bottom: none; }
        .user-info { display: flex; align-items: center; gap: 12px; flex-grow: 1; }
        .user-avatar { width: 40px; height: 40px; border-radius: 50%; background: #2a2a2b; display: flex; justify-content: center; align-items: center; overflow: hidden; flex-shrink: 0; }
        .user-avatar img { width: 100%; height: 100%; object-fit: cover; }
        .user-name { font-weight: bold; font-size: 14px; }
        .user-balance { color: #88d3ce; font-weight: bold; flex-shrink: 0; }
        .empty-state { color: #666; text-align: center; padding: 20px 0; }
        .leaderboard-card .rank { font-size: 18px; font-weight: bold; width: 40px; text-align: center; color: #aaa; flex-shrink: 0; }
        .rank-1, .rank-2, .rank-3 { font-size: 24px; } .rank-1 { color: #FFD700; } .rank-2 { color: #C0C0C0; } .rank-3 { color: #CD7F32; }
        .bottom-nav { position: fixed; bottom: 0; left: 0; width: 100%; background: #1a1a1b; display: flex; padding-top: 10px; padding-bottom: 10px; border-top: 1px solid #2a2a2b; z-index: 10; }
        .nav-item { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; color: #888; cursor: pointer; transition: color 0.2s ease; }
        .nav-item.active { color: #6e45e2; }
        .nav-icon { font-size: 24px; margin-bottom: 4px; }
        .nav-label { font-size: 12px; }
        .games-container { display: flex; flex-direction: column; gap: 20px; padding: 0 10px; }
        .game-card { background: #1a1a1b; border-radius: 16px; overflow: hidden; box-shadow: 0 6px 16px rgba(0,0,0,0.3); transition: transform 0.3s ease, box-shadow 0.3s ease; cursor: pointer; }
        .game-card:active { transform: scale(0.98); }
        .game-card-header { padding: 20px; display: flex; align-items: center; gap: 15px; background: linear-gradient(90deg, #6e45e2, #88d3ce); }
        .game-icon { font-size: 28px; background: rgba(255,255,255,0.2); width: 50px; height: 50px; border-radius: 12px; display: flex; justify-content: center; align-items: center; }
        .game-title { font-size: 18px; font-weight: bold; }
        .game-subtitle { font-size: 14px; opacity: 0.9; }
        .game-card-body { padding: 20px; }
        .game-info { display: flex; justify-content: space-between; margin-bottom: 15px; font-size: 14px; }
        .game-info-item { display: flex; align-items: center; gap: 5px; }
        .game-info-item i { color: #6e45e2; }
        .prize-badge { background: linear-gradient(90deg, #ffd700, #ff9800); color: #000; padding: 5px 12px; border-radius: 20px; font-weight: bold; font-size: 14px; display: inline-flex; align-items: center; gap: 5px; }
        .tic-tac-toe-container { display: flex; flex-direction: column; height: 100%; }
        .game-header { padding: 20px; text-align: center; border-bottom: 1px solid #2a2a2b; }
        .game-header h2 { font-size: 24px; margin-bottom: 5px; }
        .game-status { font-size: 16px; color: #88d3ce; }
        .opponent-info { display: flex; justify-content: space-around; align-items: center; padding: 15px; margin: 10px 0; background: #1a1a1b; border-radius: 12px; }
        .player-card { display: flex; flex-direction: column; align-items: center; gap: 8px; }
        .player-avatar { width: 60px; height: 60px; border-radius: 50%; background: #2a2a2b; display: flex; justify-content: center; align-items: center; overflow: hidden; position: relative; }
        .player-avatar img { width: 100%; height: 100%; object-fit: cover; }
        .player-mark { position: absolute; bottom: -5px; right: -5px; background: #6e45e2; width: 30px; height: 30px; border-radius: 50%; display: flex; justify-content: center; align-items: center; font-weight: bold; font-size: 18px; border: 2px solid #1a1a1b; }
        .player-name { font-weight: bold; max-width: 100px; text-overflow: ellipsis; overflow: hidden; white-space: nowrap; }
        .vs { font-size: 20px; font-weight: bold; color: #888; }
        .board-container { flex: 1; display: flex; justify-content: center; align-items: center; padding: 20px; }
        .game-board { display: grid; grid-template-columns: repeat(3, 1fr); grid-gap: 10px; width: 300px; height: 300px; background: #2a2a2b; border-radius: 12px; padding: 10px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); }
        .cell { background: #1a1a1b; border-radius: 8px; display: flex; justify-content: center; align-items: center; font-size: 48px; font-weight: bold; cursor: pointer; transition: all 0.2s ease; }
        .cell:hover { background: #252528; }
        .cell.x { color: #6e45e2; }
        .cell.o { color: #88d3ce; }
        .cell.win { animation: win-cell 1s ease infinite; }
        @keyframes win-cell { 0%, 100% { background: rgba(110, 69, 226, 0.1); } 50% { background: rgba(110, 69, 226, 0.3); } }
        .game-controls { padding: 20px; display: flex; justify-content: center; gap: 15px; }
        .game-btn { background: #6e45e2; color: white; border: none; padding: 12px 30px; border-radius: 12px; font-size: 16px; font-weight: bold; display: flex; align-items: center; gap: 8px; cursor: pointer; transition: background 0.2s; }
        .game-btn:active { background: #5a35c0; }
        .game-btn.exit { background: #2a2a2b; }
        .lobby-container { padding: 20px; text-align: center; }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: none; justify-content: center; align-items: center; z-index: 20; opacity: 0; pointer-events: none; transition: opacity 0.3s ease; }
        .modal-overlay.show { display: flex; opacity: 1; pointer-events: all; }
        .modal-content { background: #1a1a1b; border-radius: 20px; width: 90%; max-width: 400px; padding: 30px; text-align: center; transform: translateY(20px); transition: transform 0.3s ease; }
        .modal-overlay.show .modal-content { transform: translateY(0); }
        .modal-icon { font-size: 60px; margin-bottom: 20px; }
        .modal-icon.win { color: #FFD700; }
        .modal-icon.draw { color: #88d3ce; }
        .modal-icon.loss { color: #e74c3c; }
        .modal-title { font-size: 28px; margin-bottom: 10px; }
        .modal-message { font-size: 18px; margin-bottom: 20px; color: #aaa; }
        .prize-amount { font-size: 24px; font-weight: bold; color: #FFD700; margin: 20px 0; }
        .modal-btn { background: #6e45e2; color: white; border: none; padding: 15px 30px; border-radius: 12px; font-size: 18px; font-weight: bold; width: 100%; cursor: pointer; transition: background 0.2s; }
        .modal-btn:active { background: #5a35c0; }
    </style>
</head>
<body>
    <!-- Loading Screen -->
    <div class="loading-screen" id="loadingScreen">
        <div class="loading-circle"></div>
        <p>Loading...</p>
    </div>
    
    <!-- Main Game Screen -->
    <div class="game-screen" id="gameScreen">
        <!-- Main Game HTML... -->
    </div>

    <!-- Invite Screen -->
    <div class="page" id="inviteScreen">
        <!-- Invite Screen HTML... -->
    </div>
    
    <!-- Leaderboard Screen -->
    <div class="page" id="leaderboardScreen">
        <!-- Leaderboard HTML... -->
    </div>
    
    <!-- Games Screen -->
    <div class="page" id="gamesScreen">
        <!-- Games Screen HTML... -->
    </div>
    
    <!-- Robot Game Screen -->
    <div class="page" id="robotGameScreen">
        <div class="game-header">
            <h2>Tic Tac Toe vs Robot</h2>
            <div class="game-status" id="robotGameStatus">Your turn! You are playing as X</div>
        </div>
        <div class="opponent-info">
            <div class="player-card">
                <div class="player-avatar" id="robotPlayerAvatar"><span>?</span><div class="player-mark">X</div></div>
                <div class="player-name" id="robotPlayerName">You</div>
            </div>
            <div class="vs">VS</div>
            <div class="player-card">
                <div class="player-avatar"><i class="fas fa-robot" style="font-size: 30px;"></i><div class="player-mark">O</div></div>
                <div class="player-name">Robot</div>
            </div>
        </div>
        <div class="board-container">
            <div class="game-board" id="robotBoard">
                <div class="cell" data-index="0"></div><div class="cell" data-index="1"></div><div class="cell" data-index="2"></div>
                <div class="cell" data-index="3"></div><div class="cell" data-index="4"></div><div class="cell" data-index="5"></div>
                <div class="cell" data-index="6"></div><div class="cell" data-index="7"></div><div class="cell" data-index="8"></div>
            </div>
        </div>
        <div class="game-controls">
            <button class="game-btn exit" id="exitRobotGame"><i class="fas fa-arrow-left"></i> Exit</button>
            <button class="game-btn" id="restartRobotGame"><i class="fas fa-redo"></i> Restart</button>
        </div>
    </div>
    
    <!-- P2P Game Screen -->
    <div class="page" id="pvpGameScreen">
        <div class="game-header">
            <h2>Tic Tac Toe vs Player</h2>
            <div class="game-status" id="pvpGameStatus">Setting up...</div>
        </div>
        <div class="opponent-info" id="pvpOpponentInfo" style="display: none;">
            <div class="player-card">
                <div class="player-avatar" id="player1Avatar"><span>?</span></div>
                <div class="player-name" id="player1Name">Player 1</div>
            </div>
            <div class="vs">VS</div>
            <div class="player-card">
                <div class="player-avatar" id="player2Avatar"><i class="fas fa-user-clock" style="font-size: 24px;"></i></div>
                <div class="player-name" id="player2Name">Waiting...</div>
            </div>
        </div>
        <div class="lobby-container" id="pvpLobby"></div>
        <div class="board-container" id="pvpBoardContainer" style="display: none;">
            <div class="game-board" id="pvpBoard">
                 <div class="cell" data-index="0"></div><div class="cell" data-index="1"></div><div class="cell" data-index="2"></div>
                 <div class="cell" data-index="3"></div><div class="cell" data-index="4"></div><div class="cell" data-index="5"></div>
                 <div class="cell" data-index="6"></div><div class="cell" data-index="7"></div><div class="cell" data-index="8"></div>
            </div>
        </div>
        <div class="game-controls">
            <button class="game-btn exit" id="exitPvpGame"><i class="fas fa-arrow-left"></i> Back</button>
        </div>
    </div>
    
    <!-- Game Result Modal -->
    <div class="modal-overlay" id="gameResultModal">
        <!-- Modal HTML... -->
    </div>

    <!-- Bottom Navigation -->
    <div class="bottom-nav" id="bottomNav">
        <!-- Nav items... -->
    </div>

    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBX3g8wWxcTtwFDsJNJVcjUDIGxMd1L0Rk",
            authDomain: "mytestapp-f6913.firebaseapp.com",
            databaseURL: "https://mytestapp-f6913-default-rtdb.firebaseio.com",
            projectId: "mytestapp-f6913",
            storageBucket: "mytestapp-f6913.appspot.com",
            messagingSenderId: "300150696072",
            appId: "1:300150696072:web:1e29cb5a813d004018573d",
            measurementId: "G-PPDR4TBQF5"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.database();

        // DOM Elements
        // (get all your DOM elements here)

        // Game state
        let balance = 0;
        let firebaseUser = null;
        let userDocRef = null;
        let userData = null; // MODIFIED: Start as null
        let coinsPerTap = 1;
        let invitedBy = null;
        const botUsername = 'your_telegram_bot_username_here'; // IMPORTANT: REPLACE

        // Global PvP state
        let pvpGameUnsubscribe = null;
        let currentGameId = null;
        let gameMode = null; // 'robot' or 'pvp'
        
        // ... (padTelegramId, createCoinEffect, sendTelegramMessage functions) ...
        
        function handleTap(e) {
            // MODIFIED: Added a guard clause
            if (!firebaseUser) return;
            e.preventDefault();
            balance += coinsPerTap;
            balanceDisplay.textContent = balance.toLocaleString();
            if (userDocRef) {
                userDocRef.child('balance').set(firebase.database.ServerValue.increment(coinsPerTap));
            }
        }

        // --- Tic Tac Toe Main Logic ---
        function initTicTacToe() {
            // Get all DOM elements for games...
            const pvpGameCard = document.getElementById('pvpGameCard');
            const robotGameCard = document.getElementById('robotGameCard');
            // ... and so on

            // ... (Robot game logic can be pasted here, it's mostly self-contained) ...
            
            // --- PvP Game Logic ---
            async function endAndCleanPvpGame() {
                // ... (implementation is fine) ...
            }

            async function quitPvpGame() {
                // ... (implementation is fine) ...
            }

            function updatePvpUI(gameData) {
                // ... (implementation is fine) ...
            }

            function listenForPvpUpdates(gameId) {
                // ... (implementation is fine) ...
            }
            
            // MODIFIED: Added a global function to handle joining
            window.joinPvpGame = async (gameId) => {
                // MODIFIED: The most critical guard clause
                if (!firebaseUser || !userData) {
                    alert("Your user profile is still loading. Please wait a moment and try the link again.");
                    return;
                }
                
                const gameRef = db.ref('games/' + gameId);
                const snapshot = await gameRef.get();

                if (!snapshot.exists() || snapshot.val().status !== 'waiting') {
                    alert("This game is no longer available.");
                    switchTab('game');
                    return;
                }

                const gameData = snapshot.val();
                if (gameData.player1Id === firebaseUser.uid) { 
                    listenForPvpUpdates(gameId);
                    switchTab('pvpGame');
                    return;
                }
                
                // Player 2 joining logic...
                const updates = {
                    player2Id: firebaseUser.uid,
                    player2Data: userData,
                    status: 'active',
                    gameActive: true,
                    board: Array(9).fill(''),
                    currentPlayerId: Math.random() < 0.5 ? gameData.player1Id : firebaseUser.uid,
                    players: {
                        [gameData.player1Id]: { mark: 'X' },
                        [firebaseUser.uid]: { mark: 'O' }
                    }
                };
                await gameRef.update(updates);
                listenForPvpUpdates(gameId);
                switchTab('pvpGame');
            };
            
            async function createPvpGame() {
                // MODIFIED: Another critical guard clause
                if (!firebaseUser || !userData) {
                    alert("Cannot create a game until your profile is loaded. Please wait a moment.");
                    return;
                }
                
                gameMode = 'pvp';
                switchTab('pvpGame');
                document.getElementById('pvpLobby').innerHTML = '<div class="empty-state">Creating your private match...</div>';

                const newGameRef = db.ref('games').push();
                const gameData = {
                    gameId: newGameRef.key,
                    player1Id: firebaseUser.uid,
                    player1Data: userData,
                    status: 'waiting',
                    createdAt: firebase.database.ServerValue.TIMESTAMP
                };
                await newGameRef.set(gameData);
                listenForPvpUpdates(newGameRef.key);
            }
            
            pvpGameCard.addEventListener('click', createPvpGame);
            // ... (other event listeners like exitPvpGameBtn, modalBtn etc) ...
        }

        // ... (switchTab, loadLeaderboard, loadInvitedUsers functions) ...

        async function initGame() {
            try {
                Telegram.WebApp.ready();
                Telegram.WebApp.expand();
                
                if (!window.Telegram?.WebApp?.initDataUnsafe?.user) {
                     throw new Error('Could not verify Telegram user. Please open in the Telegram app.');
                }
                
                const tgUser = Telegram.WebApp.initDataUnsafe.user;
                const email = `${tgUser.username || tgUser.id}@telegram.user`;
                const password = padTelegramId(tgUser.id);
                
                try {
                    const userCredential = await auth.signInWithEmailAndPassword(email, password);
                    firebaseUser = userCredential.user;
                } catch (error) {
                    if (error.code === 'auth/user-not-found' || error.code === 'auth/email-already-in-use') {
                        const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                        firebaseUser = userCredential.user;
                    } else {
                        // For other auth errors, re-throw to be caught by the outer catch block
                        throw error;
                    }
                }

                // From this point on, firebaseUser is guaranteed to be set
                userDocRef = db.ref('users/' + firebaseUser.uid);
                const userSnapshot = await userDocRef.get();
                
                if (!userSnapshot.exists()) {
                    // New user creation logic...
                    // ... (your existing logic for creating a new user is fine) ...
                    userData = { /* ...new user data object... */ };
                    await userDocRef.set(userData);
                } else {
                    userData = userSnapshot.val();
                }

                balance = userData.balance || 0;
                
                // Now setup the UI
                // ... (set profile pic, name, balance display) ...
                
                // Initialize all game event listeners
                initTicTacToe(); 

                // Check start parameter for direct game join
                const startParam = Telegram.WebApp.initDataUnsafe.start_param;
                if (startParam && startParam.startsWith('game_')) {
                    const gameIdToJoin = startParam.replace('game_', '');
                    // User came from a game link, attempt to join
                    window.joinPvpGame(gameIdToJoin);
                } else {
                     // Normal start, show the main game screen
                     switchTab('game');
                }
                
                // Hide loading screen
                loadingScreen.style.opacity = '0';
                setTimeout(() => { loadingScreen.style.display = 'none'; }, 500);
                
            } catch (error) {
                console.error('Initialization Error:', error);
                // MODIFIED: More robust error display
                loadingScreen.innerHTML = `<p style="color:red; padding: 20px; text-align: center;">An error occurred during startup:<br>${error.message}<br><br>Please try restarting the app.</p>`;
            }
        }

        document.addEventListener('DOMContentLoaded', initGame);
    </script>
</body>
</html>
