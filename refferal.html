<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Telegram Stars Payment</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
        }
        input, button {
            padding: 10px;
            margin: 5px 0;
            width: 100%;
            box-sizing: border-box;
        }
        .transaction {
            border: 1px solid #ccc;
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 5px;
        }
        .transaction button {
            background-color: #dc3545;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
        }
        .transaction button:hover {
            background-color: #c82333;
        }
    </style>
</head>
<body>
    <h1>Telegram Stars Payment</h1>
    <input type="number" id="amount" placeholder="Enter amount in Stars" min="1">
    <button onclick="sendPayment()">Send Stars</button>

    <h2>Transaction History</h2>
    <div id="history">
        <!-- Transactions will be dynamically inserted here -->
    </div>

    <script>
        const BOT_TOKEN = '7676381576:AAGkIhPfuEupEW5_1QtqSe4ytTcR2bcfQFo'; // Replace with your bot token
        let transactions = []; // Store transaction history

        // Initialize the Web App
        Telegram.WebApp.ready();
        console.log('WebApp initialized:', Telegram.WebApp.initDataUnsafe);

        // Function to send payment
        async function sendPayment() {
            const amount = document.getElementById('amount').value;
            if (!amount || amount < 1) {
                alert('Please enter a valid amount.');
                return;
            }

            try {
                const payload = `payment_${Date.now()}`;
                const requestBody = {
                    chat_id: Telegram.WebApp.initDataUnsafe.user.id,
                    title: `Payment of ${amount} Stars`,
                    description: 'Thank you for your payment!',
                    payload: payload,
                    provider_token: "", // Empty for digital goods
                    currency: "XTR", // Telegram Stars currency code
                    prices: [{ label: 'Stars', amount: amount * 100 }], // Amount in cents
                    start_parameter: "start_parameter"
                };

                console.log('Sending invoice request:', requestBody);

                const response = await fetch(`https://api.telegram.org/bot${BOT_TOKEN}/sendInvoice`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestBody)
                });

                const data = await response.json();
                console.log('Invoice response:', data);

                if (data.ok) {
                    Telegram.WebApp.openInvoice(data.result.invoice_payload, function(status) {
                        console.log('Payment status:', status);
                        if (status === 'paid') {
                            const transaction = {
                                id: data.result.invoice_payload,
                                amount: amount,
                                status: 'Paid'
                            };
                            transactions.push(transaction);
                            updateHistory();
                            alert('Payment successful!');
                        } else {
                            alert('Payment failed or was cancelled.');
                        }
                    });
                } else {
                    alert('Failed to create invoice.');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('An error occurred while processing your request.');
            }
        }

        // Function to refund a transaction
        async function refundTransaction(transactionId) {
            try {
                const response = await fetch(`https://api.telegram.org/bot${BOT_TOKEN}/refundStarPayment`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        user_id: Telegram.WebApp.initDataUnsafe.user.id,
                        telegram_payment_charge_id: transactionId
                    })
                });

                const data = await response.json();
                console.log('Refund response:', data);

                if (data.ok) {
                    const transaction = transactions.find(t => t.id === transactionId);
                    if (transaction) {
                        transaction.status = 'Refunded';
                        updateHistory();
                        alert('Refund processed successfully!');
                    }
                } else {
                    alert('Refund could not be processed.');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('An error occurred while processing your refund.');
            }
        }

        // Function to update transaction history
        function updateHistory() {
            const historyContainer = document.getElementById('history');
            historyContainer.innerHTML = transactions.map(transaction => `
                <div class="transaction">
                    <p>ID: ${transaction.id}</p>
                    <p>Amount: ${transaction.amount} Stars</p>
                    <p>Status: ${transaction.status}</p>
                    ${transaction.status === 'Paid' ? `<button onclick="refundTransaction('${transaction.id}')">Refund</button>` : ''}
                </div>
            `).join('');
        }

        // Initialize the Web App
        updateHistory();
    </script>
</body>
</html>
