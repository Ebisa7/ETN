<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Telegram Referral System</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, doc, setDoc, getDocs, collection, query, where, addDoc } 
        from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // ✅ Firebase Config
        const firebaseConfig = {
            apiKey: "AIzaSyA_S5XfXJ7iyLIrPBOPkvP0110vXjzhqEg",
            authDomain: "etndrop-bc9c3.firebaseapp.com",
            projectId: "etndrop-bc9c3",
            storageBucket: "etndrop-bc9c3.firebasestorage.app",
            messagingSenderId: "1017600425514",
            appId: "1:1017600425514:web:f65bb6ee44f86da2014d53"
        };

        // ✅ Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // ✅ Telegram WebApp
        let tg = window.Telegram.WebApp;
        tg.expand(); // Expand to full height

        // ✅ Get User Info
        let userId = tg.initDataUnsafe.user ? tg.initDataUnsafe.user.id : null;
        let referrerId = tg.initDataUnsafe.start_param || null;

        async function registerUser() {
            if (!userId) {
                document.getElementById("message").innerText = "❌ Failed to get Telegram ID.";
                return;
            }

            // 🔍 Check if user already exists
            const userRef = doc(db, "users", userId);
            const userSnapshot = await getDocs(query(collection(db, "users"), where("__name__", "==", userId)));

            if (!userSnapshot.empty) {
                document.getElementById("message").innerText = "✅ You're already using the bot!";
                return;
            }

            // 🔥 Add user to Firestore
            await setDoc(userRef, { joined_at: new Date() });

            // 🔍 Check if user was already referred before
            const referralQuery = await getDocs(query(collection(db, "referrals"), where("referred_user", "==", userId)));

            if (!referralQuery.empty) {
                document.getElementById("message").innerText = "🎉 You were already referred!";
                return;
            }

            // 🔥 Add Referral (if valid referrer)
            if (referrerId && referrerId !== userId) {
                await addDoc(collection(db, "referrals"), {
                    referrer: referrerId,
                    referred_user: userId,
                    joined_at: new Date()
                });

                document.getElementById("message").innerText = `🎊 You were referred by User ID: ${referrerId}`;
            } else {
                document.getElementById("message").innerText = "✅ You have joined!";
            }
        }

        async function showReferrals() {
            if (!userId) return;

            // 🔍 Get referrals from Firestore
            const querySnapshot = await getDocs(query(collection(db, "referrals"), where("referrer", "==", userId)));
            let referredUsers = [];
            querySnapshot.forEach((doc) => {
                referredUsers.push(doc.data().referred_user);
            });

            // 📝 Display referred users
            document.getElementById("referrals").innerHTML = referredUsers.length ?
                "👥 Your referrals: <br>" + referredUsers.join("<br>") :
                "😕 You haven't referred anyone yet.";
        }

        // ✅ Run Functions
        registerUser();
        setTimeout(showReferrals, 2000);

    </script>
</head>
<body>

    <h2>Telegram Referral Mini App</h2>
    <p id="message">Loading...</p>
    <h3>Your Referrals:</h3>
    <p id="referrals">Loading...</p>

</body>
</html>
