<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Digital Store</title>
    <script src="https://telegram.org/js/telegram-webapp.js"></script>
    <script src="https://unpkg.com/@tailwindcss/browser@4"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .hidden {
            display: none;
        }
        .error {
            color: red;
        }
        .success {
            color: green;
        }
        .item-button {
            @apply w-full bg-blue-500 hover:bg-blue-700 text-white font-semibold rounded-md py-2 transition duration-300 ease-in-out text-center;
        }
        .refund-button {
            @apply w-full bg-red-500 hover:bg-red-700 text-white font-semibold rounded-md py-2 transition duration-300 ease-in-out;
        }
        .verify-button {
            @apply w-full bg-green-500 hover:bg-green-700 text-white font-semibold rounded-md py-2 transition duration-300 ease-in-out text-center;
        }
    </style>
    <script>
        const Telegram = window.Telegram;
        const WebApp = Telegram.WebApp;
        //WebApp.ready(); // Remove this line
    </script>
</head>
<body class="bg-gray-100 dark:bg-gray-900 flex items-center justify-center min-h-screen">
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-8 w-full max-w-md">
        <h1 class="text-2xl font-semibold text-gray-900 dark:text-white mb-6 text-center">Digital Store</h1>

        <div id="mainContent" class="space-y-4">
            <p id="welcomeMessage" class="text-gray-700 dark:text-gray-300 text-center">
                Welcome to the Digital Store! ðŸŽ‰ Select an item to purchase with Telegram Stars:
            </p>

            <div id="itemList" class="space-y-2">
                </div>

            <div id="refundSection" class="hidden space-y-4">
                <h2 class="text-xl font-semibold text-gray-900 dark:text-white mt-6">Refund</h2>
                <p class="text-gray-700 dark:text-gray-300">Enter the Telegram payment charge ID to request a refund.</p>
                <input type="text" id="refundChargeId" placeholder="Enter charge ID" class="w-full px-4 py-2 rounded-md border border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-900 text-gray-900 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                <div id="refundResult" class="mt-2 text-center font-medium"></div>
                <button id="refundButton" class="refund-button">
                    Refund
                </button>
            </div>

            <div id="verificationSection" class="hidden space-y-4">
                <h2 class="text-xl font-semibold text-gray-900 dark:text-white mt-6">Verify Payment</h2>
                <p class="text-gray-700 dark:text-gray-300">Click the button below to verify your payment.</p>
                <div id="verificationResult" class="mt-2 text-center font-medium"></div>
                <button id="verifyButton" class="verify-button">
                    Verify Payment
                </button>
            </div>

            <div id="errorContainer" class="mt-4 text-center text-red-500 font-semibold rounded-md py-2 px-4 bg-red-100 dark:bg-red-900 dark:text-red-300 hidden"></div>
        </div>
    </div>

    <script>
        //  bot token
        const BOT_TOKEN = '7676381576:AAGkIhPfuEupEW5_1QtqSe4ytTcR2bcfQFo'; //  Replace with your actual bot token
        const ITEMS = {
            'ice_cream': {
                name: 'Ice Cream ðŸ¦',
                price: 1,
                description: 'A delicious virtual ice cream',
                secret: 'FROZEN2025'
            },
            'cookie': {
                name: 'Cookie ðŸª',
                price: 3,
                description: 'A sweet virtual cookie',
                secret: 'SWEET2025'
            },
            'hamburger': {
                name: 'Hamburger ðŸ”',
                price: 5,
                description: 'A tasty virtual hamburger',
                secret: 'BURGER2025'
            }
        };

        const MESSAGES = {
            'welcome': "Welcome to the Digital Store! ðŸŽ‰ Select an item to purchase with Telegram Stars:",
            'help': "ðŸ› *Digital Store Bot Help*\n\n" +
                "Commands:\n" +
                "/start - View available items\n" +
                "/help - Show this help message\n" +
                "/refund - Request a refund (requires transaction ID)\n\n" +
                "How to use:\n" +
                "1. Use /start to see available items\n" +
                "2. Click on an item to purchase\n" +
                "3. Pay with Stars\n" +
                "4. Receive your secret code\n" +
                "5. Use /refund to get a refund if needed",
            'refund_success': "âœ… Refund processed successfully!\nThe Stars have been returned to your balance.",
            'refund_failed': "âŒ Refund could not be processed.\nPlease try again later or contact support.",
            'refund_usage': "Please provide the transaction ID after the /refund command.\nExample: `/refund YOUR_TRANSACTION_ID`"
        };

        const Telegram = window.Telegram;
        const WebApp = Telegram.WebApp;

        //WebApp.ready(); // Remove this line

        const mainContent = document.getElementById('mainContent');
        const itemList = document.getElementById('itemList');
        const refundButton = document.getElementById('refundButton');
        const refundChargeIdInput = document.getElementById('refundChargeId');
        const refundResult = document.getElementById('refundResult');
        const refundSection = document.getElementById('refundSection');
        const errorContainer = document.getElementById('errorContainer');
        const verificationSection = document.getElementById('verificationSection');
        const verifyButton = document.getElementById('verifyButton');
        const verificationResult = document.getElementById('verificationResult');
        const welcomeMessage = document.getElementById('welcomeMessage');


        let chargeId = null;
        let isSandbox = true;
        let paymentVerified = false;

        function showError(message) {
            errorContainer.textContent = message;
            errorContainer.classList.remove('hidden');
        }

        function hideError() {
            errorContainer.classList.add('hidden');
            errorContainer.textContent = '';
        }

        function addItemList() {
            itemList.innerHTML = '';
            for (const itemId in ITEMS) {
                const item = ITEMS[itemId];
                const itemButton = document.createElement('button');
                itemButton.className = 'item-button';
                itemButton.textContent = `${item.name} - ${item.price} â­`;
                itemButton.dataset.itemId = itemId;
                itemButton.addEventListener('click', handleItemClick);
                itemList.appendChild(itemButton);
            }
        }

        function handleItemClick(event) {
            hideError();
            const itemId = event.target.dataset.itemId;
            const item = ITEMS[itemId];

            if (WebApp && WebApp.initData) {
                WebApp.invoke('sendInvoice', {
                    title: item.name,
                    description: item.description,
                    payload: itemId,
                    provider_token: BOT_TOKEN,
                    currency: 'XTR',
                    prices: [{ label: item.name, amount: item.price * 100 }],
                    start_parameter: 'start_parameter',
                    is_test: isSandbox
                }).then(result => {
                    if (result.ok) {
                        chargeId = result.order_info.charge_id;
                        console.log('Payment successful! Charge ID:', chargeId);
                        alert(`Payment successful! Charge ID: ${chargeId}. To complete your purchase, please send ${item.price} Stars to the bot and then click "Verify Payment".`);
                        refundSection.classList.remove('hidden');
                        verificationSection.classList.remove('hidden');
                    } else {
                        console.error('Payment failed:', result.error);
                        showError(`Payment failed: ${result.error}`);
                    }
                }).catch(error => {
                    console.error('Error initiating payment:', error);
                    showError(`Error initiating payment: ${error.message}`);
                });
            } else {
                alert("Payment not initiated.  This page is not running in Telegram.");
            }

        }

        refundButton.addEventListener('click', () => {
            hideError();
            const chargeIdToRefund = refundChargeIdInput.value.trim();
            if (!chargeIdToRefund) {
                showError('Please enter the charge ID for the refund.');
                return;
            }
            if (WebApp && WebApp.initData) {
                WebApp.invoke('refund', {
                    charge_id: chargeIdToRefund,
                    amount: 1000,
                    reason: 'Customer request',
                    is_test: isSandbox
                }).then(result => {
                    if (result.ok) {
                        refundResult.textContent = 'Refund successful!';
                        refundResult.classList.remove('text-red-500');
                        refundResult.classList.add('text-green-500');
                        console.log('Refund successful!');
                        alert('Refund successful!');
                        chargeId = null;
                        refundSection.classList.add('hidden');
                        verificationSection.classList.add('hidden');
                        paymentVerified = false;
                        refundChargeIdInput.value = '';
                    } else {
                        refundResult.textContent = `Refund failed: ${result.error}`;
                        refundResult.classList.add('text-red-500');
                        refundResult.classList.remove('text-green-500');
                        console.error('Refund failed:', result.error);
                        showError(`Refund failed: ${result.error}`);
                    }
                }).catch(error => {
                    refundResult.textContent = `Error initiating refund: ${error.message}`;
                    refundResult.classList.add('text-red-500');
                    refundResult.classList.remove('text-green-500');
                    console.error('Error initiating refund:', error);
                    showError(`Error initiating refund: ${error.message}`);
                });
            } else {
                 alert("Refund not initiated.  This page is not running in Telegram.");
            }
        });

        verifyButton.addEventListener('click', () => {
            hideError();
            setTimeout(() => {
                if (chargeId && !paymentVerified) {
                    verificationResult.textContent = 'Payment verified successfully!';
                    verificationResult.classList.remove('text-red-500');
                    verificationResult.classList.add('text-green-500');
                    paymentVerified = true;
                    alert('Payment verified! Thank you for your purchase.');
                } else if (paymentVerified) {
                    verificationResult.textContent = 'Payment already verified.';
                    verificationResult.classList.remove('text-red-500');
                    verificationResult.classList.add('text-green-500');
                } else {
                    verificationResult.textContent = 'Payment verification failed. Please ensure you have sent the Stars to the bot.';
                    verificationResult.classList.add('text-red-500');
                    verificationResult.classList.remove('text-green-500');
                    showError('Payment verification failed. Please ensure you have sent the Stars to the bot.');
                }
            }, 2000);
        });

        // Initialize the item list on page load
        addItemList();
    </script>
</body>
</html>
