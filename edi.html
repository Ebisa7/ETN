<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>--Quiz Card Social Preview</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/html-to-image@1.11.11/dist/html-to-image.js"></script>
    <!-- The following meta tags will be dynamically set via JS -->
    <meta property="og:title" content="" id="meta-og-title">
    <meta property="og:description" content="" id="meta-og-description">
    <meta property="og:image" content="" id="meta-og-image">
    <meta property="og:url" content="" id="meta-og-url">
    <meta property="og:type" content="website">
    <meta property="og:locale" content="en_US">
    <style>
        /* ...styles unchanged... */
        :root {
            --background: 231 48% 94%;
            --foreground: 222 47% 11%;
            --card: 231 48% 99%;
            --card-foreground: 222 47% 11%;
            --primary: 40 96% 56%;
            --primary-foreground: 222 47% 11%;
            --secondary: 0 0% 100%;
            --secondary-foreground: 222 47% 11%;
            --muted: 231 48% 90%;
            --muted-foreground: 222 47% 40%;
            --destructive: 0 84.2% 60.2%;
            --destructive-foreground: 0 0% 98%;
            --border: 231 48% 88%;
        }
        /* ...rest of the CSS unchanged... */
    </style>
</head>
<body>
    <button class="download-btn" onclick="downloadImage()" style="display: none;">Download PNG</button>
    <div class="quiz-card-container">
        <div class="quiz-card" style="--dominant-color: #3b82f6;">
            <!-- Glow Effect -->
            <div class="glow-effect"></div>
            
            <!-- Content Wrapper -->
            <div class="card-content-wrapper">
                <!-- Left: Content Section -->
                <div class="content-section">
                    <h3 class="quiz-title" id="quiz-title">JavaScript Fundamentals</h3>
                    <p class="quiz-description" id="quiz-description">Test your knowledge of JavaScript basics including variables, functions, arrays, and object-oriented programming concepts.</p>
                    <div class="badges-container">
                        <div class="badge badge-outline">
                            <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                                <polyline points="14,2 14,8 20,8"/>
                                <line x1="16" y1="13" x2="8" y2="13"/>
                                <line x1="16" y1="17" x2="8" y2="17"/>
                                <polyline points="10,9 9,9 8,9"/>
                            </svg>
                            <span id="questions-text">15 Questions</span>
                        </div>
                        <div class="badge badge-outline" id="time-badge">
                            <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="12" cy="12" r="10"/>
                                <polyline points="12,6 12,12 16,14"/>
                            </svg>
                            <span id="time-text">20 min</span>
                        </div>
                    </div>
                </div>
                
                <!-- Right: Image Section -->
                <div class="image-section">
                    <img src="" alt="Quiz Image" class="quiz-image" id="quiz-image" crossorigin="anonymous">
                </div>
                
            </div>
        </div>
    </div>

    <script>
        // Dominant color extraction from image
        function extractDominantColor(imageElement) {
            return new Promise((resolve) => {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                
                canvas.width = imageElement.naturalWidth || imageElement.width;
                canvas.height = imageElement.naturalHeight || imageElement.height;
                
                ctx.drawImage(imageElement, 0, 0, canvas.width, canvas.height);
                
                try {
                    const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                    const data = imageData.data;
                    
                    // Sample pixels and count colors
                    const colorCount = {};
                    const step = 5; // Sample every 5th pixel for performance
                    
                    for (let i = 0; i < data.length; i += 4 * step) {
                        const r = data[i];
                        const g = data[i + 1];
                        const b = data[i + 2];
                        const alpha = data[i + 3];
                        
                        // Skip transparent pixels
                        if (alpha < 128) continue;
                        
                        // Skip very light or very dark colors
                        const brightness = (r + g + b) / 3;
                        if (brightness < 30 || brightness > 220) continue;
                        
                        // Group similar colors
                        const colorKey = `${Math.floor(r/20)*20},${Math.floor(g/20)*20},${Math.floor(b/20)*20}`;
                        colorCount[colorKey] = (colorCount[colorKey] || 0) + 1;
                    }
                    
                    // Find the most common color
                    let dominantColor = null;
                    let maxCount = 0;
                    
                    for (const [color, count] of Object.entries(colorCount)) {
                        if (count > maxCount) {
                            maxCount = count;
                            dominantColor = color;
                        }
                    }
                    
                    if (dominantColor) {
                        const [r, g, b] = dominantColor.split(',').map(Number);
                        resolve(`rgb(${r}, ${g}, ${b})`);
                    } else {
                        // Fallback to primary color
                        resolve('hsl(40, 96%, 56%)');
                    }
                } catch (error) {
                    console.warn('Could not extract color from image:', error);
                    resolve('hsl(40, 96%, 56%)');
                }
            });
        }

        // Set dominant color from image
        async function setDominantColorFromImage() {
            const img = document.querySelector('.quiz-image');
            
            if (img.complete) {
                const color = await extractDominantColor(img);
                document.querySelector('.quiz-card').style.setProperty('--dominant-color', color);
            } else {
                img.addEventListener('load', async () => {
                    const color = await extractDominantColor(img);
                    document.querySelector('.quiz-card').style.setProperty('--dominant-color', color);
                });
            }
        }

        // Download functionality using html-to-image
        async function downloadImage() {
            const button = document.querySelector('.download-btn');
            const preview = document.querySelector('.quiz-card');
            
            if (!preview) return;
            
            try {
                button.disabled = true;
                button.textContent = 'Generating...';
                
                // Wait for fonts to load
                await document.fonts.ready;
                
                // Get the actual dimensions of the card
                const rect = preview.getBoundingClientRect();
                const scale = 1200 / rect.width; // Scale to ensure 1200px width
                
                // Generate PNG using html-to-image
                const dataUrl = await htmlToImage.toPng(preview, {
                    cacheBust: true,
                    backgroundColor: 'transparent',
                    width: 1200,
                    height: 630,
                    style: {
                        transform: `scale(${scale})`,
                        transformOrigin: 'top left',
                        width: '1200px',
                        height: '630px'
                    },
                    pixelRatio: 1
                });
                
                // Create download link
                const link = document.createElement('a');
                link.download = getDownloadFilename();
                link.href = dataUrl;
                link.click();
                
            } catch (error) {
                console.error('Error generating image:', error);
                alert('Failed to generate image. Please try again.');
            } finally {
                button.disabled = false;
                button.textContent = 'Download PNG';
            }
        }

        // Parse URL parameters
        function getUrlParams() {
            const params = new URLSearchParams(window.location.search);
            return {
                title: params.get('title') || 'JavaScript Fundamentals',
                description: params.get('description') || params.get('deskreption') || 'Test your knowledge of JavaScript basics including variables, functions, arrays, and object-oriented programming concepts.',
                imageurl: params.get('imageurl') || params.get('image') || 'https://quiz-lt.pages.dev/lt-ai.png',
                questions: params.get('questions') || '15',
                time: params.get('time') || '20',
            };
        }

        // Update og meta tags based on URL parameters
        function updateOgMetaTags(params) {
            // Title
            const ogTitle = document.getElementById('meta-og-title');
            if (ogTitle) ogTitle.setAttribute('content', params.title);

            // Description
            const ogDescription = document.getElementById('meta-og-description');
            if (ogDescription) ogDescription.setAttribute('content', params.description);

            // Image
            const ogImage = document.getElementById('meta-og-image');
            if (ogImage) ogImage.setAttribute('content', params.imageurl);

            // URL (canonical current URL with parameters)
            const ogUrl = document.getElementById('meta-og-url');
            if (ogUrl) ogUrl.setAttribute('content', window.location.href);
        }

        // Update content based on URL parameters
        function updateContentFromUrl() {
            const params = getUrlParams();
            
            // Update title
            document.getElementById('quiz-title').textContent = params.title;
            document.title = `${params.title} - Quiz Card Preview`;
            
            // Update description
            document.getElementById('quiz-description').textContent = params.description;
            
            // Update image
            const img = document.getElementById('quiz-image');
            img.src = params.imageurl;
            img.alt = params.title;
            
            // Update questions
            document.getElementById('questions-text').textContent = `${params.questions} Questions`;
            
            // Update time (hide if not provided or 0)
            const timeBadge = document.getElementById('time-badge');
            const timeText = document.getElementById('time-text');
            if (params.time && params.time !== '0') {
                timeText.textContent = `${params.time} min`;
                timeBadge.style.display = 'inline-flex';
            } else {
                timeBadge.style.display = 'none';
            }

            // Update OG meta tags
            updateOgMetaTags(params);
        }

        // Update download filename to use dynamic title
        function getDownloadFilename() {
            const params = getUrlParams();
            const filename = params.title.toLowerCase()
                .replace(/[^a-z0-9\s-]/g, '')
                .replace(/\s+/g, '-')
                .replace(/-+/g, '-')
                .trim();
            return `${filename || 'quiz-card'}-preview.png`;
        }

        // Auto-generate image and return as blob URL
        async function generateImageBlob() {
            const preview = document.querySelector('.quiz-card');
            if (!preview) return null;
            
            try {
                // Wait for fonts and image to load
                await document.fonts.ready;
                await new Promise(resolve => {
                    const img = document.getElementById('quiz-image');
                    if (img.complete) {
                        resolve();
                    } else {
                        img.addEventListener('load', resolve);
                        img.addEventListener('error', resolve);
                    }
                });
                
                // Add image mode class to hide UI
                document.body.classList.add('image-mode');
                
                // Generate PNG
                const dataUrl = await htmlToImage.toPng(preview, {
                    cacheBust: true,
                    backgroundColor: 'transparent',
                    width: 1200,
                    height: 630,
                    pixelRatio: 1
                });
                
                return dataUrl;
            } catch (error) {
                console.error('Error generating image:', error);
                return null;
            }
        }

        // Wait for all content to be ready
        async function waitForContentReady() {
            // Wait for fonts
            await document.fonts.ready;
            
            // Wait for image to load and color extraction to complete
            const img = document.getElementById('quiz-image');
            if (img.src) {
                await new Promise(resolve => {
                    if (img.complete) {
                        resolve();
                    } else {
                        img.addEventListener('load', resolve);
                        img.addEventListener('error', resolve);
                    }
                });
                
                // Wait for color extraction and DOM updates
                await setDominantColorFromImage();
                
                // Give extra time for DOM updates and style application
                await new Promise(resolve => setTimeout(resolve, 500));
            }
        }

        // Check if we should return image directly
        async function handleImageMode() {
            const urlParams = new URLSearchParams(window.location.search);
            const returnImage = urlParams.get('return') === 'image' || urlParams.get('format') === 'png';
            
            if (returnImage) {
                // Wait for everything to be ready
                await waitForContentReady();
                
                // Generate and return image
                const imageDataUrl = await generateImageBlob();
                if (imageDataUrl) {
                    // Convert data URL to blob
                    const response = await fetch(imageDataUrl);
                    const blob = await response.blob();
                    
                    // Create object URL and redirect
                    const objectUrl = URL.createObjectURL(blob);
                    window.location.replace(objectUrl);
                }
            }
        }

        // Initialize on page load
        window.addEventListener('load', async () => {
            updateContentFromUrl();
            
            // Check if we need to return image mode
            const urlParams = new URLSearchParams(window.location.search);
            const returnImage = urlParams.get('return') === 'image' || urlParams.get('format') === 'png';
            
            if (returnImage) {
                await handleImageMode();
            } else {
                // Normal mode - just set color
                await setDominantColorFromImage();
            }
        });
    </script>
</body>
</html>
